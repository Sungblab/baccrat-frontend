<!DOCTYPE html>
<html lang="ko" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>블랙잭 관리자 패널</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --tw-bg-opacity: 1;
        --tw-text-opacity: 1;
      }
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #1f2937;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        border-left: 4px solid #10b981;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.3s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.error {
        border-left-color: #ef4444;
      }
      .toast.success {
        border-left-color: #10b981;
      }
      .toast.warning {
        border-left-color: #f59e0b;
      }

      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #6b7280;
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      tbody tr {
        transition: background-color 0.2s;
      }

      tbody tr:hover {
        background-color: rgba(55, 65, 81, 0.5);
      }

      thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .room-card {
        background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
        border: 2px solid #10b981;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
      }

      .room-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
      }

      .room-card.active {
        border-color: #ffd700;
        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
      }

      .player-seat {
        background: linear-gradient(to bottom, #374151, #1f2937);
        border: 2px solid #6b7280;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .player-seat.occupied {
        border-color: #10b981;
        background: linear-gradient(to bottom, #065f46, #064e3b);
      }

      .player-seat.playing {
        border-color: #fbbf24;
        background: linear-gradient(to bottom, #92400e, #78350f);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      .card {
        width: 40px;
        height: 56px;
        background: white;
        border-radius: 6px;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        margin: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .card.red {
        color: #dc2626;
      }

      .card.black {
        color: #000;
      }

      .card.back {
        background: linear-gradient(45deg, #1e40af, #3b82f6);
        color: white;
      }

      body {
        font-family: "Noto Serif KR", serif;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white">
    <div class="w-[100%] md:w-[90%] mx-auto p-2 md:p-6">
      <!-- 헤더 -->
      <header
        class="flex flex-col md:flex-row justify-between items-center mb-4 md:mb-6"
      >
        <h1
          class="text-3xl font-bold text-green-500"
          style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5)"
        >
          <i class="fas fa-spade mr-2"></i>블랙잭 게임 관리
        </h1>
        <div class="flex gap-2">
          <button
            id="backToAdmin"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto"
          >
            관리자 메인으로
          </button>
          <button
            id="logout"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded w-full md:w-auto"
          >
            로그아웃
          </button>
        </div>
      </header>

      <!-- 게임방 관리 섹션 -->
      <div class="mb-6 bg-gray-800 p-6 rounded-lg shadow max-w-full">
        <h2 class="text-xl font-semibold mb-4 text-green-400">
          <i class="fas fa-door-open mr-2"></i>게임방 관리
        </h2>

        <!-- 게임 관리 컨트롤 -->
        <div class="mb-4 flex flex-wrap gap-3">
          <button
            id="shuffleAllDecks"
            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium"
          >
            <i class="fas fa-random mr-2"></i>모든 덱 셔플
          </button>
        </div>

        <!-- 게임방 목록 -->
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-full"
          id="roomsList"
        >
          <!-- 게임방 카드들이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>

      <!-- 선택된 방 상세 정보 -->
      <div
        class="mb-6 bg-gray-800 p-6 rounded-lg shadow"
        id="roomDetailSection"
        style="display: none"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-green-400">
            <i class="fas fa-info-circle mr-2"></i>방 상세 정보
          </h2>
          <div class="flex gap-2">
            <button
              id="startGame"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium"
            >
              <i class="fas fa-play mr-2"></i>게임 시작
            </button>
            <button
              id="resetGame"
              class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-medium"
            >
              <i class="fas fa-redo mr-2"></i>게임 리셋
            </button>
            <button
              id="kickAllPlayers"
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium"
            >
              <i class="fas fa-user-times mr-2"></i>모든 플레이어 추방
            </button>
          </div>
        </div>

        <!-- 방 정보 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-gray-700 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-300 mb-2">방 정보</h3>
            <div class="space-y-1">
              <div>
                방 번호:
                <span id="roomId" class="text-green-400 font-bold">-</span>
              </div>
              <div>
                방 이름:
                <span id="roomName" class="text-green-400 font-bold">-</span>
              </div>
              <div>
                상태:
                <span id="roomStatus" class="text-yellow-400 font-bold"
                  >대기중</span
                >
              </div>
              <div>
                플레이어:
                <span id="playerCount" class="text-blue-400 font-bold"
                  >0/6</span
                >
              </div>
            </div>
          </div>

          <div class="bg-gray-700 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-300 mb-2">베팅 정보</h3>
            <div class="space-y-1">
              <div>
                최소 베팅:
                <span id="minBet" class="text-yellow-400 font-bold">-</span>
              </div>
              <div>
                최대 베팅:
                <span id="maxBet" class="text-yellow-400 font-bold">-</span>
              </div>
              <div>
                총 베팅액:
                <span id="totalBets" class="text-green-400 font-bold">0원</span>
              </div>
            </div>
          </div>

          <div class="bg-gray-700 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-300 mb-2">덱 정보</h3>
            <div class="space-y-1">
              <div>
                남은 카드:
                <span id="remainingCards" class="text-purple-400 font-bold"
                  >-</span
                >
              </div>
              <div>
                사용된 카드: <span id="usedCards" class="text-gray-400">-</span>
              </div>
              <div>
                덱 수:
                <span id="deckCount" class="text-blue-400 font-bold">6덱</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 딜러 정보 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-green-400 mb-3">
            <i class="fas fa-user-tie mr-2"></i>딜러
          </h3>
          <div class="bg-gray-700 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-3">
              <span class="font-medium">딜러 카드</span>
              <span class="text-sm text-gray-400"
                >점수:
                <span id="dealerScore" class="text-white font-bold"
                  >0</span
                ></span
              >
            </div>
            <div class="flex flex-wrap gap-1" id="dealerCards">
              <!-- 딜러 카드들이 여기에 표시됩니다 -->
            </div>
          </div>
        </div>

        <!-- 플레이어 좌석 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-green-400 mb-3">
            <i class="fas fa-users mr-2"></i>플레이어 좌석
          </h3>
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            id="playerSeats"
          >
            <!-- 플레이어 좌석들이 여기에 동적으로 생성됩니다 -->
          </div>
        </div>

        <!-- 게임 로그 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-green-400 mb-3">
            <i class="fas fa-list mr-2"></i>게임 로그
          </h3>
          <div
            class="bg-gray-700 p-4 rounded-lg max-h-60 overflow-y-auto custom-scrollbar"
          >
            <div id="gameLog" class="space-y-1 text-sm">
              <div class="text-gray-400">게임 로그가 여기에 표시됩니다...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 전체 통계 -->
      <div class="mb-6 bg-gray-800 p-6 rounded-lg shadow max-w-full">
        <h2 class="text-xl font-semibold mb-4 text-green-400">
          <i class="fas fa-chart-bar mr-2"></i>전체 통계
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-full">
          <div class="bg-gray-700 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-green-400" id="totalPlayers">
              0
            </div>
            <div class="text-sm text-gray-400">접속 플레이어</div>
          </div>
          <div class="bg-gray-700 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-yellow-400" id="totalGames">
              0
            </div>
            <div class="text-sm text-gray-400">총 게임 수</div>
          </div>
          <div class="bg-gray-700 p-4 rounded-lg text-center">
            <div
              class="text-2xl font-bold text-purple-400"
              id="totalBetsAmount"
            >
              0원
            </div>
            <div class="text-sm text-gray-400">총 베팅액</div>
          </div>
        </div>
      </div>

      <!-- 플레이어 리더보드 -->
      <div class="mb-6 bg-gray-800 p-6 rounded-lg shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-green-400">
            <i class="fas fa-trophy mr-2"></i>플레이어 리더보드
          </h2>
          <div class="flex gap-2">
            <select
              id="leaderboardSort"
              class="bg-gray-700 text-white px-3 py-2 rounded text-sm"
            >
              <option value="winRate">승률순</option>
              <option value="totalGames">게임 수순</option>
              <option value="totalProfit">수익순</option>
              <option value="totalBets">총 베팅액순</option>
              <option value="balance">잔액순</option>
              <option value="blackjacks">블랙잭 횟수순</option>
            </select>
            <button
              id="refreshLeaderboard"
              class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm"
            >
              <i class="fas fa-sync-alt mr-1"></i>새로고침
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-gray-900 rounded-lg">
            <thead class="bg-gray-700">
              <tr>
                <th class="py-3 px-4 text-left">순위</th>
                <th class="py-3 px-4 text-left">플레이어</th>
                <th class="py-3 px-4 text-center">게임 수</th>
                <th class="py-3 px-4 text-center">승/패</th>
                <th class="py-3 px-4 text-center">승률</th>
                <th class="py-3 px-4 text-right">총 베팅액</th>
                <th class="py-3 px-4 text-right">총 수익</th>
                <th class="py-3 px-4 text-right">잔액</th>
                <th class="py-3 px-4 text-center">블랙잭</th>
                <th class="py-3 px-4 text-center">최고 연승</th>
                <th class="py-3 px-4 text-center">상태</th>
              </tr>
            </thead>
            <tbody id="leaderboardTable" class="divide-y divide-gray-700">
              <!-- 플레이어 리더보드가 여기에 표시됩니다 -->
              <tr>
                <td colspan="11" class="py-8 text-center text-gray-400">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br />
                  리더보드를 불러오는 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 최근 게임 기록 -->
      <div class="mb-6 bg-gray-800 p-6 rounded-lg shadow max-w-full">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-green-400">
            <i class="fas fa-history mr-2"></i>최근 게임 기록
          </h2>
          <button
            id="refreshRecentGames"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm"
          >
            <i class="fas fa-sync-alt mr-1"></i>새로고침
          </button>
        </div>
        <div class="overflow-x-auto max-h-96 max-w-full custom-scrollbar">
          <table class="min-w-full bg-gray-900 rounded-lg">
            <thead class="bg-gray-700 sticky top-0 z-10">
              <tr>
                <th class="py-3 px-4 text-left">시간</th>
                <th class="py-3 px-4 text-left">세션</th>
                <th class="py-3 px-4 text-left">플레이어</th>
                <th class="py-3 px-4 text-center">결과</th>
                <th class="py-3 px-4 text-right">베팅액</th>
                <th class="py-3 px-4 text-right">지급액</th>
                <th class="py-3 px-4 text-right">하우스 수익</th>
              </tr>
            </thead>
            <tbody id="recentGamesTable" class="divide-y divide-gray-700">
              <!-- 최근 게임 기록이 여기에 표시됩니다 -->
              <tr>
                <td colspan="7" class="py-8 text-center text-gray-400">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br />
                  게임 기록을 불러오는 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 토스트 메시지 -->
    <div id="toast" class="toast">메시지가 여기에 표시됩니다.</div>

    <script>
      const token = localStorage.getItem("token");
      let socket = io("http://127.0.0.1:5000");
      let selectedRoomId = null;
      let rooms = {};
      let leaderboardData = [];
      let currentSortBy = "winRate";

      // 토큰 유효성 검사
      async function validateToken() {
        if (!token) {
          console.log("토큰이 없습니다. 로그인 페이지로 이동합니다.");
          window.location.href = "index.html";
          return false;
        }

        try {
          const res = await fetch("http://127.0.0.1:5000/api/auth/user-info", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401 || res.status === 403) {
            console.log("토큰이 만료되었거나 유효하지 않습니다.");
            localStorage.removeItem("token");
            window.location.href = "index.html";
            return false;
          }

          return true;
        } catch (err) {
          console.error("토큰 검증 중 오류:", err);
          return true;
        }
      }

      // 토스트 메시지 표시
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;

        toast.classList.remove("error", "success", "warning");
        if (type !== "info") {
          toast.classList.add(type);
        }

        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // 인증 오류 처리
      function handleAuthError() {
        console.log("인증 오류가 발생했습니다.");
        localStorage.removeItem("token");
        showToast("로그인이 만료되었습니다. 다시 로그인해주세요.", "error");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
      }

      // 게임방 목록 업데이트
      function updateRoomsList(roomsData) {
        rooms = Array.isArray(roomsData) ? roomsData : Object.values(roomsData);
        const roomsList = document.getElementById("roomsList");
        roomsList.innerHTML = "";

        rooms.forEach((room) => {
          const roomCard = document.createElement("div");
          roomCard.className = `room-card p-4 rounded-lg cursor-pointer ${
            selectedRoomId === room.id ? "active" : ""
          }`;
          roomCard.onclick = () => selectRoom(room.id);

          const statusColor =
            room.status === "playing"
              ? "text-yellow-400"
              : room.status === "waiting"
              ? "text-green-400"
              : "text-gray-400";
          const statusText =
            room.status === "playing"
              ? "게임중"
              : room.status === "waiting"
              ? "대기중"
              : "비활성";

          const gamePhaseText = room.gamePhase
            ? room.gamePhase === "betting"
              ? "베팅 중"
              : room.gamePhase === "dealing"
              ? "카드 배분 중"
              : room.gamePhase === "playing"
              ? "플레이어 턴"
              : room.gamePhase === "dealer"
              ? "딜러 턴"
              : room.gamePhase === "finished"
              ? "게임 종료"
              : "대기 중"
            : "대기 중";

          roomCard.innerHTML = `
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="text-lg font-bold text-white">${room.name}</h3>
                <p class="text-gray-400 text-sm">방 #${room.id}</p>
                <p class="text-xs text-gray-500">${gamePhaseText}</p>
              </div>
              <span class="px-2 py-1 rounded text-xs font-bold ${statusColor} bg-gray-700">
                ${statusText}
              </span>
            </div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">플레이어:</span>
                <span class="text-blue-400 font-bold">${
                  room.playerCount || 0
                }/${room.maxPlayers || 6}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">베팅 범위:</span>
                <span class="text-yellow-400">${(
                  room.minBet || 0
                ).toLocaleString()}~${(
            room.maxBet || 0
          ).toLocaleString()}원</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">총 베팅액:</span>
                <span class="text-green-400 font-bold">${(
                  room.totalBets || 0
                ).toLocaleString()}원</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">생성 시간:</span>
                <span class="text-gray-300 text-xs">${
                  room.createdAt
                    ? new Date(room.createdAt).toLocaleTimeString()
                    : "-"
                }</span>
              </div>
            </div>
          `;

          roomsList.appendChild(roomCard);
        });

        // 통계 업데이트
        updateOverallStats();
      }

      // 방 선택
      function selectRoom(roomId) {
        selectedRoomId = roomId;
        const room = rooms[roomId];

        if (!room) return;

        // 방 목록에서 선택 표시 업데이트
        document.querySelectorAll(".room-card").forEach((card) => {
          card.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        // 방 상세 정보 표시
        document.getElementById("roomDetailSection").style.display = "block";
        updateRoomDetail(room);

        // 서버에 방 상세 정보 요청
        socket.emit("admin_select_blackjack_room", { roomId });
      }

      // 방 상세 정보 업데이트
      function updateRoomDetail(room) {
        document.getElementById("roomId").textContent = room.id;
        document.getElementById("roomName").textContent = room.name;
        document.getElementById("roomStatus").textContent =
          room.status === "playing"
            ? "게임중"
            : room.status === "waiting"
            ? "대기중"
            : "비활성";
        document.getElementById(
          "playerCount"
        ).textContent = `${room.playerCount}/6`;
        document.getElementById(
          "minBet"
        ).textContent = `${room.minBet.toLocaleString()}원`;
        document.getElementById(
          "maxBet"
        ).textContent = `${room.maxBet.toLocaleString()}원`;
        document.getElementById("totalBets").textContent = `${(
          room.totalBets || 0
        ).toLocaleString()}원`;

        // 덱 정보 업데이트
        if (room.deckInfo) {
          document.getElementById("remainingCards").textContent =
            room.deckInfo.remaining;
          document.getElementById("usedCards").textContent = room.deckInfo.used;
        }

        // 플레이어 좌석 업데이트
        updatePlayerSeats(room.players || {});

        // 딜러 정보 업데이트
        updateDealerInfo(room.dealer || {});
      }

      // 플레이어 좌석 업데이트
      function updatePlayerSeats(players) {
        const seatsContainer = document.getElementById("playerSeats");
        seatsContainer.innerHTML = "";

        // players가 Map 형태인 경우 처리
        const playersArray =
          players instanceof Map
            ? Array.from(players.entries())
            : Array.isArray(players)
            ? players.map((p, i) => [i + 1, p])
            : Object.entries(players || {});

        for (let i = 1; i <= 6; i++) {
          const playerEntry = playersArray.find(([seatNum]) => seatNum == i);
          const player = playerEntry ? playerEntry[1] : null;

          const seat = document.createElement("div");
          seat.className = `player-seat p-4 ${
            player ? (player.status === "playing" ? "playing" : "occupied") : ""
          }`;

          if (player) {
            const statusText =
              player.status === "waiting"
                ? "대기 중"
                : player.status === "betting"
                ? "베팅 중"
                : player.status === "playing"
                ? "플레이 중"
                : player.status === "stand"
                ? "스탠드"
                : player.status === "bust"
                ? "버스트"
                : player.status === "blackjack"
                ? "블랙잭"
                : player.status === "finished"
                ? "완료"
                : player.status;

            seat.innerHTML = `
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h4 class="font-bold text-white">${player.username}</h4>
                  <p class="text-xs text-gray-400">좌석 ${i}</p>
                  <p class="text-xs ${
                    player.status === "playing"
                      ? "text-yellow-400"
                      : player.status === "bust"
                      ? "text-red-400"
                      : player.status === "blackjack"
                      ? "text-green-400"
                      : "text-gray-400"
                  }">${statusText}</p>
                </div>
                <button onclick="kickPlayer('${
                  player.userId
                }')" class="text-red-400 hover:text-red-300 text-xs">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">잔액:</span>
                  <span class="text-yellow-400">${(
                    player.balance || 0
                  ).toLocaleString()}원</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">베팅:</span>
                  <span class="text-green-400">${(
                    player.bet || 0
                  ).toLocaleString()}원</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">점수:</span>
                  <span class="text-white font-bold">${player.score || 0}</span>
                </div>
                ${
                  player.hasDoubled
                    ? '<div class="text-xs text-orange-400">더블</div>'
                    : ""
                }
                ${
                  player.insurance
                    ? `<div class="text-xs text-purple-400">보험: ₩${player.insurance.toLocaleString()}</div>`
                    : ""
                }
              </div>
              <div class="mt-2">
                <div class="text-xs text-gray-400 mb-1">카드:</div>
                <div class="flex flex-wrap gap-1" id="player${i}Cards">
                  ${(player.cards || [])
                    .map(
                      (card) => `
                    <div class="card ${
                      card.suit === "♥" || card.suit === "♦" ? "red" : "black"
                    }">
                      ${card.value}${card.suit}
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>
              <div class="mt-2 text-xs text-gray-500">
                입장: ${
                  player.joinedAt
                    ? new Date(player.joinedAt).toLocaleTimeString()
                    : "-"
                }
              </div>
            `;
          } else {
            seat.innerHTML = `
              <div class="text-center text-gray-500">
                <i class="fas fa-user-plus text-2xl mb-2"></i>
                <p class="text-sm">좌석 ${i}</p>
                <p class="text-xs">비어있음</p>
              </div>
            `;
          }

          seatsContainer.appendChild(seat);
        }
      }

      // 딜러 정보 업데이트
      function updateDealerInfo(dealer) {
        document.getElementById("dealerScore").textContent = dealer.score || 0;

        const dealerCards = document.getElementById("dealerCards");
        dealerCards.innerHTML = "";

        if (dealer.cards) {
          dealer.cards.forEach((card) => {
            const cardEl = document.createElement("div");
            cardEl.className = `card ${
              card.hidden
                ? "back"
                : card.suit === "♥" || card.suit === "♦"
                ? "red"
                : "black"
            }`;
            cardEl.textContent = card.hidden
              ? "?"
              : `${card.value}${card.suit}`;
            dealerCards.appendChild(cardEl);
          });
        }
      }

      // 전체 통계 업데이트
      function updateOverallStats() {
        const totalPlayers = Object.values(rooms).reduce(
          (sum, room) => sum + room.playerCount,
          0
        );

        document.getElementById("totalPlayers").textContent = totalPlayers;
      }

      // 게임 로그 추가
      function addGameLog(message) {
        const gameLog = document.getElementById("gameLog");
        const logEntry = document.createElement("div");
        logEntry.className = "text-gray-300";
        logEntry.innerHTML = `<span class="text-gray-500">[${new Date().toLocaleTimeString()}]</span> ${message}`;
        gameLog.appendChild(logEntry);
        gameLog.scrollTop = gameLog.scrollHeight;
      }

      // 플레이어 추방
      function kickPlayer(userId) {
        if (!selectedRoomId) return;

        if (confirm("이 플레이어를 추방하시겠습니까?")) {
          socket.emit("admin_kick_player", { roomId: selectedRoomId, userId });
        }
      }

      // 리더보드 업데이트
      function updateLeaderboard(data) {
        leaderboardData = data || [];
        sortAndDisplayLeaderboard();
      }

      // 최근 게임 기록 업데이트
      function updateRecentGames(games) {
        const recentGamesTable = document.getElementById("recentGamesTable");
        recentGamesTable.innerHTML = "";

        if (!games || games.length === 0) {
          recentGamesTable.innerHTML = `
            <tr>
              <td colspan="7" class="py-8 text-center text-gray-400">
                <i class="fas fa-clock text-2xl mb-2"></i><br>
                최근 게임 기록이 없습니다.
              </td>
            </tr>
          `;
          return;
        }

        games.forEach((game) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-700/50 transition-colors";

          // 결과에 따른 색상 설정
          const resultText = game.result || "알 수 없음";
          let resultColor = "text-gray-400";
          let resultIcon = "fas fa-question";

          if (resultText.includes("승리") || resultText.includes("win")) {
            resultColor = "text-green-400";
            resultIcon = "fas fa-trophy";
          } else if (
            resultText.includes("패배") ||
            resultText.includes("lose")
          ) {
            resultColor = "text-red-400";
            resultIcon = "fas fa-times";
          } else if (
            resultText.includes("블랙잭") ||
            resultText.includes("blackjack")
          ) {
            resultColor = "text-yellow-400";
            resultIcon = "fas fa-star";
          } else if (
            resultText.includes("무승부") ||
            resultText.includes("push")
          ) {
            resultColor = "text-blue-400";
            resultIcon = "fas fa-equals";
          }

          // 하우스 수익 색상
          const houseProfit = game.houseProfit || 0;
          const houseProfitColor =
            houseProfit >= 0 ? "text-green-400" : "text-red-400";
          const houseProfitIcon =
            houseProfit >= 0 ? "fas fa-arrow-up" : "fas fa-arrow-down";

          row.innerHTML = `
            <td class="py-3 px-4">
              <div class="text-white font-medium">${new Date(
                game.gameTime
              ).toLocaleString()}</div>
              <div class="text-xs text-gray-400">${new Date(
                game.gameTime
              ).toLocaleDateString()}</div>
            </td>
            <td class="py-3 px-4">
              <div class="text-blue-400 font-medium">${
                game.sessionName || game.sessionId || "세션"
              }</div>
              <div class="text-xs text-gray-400">ID: ${
                game.sessionId || "알 수 없음"
              }</div>
            </td>
            <td class="py-3 px-4">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-600 rounded-full flex items-center justify-center mr-3">
                  <span class="text-white text-sm font-bold">${(
                    game.playerName || "?"
                  )
                    .charAt(0)
                    .toUpperCase()}</span>
                </div>
                <div>
                  <div class="text-white font-medium">${
                    game.playerName || "알 수 없음"
                  }</div>
                  <div class="text-xs text-gray-400">1대1 게임</div>
                </div>
              </div>
            </td>
            <td class="py-3 px-4 text-center">
              <span class="${resultColor} font-medium">
                <i class="${resultIcon} mr-1"></i>${resultText}
              </span>
            </td>
            <td class="py-3 px-4 text-right">
              <span class="text-yellow-400 font-bold">₩${(
                game.totalBets || 0
              ).toLocaleString()}</span>
            </td>
            <td class="py-3 px-4 text-right">
              <span class="text-green-400 font-bold">₩${(
                game.totalPayouts || 0
              ).toLocaleString()}</span>
            </td>
            <td class="py-3 px-4 text-right">
              <span class="${houseProfitColor} font-bold">
                <i class="${houseProfitIcon} mr-1"></i>₩${Math.abs(
            houseProfit
          ).toLocaleString()}
              </span>
            </td>
          `;

          recentGamesTable.appendChild(row);
        });
      }

      // 리더보드 정렬 및 표시
      function sortAndDisplayLeaderboard() {
        // 데이터 정렬
        const sortedData = [...leaderboardData].sort((a, b) => {
          switch (currentSortBy) {
            case "winRate":
              return (b.winRate || 0) - (a.winRate || 0);
            case "totalGames":
              return (b.totalGames || 0) - (a.totalGames || 0);
            case "totalProfit":
              return (b.totalProfit || 0) - (a.totalProfit || 0);
            case "totalBets":
              return (b.totalBets || 0) - (a.totalBets || 0);
            case "balance":
              return (b.balance || 0) - (a.balance || 0);
            case "blackjacks":
              return (b.blackjacks || 0) - (a.blackjacks || 0);
            default:
              return 0;
          }
        });

        const leaderboardTable = document.getElementById("leaderboardTable");
        leaderboardTable.innerHTML = "";

        if (sortedData.length === 0) {
          leaderboardTable.innerHTML = `
            <tr>
              <td colspan="11" class="py-8 text-center text-gray-400">
                <i class="fas fa-users text-2xl mb-2"></i><br>
                등록된 플레이어가 없습니다.
              </td>
            </tr>
          `;
          return;
        }

        sortedData.forEach((player, index) => {
          const rank = index + 1;
          const winRate =
            player.totalGames > 0
              ? (((player.wins || 0) / player.totalGames) * 100).toFixed(1)
              : "0.0";
          const isOnline = player.isOnline;
          const currentRoom = player.currentRoom;

          // 순위별 메달 아이콘
          let rankDisplay = rank;
          if (rank === 1)
            rankDisplay = '<i class="fas fa-trophy text-yellow-400"></i> 1';
          else if (rank === 2)
            rankDisplay = '<i class="fas fa-medal text-gray-400"></i> 2';
          else if (rank === 3)
            rankDisplay = '<i class="fas fa-medal text-amber-600"></i> 3';

          // 수익 색상
          const profitColor =
            (player.totalProfit || 0) >= 0 ? "text-green-400" : "text-red-400";
          const profitIcon =
            (player.totalProfit || 0) >= 0 ? "fa-arrow-up" : "fa-arrow-down";

          // 상태 표시
          let statusDisplay = "";
          if (isOnline && currentRoom) {
            statusDisplay = `<span class="px-2 py-1 bg-green-800 text-green-300 rounded text-xs">게임중 (방${currentRoom})</span>`;
          } else if (isOnline) {
            statusDisplay = `<span class="px-2 py-1 bg-blue-800 text-blue-300 rounded text-xs">온라인</span>`;
          } else {
            statusDisplay = `<span class="px-2 py-1 bg-gray-800 text-gray-400 rounded text-xs">오프라인</span>`;
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="py-3 px-4 font-bold text-center">${rankDisplay}</td>
            <td class="py-3 px-4">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                  <span class="text-white text-sm font-bold">${player.username
                    .charAt(0)
                    .toUpperCase()}</span>
                </div>
                <div>
                  <div class="font-medium text-white">${player.username}</div>
                  <div class="text-xs text-gray-400">ID: ${player.userId}</div>
                </div>
              </div>
            </td>
            <td class="py-3 px-4 text-center font-medium">${
              player.totalGames || 0
            }</td>
            <td class="py-3 px-4 text-center">
              <span class="text-green-400">${
                player.wins || 0
              }</span>/<span class="text-red-400">${player.losses || 0}</span>
            </td>
            <td class="py-3 px-4 text-center font-bold ${
              parseFloat(winRate) >= 50 ? "text-green-400" : "text-red-400"
            }">${winRate}%</td>
            <td class="py-3 px-4 text-right">₩${(
              player.totalBets || 0
            ).toLocaleString()}</td>
            <td class="py-3 px-4 text-right font-bold ${profitColor}">
              <i class="fas ${profitIcon} mr-1"></i>₩${Math.abs(
            player.totalProfit || 0
          ).toLocaleString()}
            </td>
            <td class="py-3 px-4 text-right font-bold text-yellow-400">₩${(
              player.balance || 0
            ).toLocaleString()}</td>
            <td class="py-3 px-4 text-center">
              <span class="px-2 py-1 bg-purple-800 text-purple-300 rounded text-xs">${
                player.blackjacks || 0
              }</span>
            </td>
            <td class="py-3 px-4 text-center">
              <span class="px-2 py-1 bg-orange-800 text-orange-300 rounded text-xs">${
                player.maxWinStreak || 0
              }</span>
            </td>
            <td class="py-3 px-4 text-center">${statusDisplay}</td>
          `;
          leaderboardTable.appendChild(row);
        });
      }

      // 이벤트 리스너 설정
      document.addEventListener("DOMContentLoaded", () => {
        validateToken();

        // 뒤로가기 버튼
        document.getElementById("backToAdmin").addEventListener("click", () => {
          window.location.href = "admin.html";
        });

        // 로그아웃 버튼
        document.getElementById("logout").addEventListener("click", () => {
          if (confirm("정말 로그아웃 하시겠습니까?")) {
            localStorage.removeItem("token");
            showToast("로그아웃되었습니다.", "info");
            setTimeout(() => {
              window.location.href = "index.html";
            }, 1000);
          }
        });

        // 게임 시작 버튼
        document.getElementById("startGame").addEventListener("click", () => {
          if (!selectedRoomId) {
            showToast("게임을 시작할 방을 선택해주세요.", "warning");
            return;
          }

          socket.emit("admin_start_blackjack_game", { roomId: selectedRoomId });
        });

        // 게임 리셋 버튼
        document.getElementById("resetGame").addEventListener("click", () => {
          if (!selectedRoomId) {
            showToast("리셋할 방을 선택해주세요.", "warning");
            return;
          }

          if (confirm("게임을 리셋하시겠습니까?")) {
            socket.emit("admin_reset_blackjack_game", {
              roomId: selectedRoomId,
            });
          }
        });

        // 모든 플레이어 추방 버튼
        document
          .getElementById("kickAllPlayers")
          .addEventListener("click", () => {
            if (!selectedRoomId) {
              showToast("방을 선택해주세요.", "warning");
              return;
            }

            if (confirm("모든 플레이어를 추방하시겠습니까?")) {
              socket.emit("admin_kick_all_players", { roomId: selectedRoomId });
            }
          });

        // 모든 덱 셔플 버튼
        document
          .getElementById("shuffleAllDecks")
          .addEventListener("click", () => {
            if (confirm("모든 방의 덱을 셔플하시겠습니까?")) {
              socket.emit("admin_shuffle_all_blackjack_decks");
            }
          });

        // 리더보드 정렬 변경
        document
          .getElementById("leaderboardSort")
          .addEventListener("change", (e) => {
            currentSortBy = e.target.value;
            sortAndDisplayLeaderboard();
          });

        // 리더보드 새로고침
        document
          .getElementById("refreshLeaderboard")
          .addEventListener("click", () => {
            socket.emit("admin_get_leaderboard");
            showToast("리더보드를 새로고침합니다.", "info");
          });

        // 최근 게임 기록 새로고침
        document
          .getElementById("refreshRecentGames")
          .addEventListener("click", () => {
            socket.emit("admin_get_recent_games", { limit: 20 });
            showToast("최근 게임 기록을 새로고침합니다.", "info");
          });
      });

      // Socket 이벤트 리스너
      socket.on("connect", () => {
        socket.emit("authenticate", token);
        socket.emit("admin_join_blackjack");
        socket.emit("admin_get_leaderboard");
        socket.emit("admin_get_recent_games", { limit: 20 });
        showToast("서버에 연결되었습니다.", "success");
      });

      socket.on("disconnect", () => {
        showToast("서버와의 연결이 끊어졌습니다.", "error");
      });

      socket.on("blackjack_rooms_update", (roomsData) => {
        updateRoomsList(roomsData);
      });

      socket.on("blackjack_room_detail", (data) => {
        if (data.roomId === selectedRoomId) {
          updateRoomDetail(data.room);
        }
      });

      socket.on("blackjack_game_log", (data) => {
        if (data.roomId === selectedRoomId) {
          addGameLog(data.message);
        }
      });

      socket.on("admin_action_result", (data) => {
        if (data.success) {
          showToast(data.message, "success");
          if (data.room) {
            // 방 생성 성공 시 방 목록 새로고침
            socket.emit("admin_join_blackjack");
          }
        } else {
          showToast(data.message, "error");
        }
      });

      socket.on("blackjack_game_started", (data) => {
        if (data.roomId === selectedRoomId) {
          showToast("게임이 시작되었습니다.", "success");
          addGameLog("게임이 시작되었습니다.");
        }
      });

      socket.on("blackjack_game_reset", (data) => {
        if (data.roomId === selectedRoomId) {
          showToast("게임이 리셋되었습니다.", "success");
          addGameLog("게임이 리셋되었습니다.");
        }
      });

      socket.on("player_joined", (data) => {
        if (data.room && data.room.id === selectedRoomId) {
          addGameLog(`플레이어 ${data.player.username}이 입장했습니다.`);
          updateRoomDetail(data.room);
        }
      });

      socket.on("player_left", (data) => {
        if (data.roomId === selectedRoomId) {
          addGameLog(`플레이어가 퇴장했습니다.`);
        }
      });

      socket.on("bet_placed", (data) => {
        if (data.room && data.room.id === selectedRoomId) {
          addGameLog(
            `${
              data.player.username
            }이 ₩${data.player.bet.toLocaleString()} 베팅했습니다.`
          );
          updateRoomDetail(data.room);
        }
      });

      socket.on("player_hit", (data) => {
        if (data.room && data.room.id === selectedRoomId) {
          addGameLog(
            `${data.player.username}이 히트했습니다. (점수: ${data.player.value})`
          );
          updateRoomDetail(data.room);
        }
      });

      socket.on("player_stand", (data) => {
        if (data.room && data.room.id === selectedRoomId) {
          addGameLog(`${data.player.username}이 스탠드했습니다.`);
          updateRoomDetail(data.room);
        }
      });

      socket.on("game_finished", (data) => {
        if (data.roomId === selectedRoomId) {
          addGameLog("게임이 종료되었습니다.");
          data.results.forEach((result) => {
            addGameLog(
              `${result.username}: ${
                result.result
              } (베팅: ₩${result.bet.toLocaleString()}, 지급: ₩${result.payout.toLocaleString()})`
            );
          });
        }

        // 게임 완료 시 최근 게임 기록 새로고침
        socket.emit("admin_get_recent_games", { limit: 20 });
      });

      socket.on("blackjack_player_kicked", (data) => {
        if (data.roomId === selectedRoomId) {
          showToast(`플레이어 ${data.username}이 추방되었습니다.`, "success");
          addGameLog(`플레이어 ${data.username}이 추방되었습니다.`);
        }
      });

      socket.on("blackjack_all_players_kicked", (data) => {
        if (data.roomId === selectedRoomId) {
          showToast("모든 플레이어가 추방되었습니다.", "success");
          addGameLog("모든 플레이어가 추방되었습니다.");
        }
      });

      socket.on("blackjack_decks_shuffled", () => {
        showToast("모든 덱이 셔플되었습니다.", "success");
        addGameLog("모든 덱이 셔플되었습니다.");
      });

      socket.on("error", (message) => {
        showToast(message, "error");
      });

      // 리더보드 관련 소켓 이벤트
      socket.on("blackjack_leaderboard", (data) => {
        updateLeaderboard(data);
      });

      // 최근 게임 기록 관련 소켓 이벤트
      socket.on("blackjack_recent_games", (data) => {
        updateRecentGames(data);
      });

      socket.on("disconnect", () => {
        showToast("서버와의 연결이 끊어졌습니다.", "error");
      });
    </script>
  </body>
</html>
