<!DOCTYPE html>
<html lang="ko" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>골든 카지노</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Tailwind CSS의 다크 모드 사용 */
      :root {
        --tw-bg-opacity: 1;
        --tw-text-opacity: 1;
      }
      .toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
      }
      .toast.show {
        visibility: visible;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      .toast.toast-info {
        background-color: #3b82f6;
        border-left: 4px solid #1d4ed8;
      }
      .toast.toast-success {
        background-color: #10b981;
        border-left: 4px solid #047857;
      }
      .toast.toast-error {
        background-color: #ef4444;
        border-left: 4px solid #dc2626;
      }
      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
      .scrollable-table {
        max-height: 400px;
        overflow-y: auto;
      }

      @media (max-width: 640px) {
        .responsive-table {
          display: block;
          width: 100%;
          overflow-x: auto;
        }
      }

      /* 스크롤바 스타일 */
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 3px;
      }

      /* 테이블 행 호버 효 */
      tbody tr {
        transition: background-color 0.2s;
      }

      tbody tr:hover {
        background-color: rgba(55, 65, 81, 0.5);
      }

      /* Sticky 헤더 스타일 */
      thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      /* 최근 게임 결과 (Big Road) 스타일 추가 */
      #recentResults {
        display: flex;
        flex-direction: row; /* 가로로 열 배치 */
        overflow-x: auto; /* 가로 스크롤 */
        padding: 8px;
        min-height: 130px; /* 최소 높이 (6개 아이템 + 패딩 고려) */
        align-items: flex-start; /* 열 상단 정렬 */
        gap: 4px; /* 열 간 간격 */
        -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
        background-color: rgba(0, 0, 0, 0.2); /* 배경색 약간 추가 */
        border-radius: 6px;
      }

      .result-column {
        display: flex;
        flex-direction: column; /* 세로로 아이템 배치 */
        gap: 4px; /* 아이템 간 간격 */
      }

      .result-cell {
        width: 18px; /* 셀 너비 */
        height: 18px; /* 셀 높이 */
        border-radius: 50%; /* 원형 */
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        flex-shrink: 0; /* 줄어들지 않도록 */
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .result-cell.player {
        background-color: #3b82f6; /* 파란색 */
      }
      .result-cell.banker {
        background-color: #ef4444; /* 빨간색 */
      }
      .result-cell.tie {
        background-color: #10b981; /* 녹색 */
      }
      .result-cell.player-pair {
        border: 2px solid #60a5fa; /* 플레이어 페어 표시 (밝은 파랑 테두리) */
        box-shadow: 0 0 3px #60a5fa;
      }
      .result-cell.banker-pair {
        border: 2px solid #f87171; /* 뱅커 페어 표시 (밝은 빨강 테두리) */
        box-shadow: 0 0 3px #f87171;
      }

      body {
        font-family: "Noto Serif KR", serif;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white">
    <div class="w-[100%] md:w-[80%] mx-auto p-2 md:p-6">
      <!-- 헤더 및 로그아웃 버튼 -->
      <header
        class="flex flex-col md:flex-row justify-between items-center mb-4 md:mb-6"
      >
        <h1
          class="text-3xl font-bold text-yellow-500"
          style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5)"
        >
          GOLDEN CASINO
        </h1>
        <button
          id="logout"
          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded w-full md:w-auto"
        >
          로그아웃
        </button>
      </header>

      <!-- 게임 관리 버튼들 -->
      <div class="mb-4 md:mb-6 bg-gray-800 p-3 md:p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4 text-purple-400">게임 관리</h2>
        <div class="flex flex-col md:flex-row justify-center gap-4">
          <button
            id="goToBaccaratAdmin"
            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            바카라 관리
          </button>
          <button
            id="goToBlackjackAdmin"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            블랙잭 관리
          </button>
        </div>
      </div>

      <!-- 사용자 관리 섹션 수정 -->
      <div class="mb-4 md:mb-6 bg-gray-800 p-3 md:p-6 rounded-lg shadow">
        <h1 class="text-2xl font-semibold mb-4 text-purple-400">사용자 관리</h1>

        <div class="max-h-[400px] overflow-y-auto custom-scrollbar">
          <table class="min-w-full bg-gray-900 rounded-lg text-sm">
            <thead class="bg-gray-800 sticky top-0">
              <tr>
                <th class="py-3 px-4 text-left">사용자</th>
                <th class="py-3 px-4 text-left">상태</th>
                <th class="py-3 px-4 text-right">잔액</th>
                <th class="py-3 px-4 text-right">손익</th>
                <th class="py-3 px-4 text-left">게임 기록</th>
                <th class="py-3 px-4 text-center">관리</th>
              </tr>
            </thead>
            <tbody id="userTable">
              <!-- 사용자 목록이 여기에 추가됩니다 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 하우스 손익 통계 섹션 -->
      <div class="mb-4 md:mb-6 bg-gray-800 p-3 md:p-6 rounded-lg shadow">
        <h1 class="text-2xl font-semibold mb-4 text-purple-400">
          하우스 손익 통계
        </h1>

        <!-- 전체 하우스 손익 요약 -->
        <div
          class="mb-6 bg-gradient-to-r from-gray-900 to-gray-800 p-4 rounded-lg border border-purple-500"
        >
          <h3 class="text-lg font-semibold mb-3 text-yellow-400">
            전체 하우스 손익
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div
                class="text-2xl font-bold text-green-400"
                id="realHouseProfit"
              >
                0원
              </div>
              <div class="text-sm text-gray-400">실제 하우스 수익</div>
              <div class="text-xs text-gray-500">(충전 - 환전)</div>
            </div>
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div
                class="text-2xl font-bold text-blue-400"
                id="gameBasedHouseProfit"
              >
                0원
              </div>
              <div class="text-sm text-gray-400">게임 기준 수익</div>
              <div class="text-xs text-gray-500">(베팅 손익)</div>
            </div>
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div
                class="text-2xl font-bold text-yellow-400"
                id="totalHouseBets"
              >
                0원
              </div>
              <div class="text-sm text-gray-400">총 베팅액</div>
            </div>
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div
                class="text-2xl font-bold text-purple-400"
                id="totalHouseGames"
              >
                0게임
              </div>
              <div class="text-sm text-gray-400">총 게임 수</div>
            </div>
          </div>
        </div>

        <!-- 게임별 하우스 손익 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3 text-gray-300">게임별 통계</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 바카라 통계 -->
            <div
              class="bg-black bg-opacity-50 p-4 rounded-lg border border-purple-500"
            >
              <h4 class="text-md font-semibold mb-3 text-purple-400">바카라</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">게임 수:</span>
                  <span class="text-white font-bold" id="baccaratGames"
                    >0게임</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">총 베팅액:</span>
                  <span class="text-yellow-400 font-bold" id="baccaratTotalBets"
                    >0원</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">총 지급액:</span>
                  <span
                    class="text-orange-400 font-bold"
                    id="baccaratTotalPayouts"
                    >0원</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">하우스 수익:</span>
                  <span class="font-bold" id="baccaratHouseProfit">0원</span>
                </div>
              </div>
            </div>

            <!-- 블랙잭 통계 -->
            <div
              class="bg-black bg-opacity-50 p-4 rounded-lg border border-green-500"
            >
              <h4 class="text-md font-semibold mb-3 text-green-400">블랙잭</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">게임 수:</span>
                  <span class="text-white font-bold" id="blackjackGames"
                    >0게임</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">총 베팅액:</span>
                  <span
                    class="text-yellow-400 font-bold"
                    id="blackjackTotalBets"
                    >0원</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">총 지급액:</span>
                  <span
                    class="text-orange-400 font-bold"
                    id="blackjackTotalPayouts"
                    >0원</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">하우스 수익:</span>
                  <span class="font-bold" id="blackjackHouseProfit">0원</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 추가 재정 정보 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3 text-gray-300">재정 현황</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-blue-400" id="totalDeposits">
                0원
              </div>
              <div class="text-sm text-gray-400">총 충전액</div>
            </div>
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div
                class="text-2xl font-bold text-orange-400"
                id="totalExchanges"
              >
                0원
              </div>
              <div class="text-sm text-gray-400">총 환전액</div>
            </div>
            <div class="bg-black bg-opacity-50 p-4 rounded-lg text-center">
              <div
                class="text-2xl font-bold text-red-400"
                id="totalPlayerProfit"
              >
                0원
              </div>
              <div class="text-sm text-gray-400">플레이어 총 수익</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 충전 및 환전 관리 섹션 -->
      <div class="mb-4 md:mb-6 bg-gray-800 p-3 md:p-6 rounded-lg shadow">
        <h1 class="text-2xl font-semibold mb-4 text-purple-400">충전 & 환전</h1>

        <!-- 재정 요약 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3 text-gray-300">재정 요약</h3>
          <div
            class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700"
          >
            <div class="max-h-[400px] overflow-y-auto custom-scrollbar">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-700 sticky top-0">
                  <tr>
                    <th class="py-3 px-4 text-left">사용자</th>
                    <th class="py-3 px-4 text-right">현재 잔액</th>
                    <th class="py-3 px-4 text-right">총 충전액</th>
                    <th class="py-3 px-4 text-right">총 환전액</th>
                    <th class="py-3 px-4 text-right">손익</th>
                    <th class="py-3 px-4 text-center">관리</th>
                  </tr>
                </thead>
                <tbody
                  id="financialSummaryTable"
                  class="divide-y divide-gray-700"
                >
                  <!-- 재정 요약 데이터가 여기에 표시됩니다 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 충전 요청 -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3 text-gray-300">충전 요청</h3>
          <div
            class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700"
          >
            <div class="max-h-[400px] overflow-y-auto custom-scrollbar">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-700 sticky top-0">
                  <tr>
                    <th class="py-3 px-4 text-left">신청시간</th>
                    <th class="py-3 px-4 text-left">사용자</th>
                    <th class="py-3 px-4 text-right">신청금액</th>
                    <th class="py-3 px-4 text-center">상태</th>
                    <th class="py-3 px-4 text-center">관리</th>
                  </tr>
                </thead>
                <tbody
                  id="depositRequestsTable"
                  class="divide-y divide-gray-700"
                >
                  <!-- 충전 요청 목록이 여기에 추가됩니다 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 환전 요청 -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-300">환전 요청</h3>
          <div
            class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700"
          >
            <div class="max-h-[400px] overflow-y-auto custom-scrollbar">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-700 sticky top-0">
                  <tr>
                    <th class="py-3 px-4 text-left">신청시간</th>
                    <th class="py-3 px-4 text-left">사용자</th>
                    <th class="py-3 px-4 text-right">신청금액</th>
                    <th class="py-3 px-4 text-right">실수령액</th>
                    <th class="py-3 px-4 text-center">상태</th>
                    <th class="py-3 px-4 text-center">관리</th>
                  </tr>
                </thead>
                <tbody
                  id="exchangeRequestsTable"
                  class="divide-y divide-gray-700"
                >
                  <!-- 환전 요청 목록이 여기에 추가됩니다 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 사용자 상세정보 모달 -->
      <div
        id="userDetailModal"
        class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden backdrop-blur-sm"
      >
        <div
          class="fixed inset-x-0 bottom-0 bg-gradient-to-b from-[#2a2a2a] to-[#1a1a1a] rounded-t-2xl max-h-[85vh] border-t border-[#b8860b] flex flex-col"
        >
          <!-- 고정 헤더 -->
          <div
            class="flex-shrink-0 bg-gradient-to-b from-[#2a2a2a] to-[#1a1a1a] p-4 border-b border-[#b8860b] rounded-t-2xl"
          >
            <div class="flex justify-between items-center mb-4">
              <h2
                class="text-xl font-bold text-yellow-500"
                style="text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5)"
              >
                <span id="detailUsername">사용자</span> 상세정보
              </h2>
              <button
                id="closeUserDetail"
                class="text-yellow-500 hover:text-yellow-400"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <!-- 탭 메뉴 -->
            <div class="flex space-x-1 bg-black bg-opacity-50 rounded-lg p-1">
              <button
                id="detailOverviewTab"
                class="flex-1 py-2 px-3 rounded-md text-xs font-medium transition-colors bg-purple-600 text-white"
              >
                개요
              </button>
              <button
                id="detailBaccaratTab"
                class="flex-1 py-2 px-3 rounded-md text-xs font-medium transition-colors text-gray-400 hover:text-yellow-500"
              >
                바카라
              </button>
              <button
                id="detailBlackjackTab"
                class="flex-1 py-2 px-3 rounded-md text-xs font-medium transition-colors text-gray-400 hover:text-yellow-500"
              >
                블랙잭
              </button>
              <button
                id="detailFinancialTab"
                class="flex-1 py-2 px-3 rounded-md text-xs font-medium transition-colors text-gray-400 hover:text-yellow-500"
              >
                재정
              </button>
            </div>
          </div>

          <!-- 스크롤 가능한 컨텐츠 영역 -->
          <div class="flex-1 overflow-y-auto custom-scrollbar">
            <!-- 개요 탭 -->
            <div id="detailOverviewContent" class="p-4 space-y-4">
              <!-- 게임 통계 요약 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  게임 통계
                </h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-2xl font-bold text-green-400"
                      id="detailUserWins"
                    >
                      0
                    </div>
                    <div class="text-xs text-gray-400">승리</div>
                  </div>
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-2xl font-bold text-red-400"
                      id="detailUserLoses"
                    >
                      0
                    </div>
                    <div class="text-xs text-gray-400">패배</div>
                  </div>
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-lg font-bold text-yellow-500"
                      id="detailUserWinRate"
                    >
                      0%
                    </div>
                    <div class="text-xs text-gray-400">승률</div>
                  </div>
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-lg font-bold text-blue-400"
                      id="detailTotalGames"
                    >
                      0
                    </div>
                    <div class="text-xs text-gray-400">총 게임</div>
                  </div>
                </div>

                <!-- 베팅 손익 요약 -->
                <div class="bg-black bg-opacity-30 p-3 rounded-lg">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400 font-medium">베팅 순손익:</span>
                    <span
                      class="font-bold text-lg"
                      id="detailGameStatsBettingProfit"
                      >0원</span
                    >
                  </div>
                  <div class="text-xs text-gray-500 text-center mt-1">
                    * 베팅으로 인한 순수익/손실
                  </div>
                </div>
              </div>

              <!-- 전체 손익 요약 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  전체 손익
                </h3>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">현재 잔액:</span>
                    <span
                      class="text-yellow-500 font-bold text-lg"
                      id="detailCurrentBalance"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">총 손익:</span>
                    <span class="font-bold text-lg" id="detailOverallProfit"
                      >0원</span
                    >
                  </div>
                  <div class="text-xs text-gray-500 text-center">
                    * 총 손익 = 현재 잔액 + 총 환전액 - 총 충전액
                  </div>
                </div>
              </div>

              <!-- 롤링 정보 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  롤링 현황
                </h3>
                <div class="space-y-3">
                  <div class="flex justify-between">
                    <span class="text-gray-400">롤링 달성률:</span>
                    <span
                      class="text-yellow-500 font-bold"
                      id="detailRollingProgressTextInfo"
                      >0%</span
                    >
                  </div>
                  <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div
                      id="detailRollingProgressBarInfo"
                      class="bg-yellow-500 h-2.5 rounded-full"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-400"
                      >베팅액:
                      <span id="detailRollingWageredAmount">0원</span></span
                    >
                    <span class="text-gray-400"
                      >목표:
                      <span id="detailRollingRequiredAmount">0원</span></span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- 바카라 분석 탭 -->
            <div id="detailBaccaratContent" class="p-4 space-y-4 hidden">
              <!-- 바카라 베팅 통계 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  바카라 베팅 통계
                </h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">총 게임 수:</span>
                    <span
                      class="text-blue-400 font-bold"
                      id="detailBaccaratTotalGames"
                      >0게임</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">승/패:</span>
                    <span class="font-bold">
                      <span class="text-green-400" id="detailBaccaratWins"
                        >0</span
                      >승
                      <span class="text-red-400" id="detailBaccaratLosses"
                        >0</span
                      >패
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">승률:</span>
                    <span
                      class="text-yellow-500 font-bold"
                      id="detailBaccaratWinRate"
                      >0%</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">총 베팅 금액:</span>
                    <span
                      class="text-yellow-500 font-bold"
                      id="detailBaccaratTotalBetAmount"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">총 수익 금액:</span>
                    <span
                      class="text-green-400 font-bold"
                      id="detailBaccaratTotalWinAmount"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">베팅 손익:</span>
                    <span class="font-bold" id="detailBaccaratBettingProfit"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">평균 베팅액:</span>
                    <span
                      class="text-blue-400 font-bold"
                      id="detailBaccaratAverageBetAmount"
                      >0원</span
                    >
                  </div>
                </div>
              </div>

              <!-- 바카라 베팅 선호도 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  바카라 베팅 선호도
                </h3>
                <div class="space-y-2" id="detailBaccaratChoicePreferences">
                  <!-- 선호도 차트가 여기에 표시됩니다 -->
                </div>
                <div
                  class="mt-3 p-2 bg-black bg-opacity-30 rounded text-center"
                >
                  <span class="text-gray-400 text-sm"
                    >가장 선호하는 베팅:
                  </span>
                  <span
                    class="text-yellow-500 font-bold"
                    id="detailBaccaratFavoriteChoice"
                    >-</span
                  >
                </div>
              </div>
            </div>

            <!-- 블랙잭 분석 탭 -->
            <div id="detailBlackjackContent" class="p-4 space-y-4 hidden">
              <!-- 블랙잭 베팅 통계 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  블랙잭 베팅 통계
                </h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">총 게임 수:</span>
                    <span
                      class="text-blue-400 font-bold"
                      id="detailBlackjackTotalGames"
                      >0게임</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">승/패:</span>
                    <span class="font-bold">
                      <span class="text-green-400" id="detailBlackjackWins"
                        >0</span
                      >승
                      <span class="text-red-400" id="detailBlackjackLosses"
                        >0</span
                      >패
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">승률:</span>
                    <span
                      class="text-yellow-500 font-bold"
                      id="detailBlackjackWinRate"
                      >0%</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">총 베팅 금액:</span>
                    <span
                      class="text-yellow-500 font-bold"
                      id="detailBlackjackTotalBetAmount"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">총 수익 금액:</span>
                    <span
                      class="text-green-400 font-bold"
                      id="detailBlackjackTotalWinAmount"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">베팅 손익:</span>
                    <span class="font-bold" id="detailBlackjackBettingProfit"
                      >0원</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">평균 베팅액:</span>
                    <span
                      class="text-blue-400 font-bold"
                      id="detailBlackjackAverageBetAmount"
                      >0원</span
                    >
                  </div>
                </div>
              </div>

              <!-- 블랙잭 특수 통계 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  블랙잭 특수 통계
                </h3>
                <div class="grid grid-cols-2 gap-3">
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-2xl font-bold text-yellow-400"
                      id="detailBlackjackBlackjacks"
                    >
                      0
                    </div>
                    <div class="text-xs text-gray-400">블랙잭</div>
                  </div>
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-2xl font-bold text-red-400"
                      id="detailBlackjackBusts"
                    >
                      0
                    </div>
                    <div class="text-xs text-gray-400">버스트</div>
                  </div>
                </div>
              </div>

              <!-- 최근 블랙잭 게임 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  최근 블랙잭 게임
                </h3>
                <div
                  class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"
                  id="detailBlackjackRecentGames"
                >
                  <!-- 최근 블랙잭 게임이 여기에 표시됩니다 -->
                </div>
              </div>
            </div>

            <!-- 재정 현황 탭 -->
            <div id="detailFinancialContent" class="p-4 space-y-4 hidden">
              <!-- 충전/환전 통계 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  충전/환전 통계
                </h3>
                <div class="grid grid-cols-2 gap-4">
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-lg font-bold text-blue-400"
                      id="detailTotalDeposited"
                    >
                      0원
                    </div>
                    <div class="text-xs text-gray-400">총 충전액</div>
                    <div class="text-xs text-gray-500 mt-1">
                      (<span id="detailDepositCount">0</span>회)
                    </div>
                  </div>
                  <div
                    class="bg-black bg-opacity-30 p-3 rounded-lg text-center"
                  >
                    <div
                      class="text-lg font-bold text-orange-400"
                      id="detailTotalExchanged"
                    >
                      0원
                    </div>
                    <div class="text-xs text-gray-400">총 환전액</div>
                    <div class="text-xs text-gray-500 mt-1">
                      (<span id="detailExchangeCount">0</span>회)
                    </div>
                  </div>
                </div>
              </div>

              <!-- 최근 거래 내역 -->
              <div
                class="bg-black bg-opacity-50 p-4 rounded-lg border border-[#b8860b]"
              >
                <h3 class="text-lg font-bold text-yellow-500 mb-3">
                  최근 거래 내역
                </h3>
                <div
                  class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"
                  id="detailRecentTransactions"
                >
                  <!-- 최근 거래 내역이 여기에 표시됩니다 -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 토스트 메시지 -->
      <div id="toast" class="toast">메시지가 여기에 표시됩니다.</div>

      <!-- 오디오 요소들 -->
      <audio id="bettingStartSound" src="sound.mp3" preload="auto"></audio>
      <audio id="bettingEndSound" src="endsound.mp3" preload="auto"></audio>
    </div>

    <script>
      const token = localStorage.getItem("token");

      // 토큰 유효성 검사 함수
      async function validateToken() {
        if (!token) {
          console.log("토큰이 없습니다. 로그인 페이지로 이동합니다.");
          window.location.href = "index.html";
          return false;
        }

        try {
          // 간단한 API 호출로 토큰 유효성 검사
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/auth/user-info",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (res.status === 401 || res.status === 403) {
            console.log(
              "토큰이 만료되었거나 유효하지 않습니다. 로그인 페이지로 이동합니다."
            );
            localStorage.removeItem("token");
            window.location.href = "index.html";
            return false;
          }

          return true;
        } catch (err) {
          console.error("토큰 검증 중 오류:", err);
          // 네트워크 오류는 토큰 문제가 아닐 수 있으므로 계속 진행
          return true;
        }
      }

      // 페이지 로드 시 토큰 검증
      validateToken();

      // 인증 오류 처리 함수
      function handleAuthError() {
        console.log("인증 오류가 발생했습니다. 다시 로그인해주세요.");
        localStorage.removeItem("token");
        showToast("로그인이 만료되었습니다. 다시 로그인해주세요.", "error");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
      }

      let socket = io(
        "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app"
      );
      let bettingActive = false; // 베팅 상태 추적

      // 토스트 메시지 표시 함수
      function showToast(message, type = "default") {
        const toast = document.getElementById("toast");
        toast.textContent = message;

        // 기존 타입 클래스 제거
        toast.classList.remove("toast-info", "toast-success", "toast-error");

        // 타입별 스타일 적용
        if (type === "info") {
          toast.classList.add("toast-info");
        } else if (type === "success") {
          toast.classList.add("toast-success");
        } else if (type === "error") {
          toast.classList.add("toast-error");
        }

        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // 관리자 권한 확인을 위한 요청
      async function fetchUsers() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users-stats",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (res.status === 403 || res.status === 401) {
            handleAuthError();
            return;
          }

          const stats = await res.json();
          const userTable = document.getElementById("userTable");
          userTable.innerHTML = "";

          stats.forEach((user, index) => {
            const tr = document.createElement("tr");
            tr.classList.add("text-center");
            tr.innerHTML = `
                <td class="py-2">${user.username}</td>
                <td class="py-2">${user.balance} 원</td>
                <td class="py-2">${user.role}</td>
                <td class="py-2">${user.isApproved ? "승인됨" : "대기 중"}</td>
                <td class="py-2">${user.wins}</td>
                <td class="py-2">${user.losses}</td>
                <td class="py-2">${user.totalBets}</td>
                <td class="py-2">${user.winRate}</td>
                <td class="py-2">${user.profit} 원</td>
                <td class="py-2">
                    ${
                      !user.isApproved
                        ? `<button data-id="${user.id}" class="approve-user bg-purple-500 text-white px-2 py-1 rounded mr-2">승인</button>`
                        : ""
                    }
                    <button data-id="${
                      user.id
                    }" class="reset-password bg-yellow-500 text-white px-2 py-1 rounded mr-2">비번 초기화</button>
                    <button data-id="${
                      user.id
                    }" class="delete-user bg-red-500 text-white px-2 py-1 rounded mr-2">삭제</button>
                    ${
                      user.role !== "superadmin"
                        ? `
                    <button
                      onclick="toggleAdmin('${user._id}', '${user.role}')"
                      class="${
                        user.role === "admin"
                          ? "bg-gray-600 hover:bg-gray-700"
                          : "bg-purple-600 hover:bg-purple-700"
                      } text-white px-2.5 py-1.5 rounded text-sm font-medium transition-colors"
                    >
                      ${user.role === "admin" ? "관리자 해제" : "관리자 지정"}
                    </button>
                  `
                        : ""
                    }
                    <button data-id="${
                      user.id
                    }" class="adjust-coins bg-yellow-600 hover:bg-yellow-700 text-white px-2.5 py-1.5 rounded text-sm font-medium transition-colors"
                    >
                      잔액 조절
                    </button>

            `;
            userTable.appendChild(tr);
          });

          // 이벤트 리스너 추가
          document.querySelectorAll(".approve-user").forEach((button) => {
            button.addEventListener("click", function () {
              const userId = this.getAttribute("data-id");
              approveUser(userId);
            });
          });
          document.querySelectorAll(".delete-user").forEach((button) => {
            button.addEventListener("click", function () {
              const userId = this.getAttribute("data-id");
              deleteUser(userId);
            });
          });
          document.querySelectorAll(".reset-password").forEach((button) => {
            button.addEventListener("click", function () {
              const userId = this.getAttribute("data-id");
              resetPassword(userId);
            });
          });
          document.querySelectorAll(".toggle-admin").forEach((button) => {
            button.addEventListener("click", function () {
              const userId = this.getAttribute("data-id");
              const currentRole = this.getAttribute("data-role");
              toggleAdmin(userId, currentRole);
            });
          });
          document.querySelectorAll(".adjust-coins").forEach((button) => {
            button.addEventListener("click", function () {
              const userId = this.getAttribute("data-id");
              adjustCoins(userId);
            });
          });
          document.querySelectorAll(".view-betting").forEach((button) => {
            button.addEventListener("click", viewBettingDetails);
          });
        } catch (err) {}
      }

      async function approveUser(userId) {
        if (!confirm("이 사용자를 승인하시겠습니까?")) return;

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users/${userId}/approve`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const data = await res.json();

          if (res.ok) {
            showToast(data.message);
            fetchUsers(); // 목록 새로고침
          } else {
            showToast(data.message || "사용자 승인에 실패했습니다.");
          }
        } catch (err) {
          showToast("서버 에러가 발생했습니다.");
        }
      }

      async function deleteUser(userId) {
        if (!confirm("정말로 이 사용자를 삭제하시겠습니까?")) return;

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users/${userId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const data = await res.json();

          if (res.ok) {
            showToast(data.message);
            fetchUsers(); // 목록 새로고침
          } else {
            showToast(data.message || "사용자 삭제에 실패했습니다.");
          }
        } catch (err) {
          showToast("서버 에러가 발생했습니다.");
        }
      }

      async function resetPassword(e) {
        const userId = e.target.getAttribute("data-id");
        const newPassword = prompt("새 밀번호를 입력하세요:");
        if (newPassword) {
          try {
            const res = await fetch(
              `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users/${userId}/reset-password`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ newPassword }),
              }
            );
            const data = await res.json();
            showToast(data.message);
          } catch (err) {}
        }
      }

      async function toggleAdmin(userId, currentRole) {
        const isAdmin = currentRole === "admin";
        const action = isAdmin ? "해제" : "지정";

        if (!confirm(`이 사용자를 관리자서 ${action}하시겠습니까?`)) return;

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users/${userId}/toggle-admin`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ setAdmin: !isAdmin }),
            }
          );

          if (res.ok) {
            showToast(`관리자가 ${action}되었니다.`);
            fetchUsers();
          } else {
            showToast(`관리자 ${action}에 실패했습니다.`);
          }
        } catch (err) {
          showToast("서버 에러가 발생했습니다.");
        }
      }

      // 사용자 테이블에서 특정 사용자의 잔액 실시간 업데이트
      function updateUserBalanceInTable(userId, newBalance) {
        const userTable = document.getElementById("userTable");
        if (!userTable) return;

        const rows = userTable.querySelectorAll("tr");
        rows.forEach((row) => {
          const adjustButton = row.querySelector(
            `.adjust-coins[data-id="${userId}"]`
          );
          if (adjustButton) {
            // 해당 사용자의 행을 찾았으면 잔액 업데이트
            const balanceCell = row.querySelector("td:nth-child(3)"); // 잔액 열 (인덱스 수정)
            if (balanceCell) {
              balanceCell.innerHTML = `<span class="text-yellow-400 font-bold">${newBalance.toLocaleString()} 원</span>`;

              // 업데이트 효과 추가
              balanceCell.style.background = "rgba(34, 197, 94, 0.2)";
              setTimeout(() => {
                balanceCell.style.background = "";
              }, 1500);
            }
          }
        });
      }

      // 게임 관련 함수들은 baccarat-admin.html에서 처리

      // 백그라운드 상태 표시 관련 함수들은 baccarat-admin.html에서 처리

      // 바카라 관련 버튼들은 baccarat-admin.html에서 처리하므로 여기서는 제거

      // 바카라 관련 소켓 이벤트들은 baccarat-admin.html에서 처리

      // 사용자 잔액 변경 시 실시간 업데이트
      socket.on("user_balance_updated", (data) => {
        if (data.userId && data.newBalance !== undefined) {
          updateUserBalanceInTable(data.userId, data.newBalance);
        }
      });

      // 리더보드 실시간 업데이트
      socket.on("leaderboard_updated", (leaderboard) => {
        updateLeaderboardTable(leaderboard);
      });

      // 바카라 관련 게임 결과 처리는 baccarat-admin.html에서 처리

      // 새로운 충전 요청 알림
      socket.on("new_deposit_request", (data) => {
        showToast(
          `💰 새로운 충전 요청: ${
            data.username
          } - ${data.amount.toLocaleString()}원`,
          "info"
        );
        fetchDepositRequests(); // 충전 요청 목록 새로고침
        fetchFinancialSummary(); // 재정 요약 새로고침
        fetchHouseStats(); // 하우스 통계 새로고침
      });

      // 새로운 환전 요청 알림
      socket.on("new_exchange_request", (data) => {
        showToast(
          `💸 새로운 환전 요청: ${
            data.username
          } - ${data.requestAmount.toLocaleString()}원 (실수령: ${data.actualAmount.toLocaleString()}원)`,
          "info"
        );
        fetchExchangeRequests(); // 환전 요청 목록 새로고침
        fetchFinancialSummary(); // 재정 요약 새로고침
        fetchHouseStats(); // 하우스 통계 새로고침
      });

      // 타이머 함수는 baccarat-admin.html에서 처리

      // 하우스 손익 통계 가져오기 함수
      async function fetchHouseStats() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/house-stats",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!res.ok) {
            throw new Error("하우스 통계를 불러오는데 실패했습니다.");
          }

          const stats = await res.json();
          updateHouseStatsDisplay(stats);
        } catch (err) {
          console.error("하우스 통계 로드 오류:", err);
          showToast("하우스 통계를 불러오는데 실패했습니다.", "error");
        }
      }

      // 하우스 손익 표시 업데이트 함수
      function updateHouseStatsDisplay(stats) {
        // 전체 하우스 손익 요약
        const realHouseProfit = stats.total.realHouseProfit;
        const realProfitElement = document.getElementById("realHouseProfit");
        if (realProfitElement) {
          realProfitElement.textContent = `${
            realHouseProfit >= 0 ? "+" : ""
          }${realHouseProfit.toLocaleString()}원`;
          realProfitElement.className = `text-2xl font-bold ${
            realHouseProfit >= 0 ? "text-green-400" : "text-red-400"
          }`;
        }

        const gameBasedProfit = stats.total.gameBasedHouseProfit;
        const gameProfitElement = document.getElementById(
          "gameBasedHouseProfit"
        );
        if (gameProfitElement) {
          gameProfitElement.textContent = `${
            gameBasedProfit >= 0 ? "+" : ""
          }${gameBasedProfit.toLocaleString()}원`;
          gameProfitElement.className = `text-2xl font-bold ${
            gameBasedProfit >= 0 ? "text-blue-400" : "text-red-400"
          }`;
        }

        // 총 베팅액 및 게임 수
        const totalBetsElement = document.getElementById("totalHouseBets");
        if (totalBetsElement) {
          totalBetsElement.textContent = `${stats.total.totalBets.toLocaleString()}원`;
        }

        const totalGamesElement = document.getElementById("totalHouseGames");
        if (totalGamesElement) {
          totalGamesElement.textContent = `${stats.total.totalGames.toLocaleString()}게임`;
        }

        // 바카라 통계
        const baccaratGamesElement = document.getElementById("baccaratGames");
        if (baccaratGamesElement) {
          baccaratGamesElement.textContent = `${stats.baccarat.totalGames.toLocaleString()}게임`;
        }

        const baccaratBetsElement =
          document.getElementById("baccaratTotalBets");
        if (baccaratBetsElement) {
          baccaratBetsElement.textContent = `${stats.baccarat.totalBets.toLocaleString()}원`;
        }

        const baccaratPayoutsElement = document.getElementById(
          "baccaratTotalPayouts"
        );
        if (baccaratPayoutsElement) {
          baccaratPayoutsElement.textContent = `${stats.baccarat.totalPayouts.toLocaleString()}원`;
        }

        const baccaratProfitElement = document.getElementById(
          "baccaratHouseProfit"
        );
        if (baccaratProfitElement) {
          const profit = stats.baccarat.houseProfit;
          baccaratProfitElement.textContent = `${
            profit >= 0 ? "+" : ""
          }${profit.toLocaleString()}원`;
          baccaratProfitElement.className = `font-bold ${
            profit >= 0 ? "text-green-400" : "text-red-400"
          }`;
        }

        // 블랙잭 통계
        const blackjackGamesElement = document.getElementById("blackjackGames");
        if (blackjackGamesElement) {
          blackjackGamesElement.textContent = `${stats.blackjack.totalGames.toLocaleString()}게임`;
        }

        const blackjackBetsElement =
          document.getElementById("blackjackTotalBets");
        if (blackjackBetsElement) {
          blackjackBetsElement.textContent = `${stats.blackjack.totalBets.toLocaleString()}원`;
        }

        const blackjackPayoutsElement = document.getElementById(
          "blackjackTotalPayouts"
        );
        if (blackjackPayoutsElement) {
          blackjackPayoutsElement.textContent = `${stats.blackjack.totalPayouts.toLocaleString()}원`;
        }

        const blackjackProfitElement = document.getElementById(
          "blackjackHouseProfit"
        );
        if (blackjackProfitElement) {
          const profit = stats.blackjack.houseProfit;
          blackjackProfitElement.textContent = `${
            profit >= 0 ? "+" : ""
          }${profit.toLocaleString()}원`;
          blackjackProfitElement.className = `font-bold ${
            profit >= 0 ? "text-green-400" : "text-red-400"
          }`;
        }

        // 재정 현황
        const totalDepositsElement = document.getElementById("totalDeposits");
        if (totalDepositsElement) {
          totalDepositsElement.textContent = `${stats.total.totalDeposits.toLocaleString()}원`;
        }

        const totalExchangesElement = document.getElementById("totalExchanges");
        if (totalExchangesElement) {
          totalExchangesElement.textContent = `${stats.total.totalExchanges.toLocaleString()}원`;
        }

        const totalPlayerProfitElement =
          document.getElementById("totalPlayerProfit");
        if (totalPlayerProfitElement) {
          const playerProfit = stats.total.totalPlayerProfit;
          totalPlayerProfitElement.textContent = `${
            playerProfit >= 0 ? "+" : ""
          }${playerProfit.toLocaleString()}원`;
          totalPlayerProfitElement.className = `text-2xl font-bold ${
            playerProfit >= 0 ? "text-green-400" : "text-red-400"
          }`;
        }
      }

      // 페이지 로드 시 초기화 (바카라 관련 기능 제거됨)
      document.addEventListener("DOMContentLoaded", () => {
        fetchUsers(); // 사용자 목록 로드
        fetchExchangeRequests(); // 환전 요청 목록 로드
        fetchFinancialSummary(); // 재정 요약 로드
        fetchDepositRequests(); // 충전 요청 목록 로드
        fetchHouseStats(); // 하우스 손익 통계 로드

        // 정기적인 업데이트 설정
        setInterval(() => {
          fetchUsers(); // 사용자 목록 새로고침
          fetchFinancialSummary(); // 재정 요약도 업데이트
          fetchExchangeRequests(); // 환전 요청은 항상 업데이트
          fetchDepositRequests(); // 충전 요청도 항상 업데이트
          fetchHouseStats(); // 하우스 통계도 정기적으로 업데이트
        }, 30000); // 30초마다
      });

      // 리더보드 테이블 업데이트 함수
      function updateLeaderboardTable(leaderboard) {
        const leaderboardTable = document.getElementById("leaderboardTable");
        if (!leaderboardTable) return;

        leaderboardTable.innerHTML = "";

        leaderboard.forEach((user, index) => {
          const tr = document.createElement("tr");
          tr.className =
            "border-t border-gray-800 hover:bg-gray-800/50 transition-colors";

          const rankClass =
            index < 3
              ? [
                  "text-yellow-400 font-bold",
                  "text-gray-300 font-bold",
                  "text-orange-400 font-bold",
                ][index]
              : "text-gray-400";

          tr.innerHTML = `
            <td class="py-3 px-4">
              <span class="${rankClass}">${index + 1}</span>
            </td>
            <td class="py-3 px-4">${user.username}</td>
            <td class="py-3 px-4 text-right text-yellow-400 font-bold">${user.balance.toLocaleString()} 원</td>
            <td class="py-3 px-4 text-right">${user.winRate}%</td>
            <td class="py-3 px-4 text-right">${user.totalBets}</td>
          `;
          leaderboardTable.appendChild(tr);
        });
      }

      // 리더보드 가져오기
      async function fetchLeaderboard() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/leaderboard",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const leaderboard = await res.json();
          updateLeaderboardTable(leaderboard);
        } catch (err) {
          showToast("리더보드를 불러오는데 실패했습니다.");
        }
      }

      // 바카라 관리 페이지로 이동
      document
        .getElementById("goToBaccaratAdmin")
        .addEventListener("click", () => {
          window.open("baccarat-admin.html", "_blank");
        });

      // 블랙잭 관리 페이지로 이동 (새 탭)
      document
        .getElementById("goToBlackjackAdmin")
        .addEventListener("click", () => {
          window.open("blackjack-admin.html", "_blank");
        });

      // 로그아웃
      document.getElementById("logout").addEventListener("click", () => {
        if (confirm("정말 로그아웃 하시겠습니까?")) {
          localStorage.removeItem("token");
          showToast("로그아웃되었습니다.", "info");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1000);
        }
      });

      // 초기 리더보드 로드 (다른 항목들은 DOMContentLoaded에서 처리)
      fetchLeaderboard();

      // 소켓 연결 및 초기 상태 요청
      socket.on("connect", () => {
        socket.emit("authenticate", token);
        // 관리자 페이지에서 현재 베팅 상태 요청
        socket.emit("request_betting_status");
      });

      // 사용자 자동 게임 상태 업데이트
      socket.on("user_auto_game_status_update", (data) => {
        const statusEl = document.getElementById("userAutoGameStatus");
        if (statusEl) {
          if (data.isActive) {
            statusEl.innerHTML = `<span class="text-green-400">활성 중</span> (접속자: ${data.connectedUsers}명)`;
          } else {
            statusEl.innerHTML = `<span class="text-gray-400">대기 중</span> (접속자: ${data.connectedUsers}명)`;
          }
        }
      });

      // 사용자 관리 섹션 수정
      async function fetchUsers() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users-stats",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!res.ok) {
            throw new Error("사용자 데이터를 불러오는데 실패했습니다.");
          }

          const users = await res.json();
          const userTable = document.getElementById("userTable");
          userTable.innerHTML = "";

          users.forEach((user) => {
            const tr = document.createElement("tr");
            tr.className =
              "border-t border-gray-800 hover:bg-gray-700/50 transition-colors";

            // Role and Status styling
            const roleText = user.role === "admin" ? "관리자" : "일반";
            const roleClass =
              user.role === "admin" ? "text-purple-400" : "text-gray-400";
            const approvedText = user.isApproved ? "승인됨" : "미승인";
            const approvedClass = user.isApproved
              ? "text-green-400"
              : "text-yellow-500";

            // Profit/Loss styling
            const netProfit = user.netProfit || 0;
            const netProfitClass =
              netProfit > 0
                ? "text-green-400"
                : netProfit < 0
                ? "text-red-400"
                : "text-gray-400";
            const profitPrefix = netProfit > 0 ? "+" : "";

            // Win rate styling
            const winRate = parseFloat(user.winRate) || 0;
            const winRateClass =
              winRate >= 50
                ? "text-green-400"
                : winRate < 40
                ? "text-red-400"
                : "text-gray-400";

            tr.innerHTML = `
                <td class="py-3 px-4">
                    <div class="font-medium">${user.username}</div>
                    <div class="text-xs ${roleClass}">${roleText}</div>
                </td>
                <td class="py-3 px-4 text-left">
                    <span class="font-medium ${approvedClass}">${approvedText}</span>
                </td>
                <td class="py-3 px-4 text-right">
                    <div class="font-bold text-yellow-400">${user.balance.toLocaleString()} 원</div>
                </td>
                <td class="py-3 px-4 text-right">
                    <div class="font-medium ${netProfitClass}">${profitPrefix}${netProfit.toLocaleString()} 원</div>
                </td>
                <td class="py-3 px-4 text-left">
                    <div>
                        <span class="font-medium">${user.wins}승 ${
              user.losses
            }패</span>
                        <span class="text-sm ${winRateClass}">(${winRate.toFixed(
              1
            )}%)</span>
                    </div>
                    <div class="text-xs text-gray-400">총 ${
                      user.totalBets
                    } 베팅</div>
                </td>
                <td class="py-3 px-4">
                    <div class="flex justify-center items-center gap-1 flex-wrap">
                      ${
                        !user.isApproved
                          ? `
                        <button
                          class="approve-user bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-medium"
                          data-id="${user._id}"
                        >
                          승인
                        </button>
                      `
                          : ""
                      }
                      ${
                        user.role !== "superadmin"
                          ? `
                        <button
                          onclick="toggleAdmin('${user._id}', '${user.role}')"
                          class="${
                            user.role === "admin"
                              ? "bg-gray-600 hover:bg-gray-700"
                              : "bg-purple-600 hover:bg-purple-700"
                          } text-white px-2 py-1 rounded text-xs font-medium"
                        >
                          ${user.role === "admin" ? "해제" : "지정"}
                        </button>
                      `
                          : ""
                      }
                      <button
                        class="user-detail bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded text-xs font-medium"
                        data-id="${user._id}"
                        data-username="${user.username}"
                      >
                        상세
                      </button>
                      <button
                        class="reset-password bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-medium"
                        data-id="${user._id}"
                      >
                        비번
                      </button>
                      <button
                        class="delete-user bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-medium"
                        data-id="${user._id}"
                      >
                        삭제
                      </button>
                    </div>
                </td>
            `;
            userTable.appendChild(tr);
          });

          // 이벤트 리스너 설정
          setupUserManagementListeners();
        } catch (err) {
          showToast("사용자 데이터를 불러오는데 실패했습니다.");
        }
      }

      // 사용자 관리 이벤트 리스너 설정
      function setupUserManagementListeners() {
        document.querySelectorAll(".adjust-coins").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = this.getAttribute("data-id");
            adjustCoins(userId);
          });
        });

        document.querySelectorAll(".approve-user").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = this.getAttribute("data-id");
            approveUser(userId);
          });
        });

        document.querySelectorAll(".delete-user").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = this.getAttribute("data-id");
            deleteUser(userId);
          });
        });

        document.querySelectorAll(".reset-password").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = this.getAttribute("data-id");
            resetPassword(userId);
          });
        });

        document.querySelectorAll(".user-detail").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = this.getAttribute("data-id");
            const username = this.getAttribute("data-username");
            showUserDetail(userId, username);
          });
        });
      }

      // 사용자 상세정보 모달 관련 함수들
      let currentDetailUserId = null;

      // 사용자 상세정보 모달 표시
      async function showUserDetail(userId, username) {
        currentDetailUserId = userId;
        document.getElementById("detailUsername").textContent = username;
        document.getElementById("userDetailModal").classList.remove("hidden");

        // 개요 탭을 기본으로 선택
        switchDetailTab("overview");

        // 사용자 상세정보 로드
        await loadUserDetailInfo(userId);
      }

      // 사용자 상세정보 로드
      async function loadUserDetailInfo(userId) {
        try {
          // 기존 users-stats API를 사용하여 해당 사용자 정보 찾기
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users-stats",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!res.ok) {
            throw new Error("사용자 정보를 불러오는데 실패했습니다.");
          }

          const users = await res.json();
          const userDetail = users.find((user) => user._id === userId);

          if (!userDetail) {
            throw new Error("해당 사용자를 찾을 수 없습니다.");
          }

          // 추가 정보를 위해 베팅 기록도 가져오기
          await loadAdditionalUserInfo(userDetail);
          updateUserDetailModal(userDetail);
        } catch (err) {
          showToast("사용자 상세정보를 불러오는데 실패했습니다.", "error");
          console.error("Error loading user detail:", err);
        }
      }

      // 추가 사용자 정보 로드 (베팅 기록 등)
      async function loadAdditionalUserInfo(userDetail) {
        try {
          // 새로운 사용자 상세 정보 API 호출
          const detailRes = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/user-detail/${userDetail._id}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (detailRes.ok) {
            const detailData = await detailRes.json();

            // 서버에서 받은 실제 데이터로 업데이트 (서버 응답 구조에 맞춤)
            Object.assign(userDetail, detailData);
          }
        } catch (err) {
          console.error("Error loading additional user info:", err);
          // 기본값 설정
          userDetail.baccarat = userDetail.baccarat || {
            totalGames: 0,
            wins: 0,
            losses: 0,
            winRate: 0,
            totalBetAmount: 0,
            totalWinAmount: 0,
            bettingProfit: 0,
            averageBetAmount: 0,
            choiceStats: {},
            favoriteChoice: null,
          };
          userDetail.blackjack = userDetail.blackjack || {
            totalGames: 0,
            wins: 0,
            losses: 0,
            winRate: 0,
            totalBetAmount: 0,
            totalWinAmount: 0,
            bettingProfit: 0,
            averageBetAmount: 0,
            blackjacks: 0,
            busts: 0,
          };
          userDetail.overallProfit =
            userDetail.overallProfit || userDetail.netProfit || 0;
          userDetail.totalDeposited = userDetail.totalDeposited || 0;
          userDetail.totalExchanged = userDetail.totalExchanged || 0;
          userDetail.depositCount = userDetail.depositCount || 0;
          userDetail.exchangeCount = userDetail.exchangeCount || 0;
          userDetail.recentTransactions = userDetail.recentTransactions || [];
          userDetail.recentActivity = userDetail.recentActivity || [];
          userDetail.rollingWagered = userDetail.rollingWagered || 0;
          userDetail.rollingRequirement = userDetail.rollingRequirement || 0;
          userDetail.rollingProgress = userDetail.rollingProgress || 0;
        }
      }

      // 사용자 상세정보 모달 업데이트
      function updateUserDetailModal(userDetail) {
        // 개요 탭 정보 업데이트 (통합 통계)
        document.getElementById("detailUserWins").textContent =
          parseInt(userDetail.totalWins) || 0;
        document.getElementById("detailUserLoses").textContent =
          parseInt(userDetail.totalLosses) || 0;
        document.getElementById("detailUserWinRate").textContent = `${(
          parseFloat(userDetail.overallWinRate) || 0
        ).toFixed(1)}%`;
        document.getElementById("detailTotalGames").textContent =
          parseInt(userDetail.totalGames) || 0;

        const totalBettingProfit =
          parseFloat(userDetail.totalBettingProfit) || 0;
        const bettingProfitElement = document.getElementById(
          "detailGameStatsBettingProfit"
        );
        bettingProfitElement.textContent = `${
          totalBettingProfit >= 0 ? "+" : ""
        }${Math.round(totalBettingProfit).toLocaleString()}원`;
        bettingProfitElement.className = `font-bold text-lg ${
          totalBettingProfit >= 0 ? "text-green-400" : "text-red-400"
        }`;

        document.getElementById("detailCurrentBalance").textContent = `${(
          parseInt(userDetail.balance) || 0
        ).toLocaleString()}원`;

        const overallProfit = parseFloat(userDetail.overallProfit) || 0;
        const overallProfitElement = document.getElementById(
          "detailOverallProfit"
        );
        overallProfitElement.textContent = `${
          overallProfit >= 0 ? "+" : ""
        }${Math.round(overallProfit).toLocaleString()}원`;
        overallProfitElement.className = `font-bold text-lg ${
          overallProfit >= 0 ? "text-green-400" : "text-red-400"
        }`;

        // 롤링 정보 업데이트
        const rollingProgress = parseFloat(userDetail.rollingProgress) || 0;
        document.getElementById(
          "detailRollingProgressTextInfo"
        ).textContent = `${rollingProgress.toFixed(1)}%`;
        document.getElementById(
          "detailRollingProgressBarInfo"
        ).style.width = `${Math.min(rollingProgress, 100)}%`;
        document.getElementById("detailRollingWageredAmount").textContent = `${(
          parseInt(userDetail.rollingWagered) || 0
        ).toLocaleString()}원`;
        document.getElementById(
          "detailRollingRequiredAmount"
        ).textContent = `${(
          parseInt(userDetail.rollingRequirement) || 0
        ).toLocaleString()}원`;

        // 바카라 탭 정보 업데이트
        if (userDetail.baccarat) {
          const baccarat = userDetail.baccarat;
          document.getElementById("detailBaccaratTotalGames").textContent = `${
            baccarat.totalGames || 0
          }게임`;
          document.getElementById("detailBaccaratWins").textContent =
            baccarat.wins || 0;
          document.getElementById("detailBaccaratLosses").textContent =
            baccarat.losses || 0;
          document.getElementById("detailBaccaratWinRate").textContent = `${(
            baccarat.winRate || 0
          ).toFixed(1)}%`;
          document.getElementById(
            "detailBaccaratTotalBetAmount"
          ).textContent = `${(
            baccarat.totalBetAmount || 0
          ).toLocaleString()}원`;
          document.getElementById(
            "detailBaccaratTotalWinAmount"
          ).textContent = `${(
            baccarat.totalWinAmount || 0
          ).toLocaleString()}원`;

          const baccaratProfit = baccarat.bettingProfit || 0;
          const baccaratProfitElement = document.getElementById(
            "detailBaccaratBettingProfit"
          );
          baccaratProfitElement.textContent = `${
            baccaratProfit >= 0 ? "+" : ""
          }${Math.round(baccaratProfit).toLocaleString()}원`;
          baccaratProfitElement.className = `font-bold ${
            baccaratProfit >= 0 ? "text-green-400" : "text-red-400"
          }`;

          document.getElementById(
            "detailBaccaratAverageBetAmount"
          ).textContent = `${Math.round(
            baccarat.averageBetAmount || 0
          ).toLocaleString()}원`;

          // 바카라 베팅 선호도 업데이트
          updateDetailBaccaratChoicePreferences(baccarat.choiceStats || {});

          // 가장 선호하는 베팅 표시
          if (baccarat.favoriteChoice) {
            const choiceNames = {
              player: "플레이어",
              banker: "뱅커",
              tie: "타이",
              player_pair: "플레이어 페어",
              banker_pair: "뱅커 페어",
            };
            document.getElementById(
              "detailBaccaratFavoriteChoice"
            ).textContent =
              choiceNames[baccarat.favoriteChoice.choice] ||
              baccarat.favoriteChoice.choice;
          } else {
            document.getElementById(
              "detailBaccaratFavoriteChoice"
            ).textContent = "-";
          }
        }

        // 블랙잭 탭 정보 업데이트
        if (userDetail.blackjack) {
          const blackjack = userDetail.blackjack;
          document.getElementById("detailBlackjackTotalGames").textContent = `${
            blackjack.totalGames || 0
          }게임`;
          document.getElementById("detailBlackjackWins").textContent =
            blackjack.wins || 0;
          document.getElementById("detailBlackjackLosses").textContent =
            blackjack.losses || 0;
          document.getElementById("detailBlackjackWinRate").textContent = `${(
            blackjack.winRate || 0
          ).toFixed(1)}%`;
          document.getElementById(
            "detailBlackjackTotalBetAmount"
          ).textContent = `${(
            blackjack.totalBetAmount || 0
          ).toLocaleString()}원`;
          document.getElementById(
            "detailBlackjackTotalWinAmount"
          ).textContent = `${(
            blackjack.totalWinAmount || 0
          ).toLocaleString()}원`;

          const blackjackProfit = blackjack.bettingProfit || 0;
          const blackjackProfitElement = document.getElementById(
            "detailBlackjackBettingProfit"
          );
          blackjackProfitElement.textContent = `${
            blackjackProfit >= 0 ? "+" : ""
          }${Math.round(blackjackProfit).toLocaleString()}원`;
          blackjackProfitElement.className = `font-bold ${
            blackjackProfit >= 0 ? "text-green-400" : "text-red-400"
          }`;

          document.getElementById(
            "detailBlackjackAverageBetAmount"
          ).textContent = `${Math.round(
            blackjack.averageBetAmount || 0
          ).toLocaleString()}원`;
          document.getElementById("detailBlackjackBlackjacks").textContent =
            blackjack.blackjacks || 0;
          document.getElementById("detailBlackjackBusts").textContent =
            blackjack.busts || 0;

          // 최근 블랙잭 게임 업데이트
          updateDetailBlackjackRecentGames(userDetail.recentActivity || []);
        }

        // 재정 현황 탭 정보 업데이트
        document.getElementById("detailTotalDeposited").textContent = `${(
          parseInt(userDetail.totalDeposited) || 0
        ).toLocaleString()}원`;
        document.getElementById("detailDepositCount").textContent =
          parseInt(userDetail.depositCount) || 0;
        document.getElementById("detailTotalExchanged").textContent = `${(
          parseInt(userDetail.totalExchanged) || 0
        ).toLocaleString()}원`;
        document.getElementById("detailExchangeCount").textContent =
          parseInt(userDetail.exchangeCount) || 0;

        // 최근 거래 내역 업데이트
        updateDetailRecentTransactions(userDetail.recentTransactions || []);
      }

      // 바카라 베팅 선호도 차트 업데이트
      function updateDetailBaccaratChoicePreferences(preferences) {
        const container = document.getElementById(
          "detailBaccaratChoicePreferences"
        );
        container.innerHTML = "";

        const choiceNames = {
          player: "플레이어",
          banker: "뱅커",
          tie: "타이",
          player_pair: "플레이어 페어",
          banker_pair: "뱅커 페어",
        };

        const choiceColors = {
          player: "bg-blue-500",
          banker: "bg-red-500",
          tie: "bg-green-500",
          player_pair: "bg-blue-400",
          banker_pair: "bg-red-400",
        };

        let maxCount = 0;

        // 최대값 찾기
        Object.entries(preferences).forEach(([choice, count]) => {
          if (count > maxCount) {
            maxCount = count;
          }
        });

        // 차트 생성
        Object.entries(preferences).forEach(([choice, count]) => {
          const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
          const choiceName = choiceNames[choice] || choice;
          const colorClass = choiceColors[choice] || "bg-gray-500";

          const div = document.createElement("div");
          div.className = "flex items-center space-x-2";
          div.innerHTML = `
            <span class="text-sm text-gray-400 w-20">${choiceName}:</span>
            <div class="flex-1 bg-gray-700 rounded-full h-2">
              <div class="${colorClass} h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
            <span class="text-sm text-gray-300 w-8">${count}</span>
          `;
          container.appendChild(div);
        });
      }

      // 블랙잭 최근 게임 업데이트
      function updateDetailBlackjackRecentGames(recentActivity) {
        const container = document.getElementById("detailBlackjackRecentGames");
        container.innerHTML = "";

        const blackjackGames = recentActivity.filter(
          (activity) => activity.type === "blackjack"
        );

        if (blackjackGames.length === 0) {
          container.innerHTML =
            '<div class="text-gray-400 text-center py-4">블랙잭 게임 기록이 없습니다.</div>';
          return;
        }

        blackjackGames.slice(0, 10).forEach((game) => {
          const div = document.createElement("div");
          div.className = "bg-black bg-opacity-30 p-3 rounded-lg";

          const resultText =
            {
              win: "승리",
              lose: "패배",
              blackjack: "블랙잭",
              bust: "버스트",
              push: "무승부",
            }[game.result] || game.result;

          const resultColor =
            {
              win: "text-green-400",
              lose: "text-red-400",
              blackjack: "text-yellow-400",
              bust: "text-red-500",
              push: "text-gray-400",
            }[game.result] || "text-gray-400";

          const profitColor =
            game.profit >= 0 ? "text-green-400" : "text-red-400";
          const profitPrefix = game.profit >= 0 ? "+" : "";

          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <span class="${resultColor} font-medium">${resultText}</span>
                <span class="text-gray-400 text-sm ml-2">${
                  game.roomName || "블랙잭"
                }</span>
              </div>
              <div class="text-right">
                <div class="font-bold">${(
                  game.amount || 0
                ).toLocaleString()}원</div>
                <div class="${profitColor} text-sm">${profitPrefix}${(
            game.profit || 0
          ).toLocaleString()}원</div>
              </div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>플레이어: ${game.playerScore || 0} | 딜러: ${
            game.dealerScore || 0
          }</span>
              <span>${new Date(game.date).toLocaleDateString()}</span>
            </div>
          `;
          container.appendChild(div);
        });
      }

      // 최근 거래 내역 업데이트
      function updateDetailRecentTransactions(transactions) {
        const container = document.getElementById("detailRecentTransactions");
        container.innerHTML = "";

        if (transactions.length === 0) {
          container.innerHTML =
            '<div class="text-gray-400 text-center py-4">거래 내역이 없습니다.</div>';
          return;
        }

        transactions.forEach((transaction) => {
          const div = document.createElement("div");
          div.className = "bg-black bg-opacity-30 p-3 rounded-lg";

          const typeText = transaction.type === "deposit" ? "충전" : "환전";
          const typeColor =
            transaction.type === "deposit"
              ? "text-blue-400"
              : "text-orange-400";
          const statusText =
            transaction.status === "approved"
              ? "승인"
              : transaction.status === "pending"
              ? "대기"
              : "거절";
          const statusColor =
            transaction.status === "approved"
              ? "text-green-400"
              : transaction.status === "pending"
              ? "text-yellow-400"
              : "text-red-400";

          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <span class="${typeColor} font-medium">${typeText}</span>
                <span class="text-gray-400 text-sm ml-2">${new Date(
                  transaction.createdAt
                ).toLocaleDateString()}</span>
              </div>
              <div class="text-right">
                <div class="font-bold">${transaction.amount.toLocaleString()}원</div>
                <div class="${statusColor} text-sm">${statusText}</div>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      }

      // 상세정보 모달 탭 전환
      function switchDetailTab(tabName) {
        // 모든 탭 버튼 비활성화
        document
          .querySelectorAll('[id^="detail"][id$="Tab"]')
          .forEach((tab) => {
            tab.className =
              "flex-1 py-2 px-3 rounded-md text-xs font-medium transition-colors text-gray-400 hover:text-yellow-500";
          });

        // 모든 탭 컨텐츠 숨기기
        document
          .querySelectorAll('[id^="detail"][id$="Content"]')
          .forEach((content) => {
            content.classList.add("hidden");
          });

        // 선택된 탭 활성화
        const activeTab = document.getElementById(
          `detail${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`
        );
        const activeContent = document.getElementById(
          `detail${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Content`
        );

        if (activeTab && activeContent) {
          activeTab.className =
            "flex-1 py-2 px-3 rounded-md text-xs font-medium transition-colors bg-purple-600 text-white";
          activeContent.classList.remove("hidden");
        }
      }

      // resetPassword 함수 수정
      async function resetPassword(userId) {
        const newPassword = prompt("새 비밀번호를 입력하세요:");
        if (!newPassword) return;

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users/${userId}/reset-password`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ newPassword }),
            }
          );

          const data = await res.json();
          showToast(data.message);
          if (res.ok) {
            fetchUsers(); // 목록 새로고침
          }
        } catch (err) {
          showToast("서버 에러가 발생했습니다.");
        }
      }

      // adjustCoins 함수 수정 (모달 사용으로 개선)
      async function adjustCoins(userId) {
        return new Promise((resolve) => {
          // 모달 생성
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          modal.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
              <h3 class="text-lg font-semibold text-white mb-4">잔액 조정</h3>
              <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                  조정할 금액(원)을 입력하세요 (음수 가능):
                </label>
                <input
                  type="number"
                  id="adjustmentAmount"
                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="예: 10000 또는 -5000"
                  step="1000"
                />
              </div>
              <div class="flex space-x-3">
                <button
                  id="confirmAdjust"
                  class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium transition-colors"
                >
                  확인
                </button>
                <button
                  id="cancelAdjust"
                  class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium transition-colors"
                >
                  취소
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          const input = modal.querySelector("#adjustmentAmount");
          const confirmBtn = modal.querySelector("#confirmAdjust");
          const cancelBtn = modal.querySelector("#cancelAdjust");

          // 입력 필드에 포커스
          input.focus();

          // Enter 키로 확인
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              confirmBtn.click();
            }
          });

          // 확인 버튼 클릭
          confirmBtn.addEventListener("click", async () => {
            const amount = input.value.trim();
            if (!amount) {
              showToast("금액을 입력해주세요.", "error");
              return;
            }

            const adjustment = parseInt(amount);
            if (isNaN(adjustment)) {
              showToast("유효한 숫자를 입력해주세요.", "error");
              return;
            }

            try {
              const res = await fetch(
                `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users/${userId}/adjust-coins`,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({ adjustment }),
                }
              );

              const data = await res.json();
              showToast(data.message);
              if (res.ok) {
                // 실시간 업데이트: 특정 사용자 잔액만 업데이트
                if (data.newBalance !== undefined) {
                  updateUserBalanceInTable(userId, data.newBalance);
                } else {
                  fetchUsers(); // 실시간 업데이트가 안 되면 전체 새로고침
                }
              }
            } catch (err) {
              showToast("서버 에러가 발생했습니다.", "error");
            }

            // 모달 제거
            document.body.removeChild(modal);
            resolve();
          });

          // 취소 버튼 클릭
          cancelBtn.addEventListener("click", () => {
            document.body.removeChild(modal);
            resolve();
          });

          // 모달 외부 클릭시 닫기
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
              resolve();
            }
          });

          // ESC 키로 닫기
          const handleEscape = (e) => {
            if (e.key === "Escape") {
              document.removeEventListener("keydown", handleEscape);
              document.body.removeChild(modal);
              resolve();
            }
          };
          document.addEventListener("keydown", handleEscape);
        });
      }

      // 환전 요청 목록 가져오기 함수 수정
      async function fetchExchangeRequests() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/exchange-requests",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          const requests = await res.json();
          const container = document.getElementById("exchangeRequestsTable");
          container.innerHTML = "";

          requests.forEach((request) => {
            const tr = document.createElement("tr");
            tr.className = "border-t border-gray-800";

            const statusClass = {
              pending: "text-yellow-400",
              approved: "text-green-400",
              rejected: "text-red-400",
            }[request.status];

            const statusText = {
              pending: "대기중",
              approved: "승인됨",
              rejected: "거절됨",
            }[request.status];

            tr.innerHTML = `
              <td class="py-3 px-4">${new Date(
                request.createdAt
              ).toLocaleString()}</td>
              <td class="py-3 px-4">${request.username}</td>
              <td class="py-3 px-4 text-right text-yellow-400">${request.requestAmount.toLocaleString()} 원</td>
              <td class="py-3 px-4 text-right">
                <div class="text-green-400">실수령: ${request.actualAmount.toLocaleString()} 원</div>
                <div class="text-red-400">수수료: ${request.fee.toLocaleString()} 원</div>
              </td>
              <td class="py-3 px-4 text-center">
                <span class="${statusClass} font-semibold">${statusText}</span>
              </td>
              <td class="py-3 px-4 text-center">
                ${
                  request.status === "pending"
                    ? `
                  <button
                    onclick="handleExchange('${request._id}', 'approved')"
                    class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded mr-2"
                  >
                    승인
                  </button>
                  <button
                    onclick="handleExchange('${request._id}', 'rejected')"
                    class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded"
                  >
                    거절
                  </button>
                `
                    : ""
                }
              </td>
            `;
            container.appendChild(tr);
          });
        } catch (err) {
          showToast("환전 요청 목록을 불러오는데 실패했습니다.");
        }
      }

      // 환전 요청 처리
      async function handleExchange(requestId, status) {
        if (
          !confirm(
            `정말로 이 환전 요청을 ${
              status === "approved" ? "승인" : "거절"
            }하시겠습니?`
          )
        ) {
          return;
        }

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/exchange-requests/${requestId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ status }),
            }
          );

          const data = await res.json();
          showToast(data.message);

          if (res.ok) {
            fetchExchangeRequests(); // 목록 새로고침
            fetchFinancialSummary(); // 재정 요약 새로고침
          }
        } catch (err) {
          showToast("서버 에러가 발생했습니다.");
        }
      }

      // 환전 요청 목록은 DOMContentLoaded에서 처리됨

      // Socket.IO 이벤트 리스너 추가

      // 기존 game.html 호환용 game_result 이벤트 (새로운 admin 컨트롤 시스템이 우선)
      socket.on("game_result", (data) => {
        // 이 핸들러의 내용은 서버에서 결과가 자동으로 처리되므로 제거합니다.
        // 게임 결과 표시는 game_result_with_cards 핸들러에서 처리됩니다.
      });

      // 페이지 로드 시 결과 관리 섹션 숨기기
      document.addEventListener("DOMContentLoaded", () => {});

      // Socket.IO 이벤트 리스너 수정
      socket.on("recent_games_updated", (data) => {
        const { recentGames, stats: gameStats } = data; // 서버에서 오는 stats는 게임 승리 통계이므로 gameStats로 변경
        // updateGameStats(recentGames, gameStats); // 이 함수는 이제 최근 게임 '목록' 통계를 다룸. 베팅 통계와는 다름.
        // fetchRecentGames 함수 내부에서 통계 업데이트가 이미 처리되고 있음.
        // 만약 여기서도 최근 게임 목록에 대한 통계를 표시해야 한다면, 해당 로직을 여기에 유지.

        // 최근 게임 기록 테이블 업데이트
        const recentGamesTable = document.getElementById("recentGamesTable");
        if (recentGamesTable) {
          recentGamesTable.innerHTML = "";

          recentGames.forEach((game, index) => {
            const tr = document.createElement("tr");
            tr.className = "border-t border-gray-800";

            const resultClass = {
              player: "text-blue-400",
              banker: "text-red-400",
              tie: "text-green-400",
            }[game.result];

            const resultText =
              game.result === "player"
                ? "플레이어"
                : game.result === "banker"
                ? "뱅커"
                : "타이";

            tr.innerHTML = `
              <td class="py-3 px-4">${recentGames.length - index}</td>
              <td class="py-3 px-4">
                 <span class="font-semibold ${resultClass}">${resultText}</span>
              </td>
              <td class="py-3 px-4">${new Date(game.date).toLocaleString()}</td>
              <td class="py-3 px-4 text-right">${formatAdminAmount(
                game.totalBets
              )}</td>
              <td class="py-3 px-4 text-right">${game.playerCount}명</td>
              <td class="py-3 px-4 text-center">${
                game.playerPairOccurred
                  ? '<span class="text-xs font-semibold px-1.5 py-0.5 rounded bg-blue-500 text-white">P</span>'
                  : "-"
              }</td>
              <td class="py-3 px-4 text-center">${
                game.bankerPairOccurred
                  ? '<span class="text-xs font-semibold px-1.5 py-0.5 rounded bg-red-500 text-white">B</span>'
                  : "-"
              }</td>
            `;
            recentGamesTable.appendChild(tr);
          });
        }

        // "최근 게임 기록" 섹션의 전체 통계 업데이트 (P/B/T 승리 횟수 등)
        if (gameStats) {
          document.getElementById("playerWins").textContent =
            gameStats.playerWins || 0;
          document.getElementById("bankerWins").textContent =
            gameStats.bankerWins || 0;
          document.getElementById("tieWins").textContent = gameStats.ties || 0;
        }
      });

      // 실시간 베팅 현황 업데이트 (new_bet 이벤트 핸들러)
      socket.on("new_bet", (data) => {
        const { stats } = data;
        if (stats) {
          // stats 객체가 존재하는지 확인
          updateBettingStats(stats); // 실시간 베팅 현황 업데이트 함수 호출
        }
      });

      // 결과 승인 완료 알림 처리
      socket.on("admin_result_approved", (data) => {
        showToast(`✅ ${data.message}`, 3000);

        // 자동 새로고침 대신 실시간 업데이트 확인
        setTimeout(() => {
          // 추가적인 데이터 동기화가 필요한 경우 여기서 처리
          fetchUsers();
        }, 500);
      });

      // 게임 결과 수신 이벤트 (실시간 점수)
      socket.on("game_result", (data) => {
        const { result, playerScore, bankerScore } = data;

        // 승자 표시
        const gameWinner = document.getElementById("gameWinner");
        let winnerText = "";
        let winnerClass = "";

        if (result === "player") {
          winnerText = `플레이어 승리! (${playerScore}-${bankerScore})`;
          winnerClass = "text-blue-400";
        } else if (result === "banker") {
          winnerText = `뱅커 승리! (${playerScore}-${bankerScore})`;
          winnerClass = "text-red-400";
        } else {
          winnerText = `타이! (${playerScore}-${bankerScore})`;
          winnerClass = "text-green-400";
        }

        gameWinner.textContent = winnerText;
        gameWinner.className = `text-xl font-bold text-center mb-2 ${winnerClass}`;

        // 게임 결과 후 하우스 통계 업데이트
        setTimeout(() => {
          fetchHouseStats();
        }, 1000);
      });

      // 페이지 로드 시 이벤트 리스너 설정
      document.addEventListener("DOMContentLoaded", () => {
        // 사용자 상세정보 모달 이벤트 리스너
        document
          .getElementById("closeUserDetail")
          .addEventListener("click", function () {
            document.getElementById("userDetailModal").classList.add("hidden");
          });

        // 상세정보 모달 탭 이벤트 리스너
        document
          .getElementById("detailOverviewTab")
          .addEventListener("click", function () {
            switchDetailTab("overview");
          });

        document
          .getElementById("detailBaccaratTab")
          .addEventListener("click", function () {
            switchDetailTab("baccarat");
          });

        document
          .getElementById("detailBlackjackTab")
          .addEventListener("click", function () {
            switchDetailTab("blackjack");
          });

        document
          .getElementById("detailFinancialTab")
          .addEventListener("click", function () {
            switchDetailTab("financial");
          });

        // 모달 외부 클릭시 닫기
        document
          .getElementById("userDetailModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              this.classList.add("hidden");
            }
          });
      });

      // 재정 요약 가져오기 함수
      async function fetchFinancialSummary() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/users-financial-summary",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (!res.ok)
            throw new Error("재정 요약 데이터를 불러오는데 실패했습니다.");

          const summaries = await res.json();
          const tableBody = document.getElementById("financialSummaryTable");
          tableBody.innerHTML = "";

          summaries.forEach((summary) => {
            const tr = document.createElement("tr");
            tr.className =
              "border-t border-gray-800 hover:bg-gray-700/50 transition-colors";

            const profitClass =
              summary.financialProfit > 0
                ? "text-green-400"
                : summary.financialProfit < 0
                ? "text-red-400"
                : "text-gray-400";

            tr.innerHTML = `
              <td class="py-3 px-4 font-medium">${summary.username}</td>
              <td class="py-3 px-4 text-right text-yellow-400 font-bold">${summary.currentBalance.toLocaleString()} 원</td>
              <td class="py-3 px-4 text-right text-blue-400">${summary.totalDeposited.toLocaleString()} 원</td>
              <td class="py-3 px-4 text-right text-orange-400">${summary.totalExchanged.toLocaleString()} 원</td>
              <td class="py-3 px-4 text-right ${profitClass} font-semibold">${summary.financialProfit.toLocaleString()} 원</td>
              <td class="py-3 px-4 text-center">
                <button
                  class="adjust-coins bg-yellow-600 hover:bg-yellow-700 text-white px-2.5 py-1.5 rounded text-sm font-medium transition-colors"
                  data-id="${summary.userId}"
                >
                  잔액 조절
                </button>
              </td>
            `;
            tableBody.appendChild(tr);
          });

          // 잔액 조절 버튼에 이벤트 리스너 추가
          document
            .querySelectorAll("#financialSummaryTable .adjust-coins")
            .forEach((button) => {
              button.addEventListener("click", function () {
                const userId = this.getAttribute("data-id");
                adjustCoins(userId);
              });
            });
        } catch (err) {
          showToast(err.message);
        }
      }

      // 충전 요청 목록 가져오기 함수
      async function fetchDepositRequests() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/deposit-requests",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const requests = await res.json();
          const container = document.getElementById("depositRequestsTable");
          container.innerHTML = "";

          requests.forEach((request) => {
            const tr = document.createElement("tr");
            tr.className = "border-t border-gray-800";

            const statusClass = {
              pending: "text-yellow-400",
              approved: "text-green-400",
              rejected: "text-red-400",
            }[request.status];

            const statusText = {
              pending: "대기중",
              approved: "승인됨",
              rejected: "거절됨",
            }[request.status];

            tr.innerHTML = `
              <td class="py-3 px-4">${new Date(
                request.createdAt
              ).toLocaleString()}</td>
              <td class="py-3 px-4">${request.username}</td>
              <td class="py-3 px-4 text-right text-yellow-400">${request.amount.toLocaleString()} 원</td>
              <td class="py-3 px-4 text-center">
                <span class="${statusClass} font-semibold">${statusText}</span>
              </td>
              <td class="py-3 px-4 text-center">
                ${
                  request.status === "pending"
                    ? `
                  <button
                    onclick="handleDeposit('${request._id}', 'approved')"
                    class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded mr-2"
                  >승인</button>
                  <button
                    onclick="handleDeposit('${request._id}', 'rejected')"
                    class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded"
                  >거절</button>
                `
                    : ""
                }
              </td>
            `;
            container.appendChild(tr);
          });
        } catch (err) {
          showToast("충전 요청 목록을 불러오는데 실패했습니다.");
        }
      }

      // 충전 요청 처리 함수
      async function handleDeposit(requestId, status) {
        if (
          !confirm(
            `정말로 이 충전 요청을 ${
              status === "approved" ? "승인" : "거절"
            }하시겠습니까?`
          )
        ) {
          return;
        }

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/admin/deposit-requests/${requestId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ status }),
            }
          );

          const data = await res.json();
          showToast(data.message);

          if (res.ok) {
            fetchDepositRequests(); // 목록 새로고침
            fetchFinancialSummary(); // 재정 요약 새로고침
          }
        } catch (err) {
          showToast("서버 에러가 발생했습니다.");
        }
      }
    </script>

    <!-- 플로팅 채팅 UI (Admin) -->
    <!-- 채팅 플로팅 버튼 -->
    <div
      id="chatFloatingButton"
      class="fixed bottom-6 right-6 z-40 transition-all duration-300"
    >
      <button
        class="w-14 h-14 bg-gradient-to-r from-yellow-600 to-yellow-500 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center justify-center text-white bg-opacity-90 backdrop-blur-sm"
      >
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
            clip-rule="evenodd"
          ></path>
        </svg>
        <!-- 새 메시지 알림 뱃지 -->
        <div
          id="chatNotificationBadge"
          class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs text-white flex items-center justify-center font-bold hidden animate-pulse"
        >
          <span id="chatNotificationCount">0</span>
        </div>
      </button>
    </div>

    <!-- 채팅 창 (Admin - PC 레이아웃용 넓이 제한) -->
    <div
      id="chatWindow"
      class="fixed bottom-6 right-6 h-[500px] w-[500px] bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl border-2 border-yellow-500 shadow-2xl z-50 hidden transform transition-all duration-300 backdrop-blur-md bg-opacity-95"
    >
      <div class="flex flex-col h-full">
        <!-- 채팅 헤더 -->
        <div
          class="flex items-center justify-between p-4 border-b border-yellow-500 rounded-t-xl bg-gradient-to-r from-yellow-600 to-yellow-500"
        >
          <h3 class="text-white font-bold text-lg flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 000 6h.28l1.771 5.316A1 1 0 008 18h1a1 1 0 001-1v-4.382l6.553 3.276A1 1 0 0018 15V3z"
                clip-rule="evenodd"
              ></path>
            </svg>
            관리자 채팅
          </h3>
          <button
            id="closeChatButton"
            class="text-white hover:text-gray-300 transition-colors"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </button>
        </div>

        <!-- 채팅 메시지 영역 -->
        <div
          id="chatMessages"
          class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-3"
        >
          <!-- 채팅 메시지들이 여기에 동적으로 추가됩니다 -->
        </div>

        <!-- 채팅 입력 영역 -->
        <div class="p-4 border-t border-yellow-500">
          <div class="flex space-x-2 mb-2">
            <button
              id="highlightMessageBtn"
              class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700 transition-colors"
              title="이 메시지를 강조하여 전송합니다"
            >
              강조 메시지
            </button>
            <span class="text-xs text-gray-400 flex items-center"
              >관리자 메시지는 모든 사용자에게 팝업으로 표시됩니다</span
            >
          </div>
          <div class="flex space-x-2">
            <input
              type="text"
              id="chatMessageInput"
              placeholder="메시지를 입력하세요..."
              maxlength="500"
              class="flex-1 px-3 py-2 bg-gray-700 border border-yellow-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 text-sm"
            />
            <button
              id="sendChatButton"
              class="px-4 py-2 bg-gradient-to-r from-yellow-600 to-yellow-500 text-white rounded-lg hover:from-yellow-700 hover:to-yellow-600 transition-all duration-300 font-bold text-sm"
            >
              전송
            </button>
          </div>
          <div class="text-xs text-gray-400 mt-1 flex justify-between">
            <span><span id="chatCharCount">0</span>/500</span>
            <span id="highlightIndicator" class="text-yellow-400 hidden"
              >강조 메시지로 전송됩니다</span
            >
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===========================
      // 채팅 관련 변수 및 함수들 (Admin)
      // ===========================

      let isChatOpen = false;
      let unreadChatCount = 0;
      let isHighlightMode = false;

      // 채팅 관련 DOM 요소들
      const chatFloatingButton = document.getElementById("chatFloatingButton");
      const chatWindow = document.getElementById("chatWindow");
      const closeChatButton = document.getElementById("closeChatButton");
      const chatMessages = document.getElementById("chatMessages");
      const chatMessageInput = document.getElementById("chatMessageInput");
      const sendChatButton = document.getElementById("sendChatButton");
      const chatCharCount = document.getElementById("chatCharCount");
      const chatNotificationBadge = document.getElementById(
        "chatNotificationBadge"
      );
      const chatNotificationCount = document.getElementById(
        "chatNotificationCount"
      );
      const highlightMessageBtn = document.getElementById(
        "highlightMessageBtn"
      );
      const highlightIndicator = document.getElementById("highlightIndicator");

      // 채팅창 열기/닫기
      function toggleChat() {
        if (isChatOpen) {
          closeChatWindow();
        } else {
          openChatWindow();
        }
      }

      function openChatWindow() {
        if (chatWindow && chatFloatingButton) {
          chatWindow.classList.remove("hidden");
          chatFloatingButton.style.opacity = "0.5";
          isChatOpen = true;

          // 읽지 않은 메시지 카운트 초기화
          unreadChatCount = 0;
          updateChatNotificationBadge();

          // 스크롤을 맨 아래로
          if (chatMessages) {
            setTimeout(() => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
          }

          // 채팅 기록 로드
          loadChatHistory();
        }
      }

      function closeChatWindow() {
        if (chatWindow && chatFloatingButton) {
          chatWindow.classList.add("hidden");
          chatFloatingButton.style.opacity = "1";
          isChatOpen = false;
        }
      }

      // 채팅 기록 로드
      async function loadChatHistory() {
        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/chat/messages",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (res.ok) {
            const messages = await res.json();
            displayChatMessages(messages);
          }
        } catch (err) {
          console.error("채팅 기록 로드 오류:", err);
        }
      }

      // 채팅 메시지들 표시
      function displayChatMessages(messages) {
        if (!chatMessages) return;

        chatMessages.innerHTML = "";
        messages.forEach((message) => {
          appendChatMessage(message);
        });

        // 스크롤을 맨 아래로
        setTimeout(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
      }

      // 채팅 메시지 추가
      function appendChatMessage(message) {
        if (!chatMessages) return;

        const messageEl = document.createElement("div");
        messageEl.className = `chat-message ${
          message.isAdmin ? "admin-message" : "user-message"
        }`;

        const timeStr = new Date(message.createdAt).toLocaleTimeString(
          "ko-KR",
          {
            hour: "2-digit",
            minute: "2-digit",
          }
        );

        const adminBadge = message.isAdmin
          ? '<span class="inline-block px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded-full mr-2">관리자</span>'
          : "";
        const deleteBtn =
          "<button onclick=\"deleteChatMessage('" +
          message._id +
          '\')" class="text-red-400 hover:text-red-300 text-xs ml-2" title="메시지 삭제"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button>';

        messageEl.innerHTML = `
          <div class="flex flex-col ${
            message.isAdmin
              ? "bg-yellow-500 bg-opacity-10 border border-yellow-500 rounded-lg p-3"
              : "bg-gray-700 bg-opacity-50 rounded-lg p-3"
          }">
            <div class="flex items-center justify-between mb-1">
              <div class="flex items-center">
                ${adminBadge}
                <span class="font-bold ${
                  message.isAdmin ? "text-yellow-400" : "text-white"
                } text-sm">${escapeHtml(message.username)}</span>
              </div>
              <div class="flex items-center">
                <span class="text-gray-400 text-xs">${timeStr}</span>
                ${deleteBtn}
              </div>
            </div>
            <p class="text-white text-sm break-words">${escapeHtml(
              message.message
            )}</p>
          </div>
        `;

        chatMessages.appendChild(messageEl);
      }

      // HTML 이스케이프 함수
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // 채팅 메시지 전송
      async function sendChatMessage() {
        const message = chatMessageInput?.value.trim();
        if (!message || message.length > 500) return;

        try {
          // Socket으로 메시지 전송 (더 빠른 응답을 위해)
          socket.emit("send_chat_message", { message });

          // 입력창 초기화
          if (chatMessageInput) {
            chatMessageInput.value = "";
            updateCharCount();
          }

          // 강조 모드 해제
          if (isHighlightMode) {
            toggleHighlightMode();
          }
        } catch (err) {
          console.error("채팅 전송 오류:", err);
          showToast("채팅 전송에 실패했습니다.");
        }
      }

      // 채팅 메시지 삭제 (관리자만)
      async function deleteChatMessage(messageId) {
        if (!confirm("이 메시지를 삭제하시겠습니까?")) return;

        try {
          const res = await fetch(
            `https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/chat/message/${messageId}`,
            {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (res.ok) {
            showToast("메시지가 삭제되었습니다.");
            // 채팅 기록 다시 로드
            loadChatHistory();
          } else {
            showToast("메시지 삭제에 실패했습니다.");
          }
        } catch (err) {
          console.error("메시지 삭제 오류:", err);
          showToast("메시지 삭제 중 오류가 발생했습니다.");
        }
      }

      // 강조 메시지 모드 토글
      function toggleHighlightMode() {
        isHighlightMode = !isHighlightMode;

        if (isHighlightMode) {
          highlightMessageBtn.classList.remove(
            "bg-yellow-600",
            "hover:bg-yellow-700"
          );
          highlightMessageBtn.classList.add("bg-red-600", "hover:bg-red-700");
          highlightMessageBtn.textContent = "일반 메시지";
          highlightIndicator.classList.remove("hidden");
          chatMessageInput.classList.add("border-red-500");
          chatMessageInput.classList.remove("border-yellow-500");
        } else {
          highlightMessageBtn.classList.remove(
            "bg-red-600",
            "hover:bg-red-700"
          );
          highlightMessageBtn.classList.add(
            "bg-yellow-600",
            "hover:bg-yellow-700"
          );
          highlightMessageBtn.textContent = "강조 메시지";
          highlightIndicator.classList.add("hidden");
          chatMessageInput.classList.remove("border-red-500");
          chatMessageInput.classList.add("border-yellow-500");
        }
      }

      // 문자 수 업데이트
      function updateCharCount() {
        if (chatMessageInput && chatCharCount) {
          const count = chatMessageInput.value.length;
          chatCharCount.textContent = count;

          if (count > 450) {
            chatCharCount.style.color = "#ef4444"; // 빨간색
          } else if (count > 350) {
            chatCharCount.style.color = "#f59e0b"; // 주황색
          } else {
            chatCharCount.style.color = "#6b7280"; // 회색
          }
        }
      }

      // 채팅 알림 뱃지 업데이트
      function updateChatNotificationBadge() {
        if (chatNotificationBadge && chatNotificationCount) {
          if (unreadChatCount > 0 && !isChatOpen) {
            chatNotificationBadge.classList.remove("hidden");
            chatNotificationCount.textContent =
              unreadChatCount > 99 ? "99+" : unreadChatCount;
          } else {
            chatNotificationBadge.classList.add("hidden");
          }
        }
      }

      // 채팅 이벤트 리스너들
      if (chatFloatingButton) {
        chatFloatingButton.addEventListener("click", toggleChat);
      }

      if (closeChatButton) {
        closeChatButton.addEventListener("click", closeChatWindow);
      }

      if (sendChatButton) {
        sendChatButton.addEventListener("click", sendChatMessage);
      }

      if (highlightMessageBtn) {
        highlightMessageBtn.addEventListener("click", toggleHighlightMode);
      }

      if (chatMessageInput) {
        chatMessageInput.addEventListener("input", updateCharCount);
        chatMessageInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });
      }

      // 초기 문자 수 설정
      updateCharCount();

      // 채팅 관련 Socket 이벤트들 (Admin)

      // 새 채팅 메시지 수신
      socket.on("new_chat_message", (message) => {
        // 채팅창이 열려있으면 메시지 추가
        if (isChatOpen) {
          appendChatMessage(message);
          // 스크롤을 맨 아래로
          setTimeout(() => {
            if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          }, 100);
        } else {
          // 채팅창이 닫혀있으면 읽지 않은 메시지 카운트 증가
          unreadChatCount++;
          updateChatNotificationBadge();
        }
      });

      // 채팅 메시지 삭제 (자동 업데이트)
      socket.on("chat_message_deleted", (data) => {
        if (isChatOpen) {
          loadChatHistory();
        }
      });

      // 채팅 참여 신호
      socket.emit("join_chat");
    </script>
  </body>
</html>
