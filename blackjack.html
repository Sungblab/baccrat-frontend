<!DOCTYPE html>
<html lang="ko" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ë¸”ë™ì­ - ê³¨ë“  ì¹´ì§€ë…¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <!-- Phaser ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        font-family: "Noto Serif KR", serif;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      /* ê³¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .golden-btn {
        background: linear-gradient(to right, #b8860b, #daa520);
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .golden-btn:hover {
        background: linear-gradient(to right, #daa520, #ffd700);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
      }
      .golden-btn:disabled {
        background: #666;
        transform: none;
        cursor: not-allowed;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* ë™ê·¸ë¼ë¯¸ ë²„íŠ¼ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
      .golden-btn.rounded-full {
        border: 2px solid rgba(255, 215, 0, 0.3);
      }
      .golden-btn.rounded-full:hover {
        border-color: #ffd700;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
      }

      /* í—¤ë” ìŠ¤íƒ€ì¼ */
      .header-container {
        background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
        border-bottom: 1px solid #b8860b;
        box-shadow: 0 4px 6px -1px rgba(184, 134, 11, 0.1);
      }

      /* ê²Œì„ í…Œì´ë¸” */
      .game-table {
        background: radial-gradient(ellipse at center, #1a4b3a 0%, #0f2e21 70%);
        border: 2px solid #b8860b;
        border-radius: 16px;
        position: relative;
        min-height: 300px;
      }

      /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
      .card {
        width: 50px;
        height: 70px;
        border-radius: 6px;
        border: 1px solid #333;
        background: white;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .card.hidden {
        background: linear-gradient(45deg, #1e40af, #3b82f6);
        background-image: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.1) 2px,
          rgba(255, 255, 255, 0.1) 4px
        );
      }

      .card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
      }

      /* ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
      .card-dealing {
        animation: cardDeal 0.5s ease-out;
      }

      @keyframes cardDeal {
        from {
          transform: translateX(-100px) rotateY(180deg);
          opacity: 0;
        }
        to {
          transform: translateX(0) rotateY(0deg);
          opacity: 1;
        }
      }

      /* í•¸ë“œ ì˜ì—­ */
      .hand-area {
        min-height: 80px;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      /* ë² íŒ… ì¹© */
      .chip {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 0.65rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .chip:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .chip.active {
        transform: scale(1.15);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        border-color: #ffd700;
      }

      .chip[data-amount="1000"] {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }
      .chip[data-amount="5000"] {
        background: linear-gradient(135deg, #3498db, #2980b9);
      }
      .chip[data-amount="10000"] {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
      }
      .chip[data-amount="50000"] {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
      }
      .chip[data-amount="100000"] {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      /* ì”ì•¡ ë¶€ì¡± ì¹© ìŠ¤íƒ€ì¼ */
      .chip.insufficient-balance {
        background: linear-gradient(135deg, #666, #555) !important;
        opacity: 0.4 !important;
        cursor: not-allowed !important;
        transform: none !important;
      }

      .chip.insufficient-balance:hover {
        transform: none !important;
        box-shadow: none !important;
      }

      #clearBetBtn {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
      }
      #clearBetBtn:hover {
        background: linear-gradient(135deg, #7f8c8d, #95a5a6) !important;
      }

      /* ì•¡ì…˜ ë²„íŠ¼ */
      .action-btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: bold;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        font-size: 0.85rem;
      }

      .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-hit {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
      }
      .btn-stand {
        background: linear-gradient(45deg, #f44336, #da190b);
        color: white;
      }
      .btn-double {
        background: linear-gradient(45deg, #ff9800, #e68900);
        color: white;
      }
      .btn-split {
        background: linear-gradient(45deg, #9c27b0, #7b1fa2);
        color: white;
      }
      .btn-insurance {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
      }
      .btn-surrender {
        background: linear-gradient(45deg, #dc2626, #b91c1c);
        color: white;
      }

      /* ì ìˆ˜ í‘œì‹œ */
      .score-display {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #b8860b;
        border-radius: 12px;
        padding: 4px 12px;
        color: #ffd700;
        font-weight: bold;
        font-size: 0.9rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #1f2937;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        border-left: 4px solid #10b981;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.3s ease;
      }

      .notification.show {
        opacity: 1;
        transform: translateX(0);
      }

      .notification.error {
        border-left-color: #ef4444;
      }
      .notification.success {
        border-left-color: #10b981;
      }
      .notification.warning {
        border-left-color: #f59e0b;
      }

      /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #b8860b;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ë”œëŸ¬ í„´ í‘œì‹œ */
      .dealer-turn-indicator {
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      /* ì”ì•¡ í‘œì‹œ ì• ë‹ˆë©”ì´ì…˜ (ë°”ì¹´ë¼ì™€ ë™ì¼í•œ ê³ ê¸‰ íš¨ê³¼) */
      #balance {
        transition: all 0.3s ease-in-out;
        text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        transform-origin: center;
      }

      #balance:hover {
        text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
      }

      /* ëª¨ë°”ì¼ ìµœì í™” */
      @media (max-width: 640px) {
        .card {
          width: 45px;
          height: 63px;
        }
        .chip {
          width: 36px;
          height: 36px;
          font-size: 0.6rem;
        }
        .action-btn {
          font-size: 0.75rem;
          padding: 6px 12px;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
        .golden-btn.rounded-full {
          width: 48px !important;
          height: 48px !important;
          font-size: 0.6rem;
        }

        .golden-btn.rounded-full i {
          font-size: 0.7rem !important;
        }

        /* ë²„íŠ¼ ê°„ê²© ì¡°ì • */
        .flex.space-x-2 {
          gap: 4px;
        }
      }

      /* ê²Œì„ ê²°ê³¼ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .text-shadow-lg {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      #gameResultModal .bg-gradient-to-br {
        animation: modalBounce 0.3s ease-out;
      }

      @keyframes modalBounce {
        0% {
          transform: scale(0.3) rotate(-10deg);
          opacity: 0;
        }
        50% {
          transform: scale(1.2) rotate(5deg);
        }
        100% {
          transform: scale(1.1) rotate(0deg);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <!-- í—¤ë” -->
    <header class="header-container p-2">
      <div class="flex justify-between items-center">
        <button
          id="logout"
          class="golden-btn px-3 py-1.5 rounded text-white text-sm"
        >
          <i class="fas fa-sign-out-alt mr-1"></i>ì¢…ë£Œí•˜ê¸°
        </button>
        <div class="flex items-center">
          <span class="text-sm text-gray-400 mr-2">ì”ì•¡:</span>
          <span id="balance" class="text-lg font-bold text-yellow-400">â‚©0</span>
        </div>
      </div>
    </header>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <main class="container mx-auto p-3 max-w-5xl">
      <!-- Phaser ê²Œì„ í…Œì´ë¸” -->
      <div class="mb-4">
        <div
          id="blackjackGameContainer"
          class="w-full h-64 sm:h-72 md:h-80 lg:h-96 rounded-lg shadow-xl overflow-hidden mx-auto"
          style="max-width: 1000px"
        >
          <!-- Phaser ê²Œì„ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
        </div>

        <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ (Phaser ê²Œì„ ì•„ë˜) -->
        <div id="gameStatusDisplay" class="text-center mt-4 hidden">
          <div id="dealerStatus" class="text-gray-400 mb-2">
            <!-- ë”œëŸ¬ ìƒíƒœ ë©”ì‹œì§€ -->
          </div>
        </div>
      </div>

      <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
      <div class="bg-gray-800 p-3 rounded-lg border border-yellow-600 mb-4">
        <div class="flex justify-between items-center">
          <div class="text-sm text-gray-400">ê²Œì„ ìƒíƒœ</div>
          <div id="gameStatus" class="text-base font-bold text-blue-400">
            ëŒ€ê¸° ì¤‘
          </div>
        </div>
        <div class="flex justify-between items-center mt-1">
          <div class="text-sm text-gray-400">í˜„ì¬ ë² íŒ…ì•¡</div>
          <div id="currentBet" class="text-base font-bold text-yellow-400">
            â‚©0
          </div>
        </div>
      </div>

      <!-- ë² íŒ… ì˜ì—­ (ì´ˆê¸° í‘œì‹œ) -->
      <div
        id="bettingArea"
        class="bg-gray-800 p-4 rounded-lg border border-yellow-600"
      >
        <div class="flex flex-col space-y-4">
          <!-- ì¹© ì„ íƒ -->
          <div>
            <h3 class="text-base font-bold text-yellow-500 mb-3 text-center">
              <i class="fas fa-coins mr-2"></i>ë² íŒ… ê¸ˆì•¡
            </h3>
            <div class="flex justify-center space-x-2">
              <div class="chip" data-amount="1000">1k</div>
              <div class="chip" data-amount="5000">5k</div>
              <div class="chip" data-amount="10000">10k</div>
              <div class="chip" data-amount="50000">50k</div>
              <div class="chip" data-amount="100000">100k</div>
              <button
                class="chip bg-red-600 hover:bg-red-500 text-white"
                id="clearBetBtn"
              >
                ì´ˆê¸°í™”
              </button>
            </div>
          </div>

          <!-- ê²Œì„ ë²„íŠ¼ë“¤ -->
          <div class="flex flex-col justify-center">
            <!-- ëª¨ë“  ê²Œì„ ë²„íŠ¼ë“¤ì„ í•œ ì¤„ì— ë°°ì¹˜ -->
            <div
              class="flex items-center justify-center space-x-2 flex-wrap gap-y-2"
            >
              <!-- ê¸°ë³¸ ê²Œì„ ë²„íŠ¼ë“¤ -->
              <button
                id="placeBetBtn"
                class="golden-btn w-14 h-14 rounded-full font-bold text-sm flex items-center justify-center"
              >
                <span id="betBtnText">ë² íŒ…</span>
              </button>

              <button
                id="startGameBtn"
                class="golden-btn w-14 h-14 rounded-full font-bold text-sm flex items-center justify-center"
                disabled
              >
                <span>ë”œ</span>
              </button>

              <!-- ìƒˆê²Œì„ ë²„íŠ¼ë§Œ ìœ ì§€ -->
              <button
                id="newGameBtn"
                class="golden-btn w-14 h-14 rounded-full font-bold text-sm flex items-center justify-center hidden"
              >
                <span>ìƒˆê²Œì„</span>
              </button>
              <button
                id="endGameBtn"
                class="bg-red-600 hover:bg-red-500 w-14 h-14 rounded-full font-bold text-sm flex items-center justify-center hidden"
              >
                <span>ì¢…ë£Œ</span>
              </button>
            </div>

            <!-- ê²Œì„ ì•¡ì…˜ ë²„íŠ¼ë“¤ (ê²Œì„ ì¤‘ í‘œì‹œ) - ë³„ë„ ì¤„ -->
            <div id="gameActionButtons" class="hidden mt-3">
              <div class="flex items-center justify-center space-x-2">
                <button
                  id="hitBtn"
                  class="golden-btn w-12 h-12 rounded-full font-bold text-xs flex items-center justify-center"
                  disabled
                >
                  <span>íˆíŠ¸</span>
                </button>
                <button
                  id="standBtn"
                  class="golden-btn w-12 h-12 rounded-full font-bold text-xs flex items-center justify-center"
                  disabled
                >
                  <span>ìŠ¤íƒ ë“œ</span>
                </button>
                <button
                  id="doubleBtn"
                  class="bg-orange-600 hover:bg-orange-500 w-12 h-12 rounded-full font-bold text-xs flex flex-col items-center justify-center leading-tight"
                  disabled
                  title="ë² íŒ…ì•¡ì„ 2ë°°ë¡œ ëŠ˜ë¦¬ê³  ì¹´ë“œ 1ì¥ë§Œ ë°›ê³  ìë™ ìŠ¤íƒ ë“œí•©ë‹ˆë‹¤"
                >
                  <span class="text-[10px]">ë”ë¸”</span>
                  <span class="text-[8px] opacity-80">2ë°°+1ì¥</span>
                </button>
                <button
                  id="splitBtn"
                  class="bg-purple-600 hover:bg-purple-500 w-12 h-12 rounded-full font-bold text-xs flex items-center justify-center hidden"
                  disabled
                >
                  <span>ìŠ¤í”Œë¦¿</span>
                </button>
                <button
                  id="insuranceBtn"
                  class="bg-blue-600 hover:bg-blue-500 w-12 h-12 rounded-full font-bold text-xs flex flex-col items-center justify-center hidden"
                  disabled
                  title="ë”œëŸ¬ê°€ Aë¥¼ ë³´ì—¬ì¤„ ë•Œ ë² íŒ…ì•¡ì˜ ì ˆë°˜ìœ¼ë¡œ ë³´í—˜ì„ ê±¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
                >
                  <span class="text-[10px]">ë³´í—˜</span>
                  <span class="text-[8px] opacity-80">ì ˆë°˜</span>
                </button>
                <button
                  id="surrenderBtn"
                  class="bg-red-600 hover:bg-red-500 w-12 h-12 rounded-full font-bold text-xs flex flex-col items-center justify-center hidden"
                  disabled
                  title="ë² íŒ…ì•¡ì˜ ì ˆë°˜ì„ ëŒë ¤ë°›ê³  ê²Œì„ì„ í¬ê¸°í•©ë‹ˆë‹¤"
                >
                  <span class="text-[10px]">ì„œë Œë”</span>
                  <span class="text-[8px] opacity-80">í•­ë³µ</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²Œì„ ê²°ê³¼ ì˜ì—­ -->
      <div
        id="gameResult"
        class="mt-4 bg-gray-800 p-4 rounded-lg border border-yellow-600 hidden"
      >
        <h3 class="text-base font-bold text-yellow-500 mb-3">
          <i class="fas fa-trophy mr-2"></i>ê²Œì„ ê²°ê³¼
        </h3>
        <div id="resultContent" class="space-y-2">
          <!-- ê²Œì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </main>

    <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
    <div id="notification" class="notification">
      ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-gray-800 p-6 rounded-lg border border-yellow-600 text-center"
      >
        <div class="loading-spinner mx-auto mb-4"></div>
        <div class="text-white">ì²˜ë¦¬ ì¤‘...</div>
      </div>
    </div>

    <!-- ê²Œì„ ê²°ê³¼ ëª¨ë‹¬ -->
    <div
      id="gameResultModal"
      class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-gradient-to-br from-yellow-600 to-yellow-800 p-8 rounded-2xl border-4 border-yellow-400 text-center shadow-2xl transform scale-110"
      >
        <div
          id="modalResultText"
          class="text-4xl font-bold text-white mb-4 text-shadow-lg"
        >
          ì´ê²¼ìŠµë‹ˆë‹¤!
        </div>
        <div
          id="modalPayoutText"
          class="text-2xl text-yellow-200 font-semibold"
        >
          +â‚©0
        </div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let socket;
      let token = localStorage.getItem("token");
      let gameSession = null;
      let selectedChipAmount = 1000;
      let currentBetAmount = 0; // í˜„ì¬ ëˆ„ì  ë² íŒ… ê¸ˆì•¡
      let isGameActive = false;
      let isDealerTurn = false;

      // Phaser ê´€ë ¨ ë³€ìˆ˜
      let blackjackGame = null; // Phaser ê²Œì„ ì¸ìŠ¤í„´ìŠ¤
      let blackjackScene = null; // Phaser Scene ì¸ìŠ¤í„´ìŠ¤

      // ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        if (!token) {
          window.location.href = "index.html";
          return;
        }

        initializeSocket();
        initializeEventListeners();
        updateChipSelection();
        startBlackjackGame(); // Phaser ê²Œì„ ì‹œì‘
      });

      // ì†Œì¼“ ì´ˆê¸°í™”
      function initializeSocket() {
        socket = io(
          "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app"
        );

        socket.on("connect", () => {
          socket.emit("authenticate", token);
        });

        socket.on("disconnect", () => {
          showNotification("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.", "error");
        });

        // ì¸ì¦ ê²°ê³¼
        socket.on("authentication_result", (data) => {
          if (data.success) {
            updateBalance(data.user.balance);
            updateGameSession(data.session);
            showNotification("ê²Œì„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤.", "success");

            // ì¸ì¦ ì„±ê³µ í›„ ìµœì‹  ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
            setTimeout(() => {
              fetchUserInfo(true); // ì¦‰ì‹œ ì‹¤í–‰
            }, 500);
          } else {
            showNotification("ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            setTimeout(() => (window.location.href = "index.html"), 2000);
          }
        });

        // ë² íŒ… ê²°ê³¼ (ë°”ì¹´ë¼ì™€ ë™ì¼í•œ ì‹¤ì‹œê°„ ì”ì•¡ ë°˜ì˜)
        socket.on("bet_result", (data) => {
          hideLoading();
          if (data.success) {
            showNotification(data.message, "success");
            updateGameSession(data.session);

            // ë² íŒ… ì„±ê³µ ì‹œ ëˆ„ì  ë² íŒ…ì•¡ ì´ˆê¸°í™”
            currentBetAmount = 0;

            // ë² íŒ…ì´ ì„±ê³µí•˜ë©´ ê²Œì„ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
            const startBtn = document.getElementById("startGameBtn");
            startBtn.disabled = false;

            // ë² íŒ… ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
            const placeBetBtn = document.getElementById("placeBetBtn");
            const betBtnText = document.getElementById("betBtnText");
            placeBetBtn.disabled = true;
            betBtnText.textContent = "ë² íŒ… ì™„ë£Œ";

            // ë² íŒ… ì„±ê³µ í›„ ì”ì•¡ ì¦‰ì‹œ ë™ê¸°í™” (ë°”ì¹´ë¼ì™€ ë™ì¼)
            fetchUserInfo(true);
          } else {
            showNotification(data.message, "error");
          }
        });

        // ê´€ë¦¬ì ì”ì•¡ ì¡°ì • ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ ì²˜ë¦¬)
        socket.on("balance_updated", (data) => {
          // ë©”ì¸ ì”ì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì•Œë¦¼ ì—†ìŒ)
          updateBalance(data.newBalance || data.balance);
        });

        // ì¶©ì „/í™˜ì „ ì²˜ë¦¬ ì•Œë¦¼ (ë°”ì¹´ë¼ì™€ ë™ì¼)
        socket.on("deposit_request_processed", (data) => {
          if (data.status === "approved") {
            showNotification(
              `ì¶©ì „ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! +${data.amount.toLocaleString()}ì›`,
              "success"
            );
            fetchUserInfo(); // ì”ì•¡ ìƒˆë¡œê³ ì¹¨
          } else {
            showNotification(
              `ì¶©ì „ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤. (${data.amount.toLocaleString()}ì›)`,
              "error"
            );
          }
        });

        socket.on("exchange_request_processed", (data) => {
          if (data.status === "approved") {
            showNotification(
              `í™˜ì „ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ì‹¤ìˆ˜ë ¹ì•¡: ${data.actualAmount.toLocaleString()}ì›`,
              "success"
            );
            fetchUserInfo(); // ì”ì•¡ ìƒˆë¡œê³ ì¹¨
          } else {
            showNotification(
              `í™˜ì „ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹ ì²­ì•¡: ${data.requestAmount.toLocaleString()}ì›)`,
              "error"
            );
          }
        });

        // ì†¡ê¸ˆ ê´€ë ¨ ì‹¤ì‹œê°„ ì•Œë¦¼ (ë°”ì¹´ë¼ì™€ ë™ì¼)
        socket.on("money_received", (data) => {
          showNotification(
            `${
              data.fromUsername
            }ë‹˜ìœ¼ë¡œë¶€í„° ${data.amount.toLocaleString()}ì›ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!`,
            "success"
          );
          fetchUserInfo();
        });

        socket.on("money_sent", (data) => {
          showNotification(
            `${
              data.toUsername
            }ë‹˜ì—ê²Œ ${data.amount.toLocaleString()}ì›ì„ ì†¡ê¸ˆí–ˆìŠµë‹ˆë‹¤. (ìˆ˜ìˆ˜ë£Œ: ${data.fee.toLocaleString()}ì›)`,
            "info"
          );
          fetchUserInfo();
        });

        // ì‹¤ì‹œê°„ ì”ì•¡ ë™ê¸°í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ì´ë²¤íŠ¸ë“¤
        socket.on("update_coins", () => {
          fetchUserInfo();
        });

        // ì„¸ì…˜ ì—…ë°ì´íŠ¸
        socket.on("session_updated", (data) => {
          updateGameSession(data);
        });

        // ê²Œì„ ì‹œì‘ë¨
        socket.on("game_started", (data) => {
          if (data.success) {
            updateGameSession(data.session);

            // Phaser Sceneì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            const waitForScene = () => {
              if (blackjackScene && blackjackScene.sys.isActive()) {
                renderInitialCards();

                // ë¸”ë™ì­ ì²´í¬ê°€ í•„ìš”í•œ ê²½ìš° (ë”œëŸ¬ ë¸”ë™ì­ ìš°ì„  í™•ì¸)
                if (data.needsBlackjackCheck) {
                  setTimeout(() => {
                    socket.emit("check_blackjack");
                  }, 1500); // ì¹´ë“œ ë”œë§ ì• ë‹ˆë©”ì´ì…˜ í›„
                }

                // ë”œëŸ¬ ì—…ì¹´ë“œ ì²´í¬ëŠ” ì œê±° - í”Œë ˆì´ì–´ê°€ í–‰ë™ì„ ì™„ë£Œí•œ í›„ì—ë§Œ ë”œëŸ¬ ë¸”ë™ì­ ì²´í¬
              } else {
                // Sceneì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ 100ms í›„ ë‹¤ì‹œ ì‹œë„
                setTimeout(waitForScene, 100);
              }
            };

            waitForScene();
          }
        });

        // ë¸”ë™ì­ ì²´í¬ ê²°ê³¼
        socket.on("blackjack_check_result", (data) => {
          if (data.success) {
            if (data.isBlackjack && data.needsDealerCheck) {
              // í”Œë ˆì´ì–´ ë¸”ë™ì­ - ë”œëŸ¬ í„´ìœ¼ë¡œ ì§„í–‰
              showNotification(
                "í”Œë ˆì´ì–´ ë¸”ë™ì­! ë”œëŸ¬ ì¹´ë“œë¥¼ í™•ì¸í•©ë‹ˆë‹¤...",
                "success"
              );
              disableGameActions();
              // ë”œëŸ¬ í„´ì€ ì„œë²„ì—ì„œ ìë™ìœ¼ë¡œ ì‹œì‘ë¨
            } else if (!data.isBlackjack) {
              // ì •ìƒ ê²Œì„ ì§„í–‰
              enableGameActions();
            }
          }
        });

        // ë”œëŸ¬ ë¸”ë™ì­ ë°œìƒ
        socket.on("dealer_blackjack", (data) => {
          // ë”œëŸ¬ í™€ ì¹´ë“œ ì¦‰ì‹œ ê³µê°œ
          if (data.holeCard) {
            revealDealerHiddenCard(data.holeCard);
            updateDealerScore(21);
          }

          // ë”œëŸ¬ ë¸”ë™ì­ ì•Œë¦¼ê³¼ ì‹œê°ì  íš¨ê³¼
          showNotification("ë”œëŸ¬ ë¸”ë™ì­! ğŸƒ ë”œëŸ¬ ìŠ¹ë¦¬!", "info");

          // Phaserì—ì„œ íŠ¹ë³„í•œ ë”œëŸ¬ ë¸”ë™ì­ íš¨ê³¼ í‘œì‹œ
          if (blackjackScene) {
            blackjackScene.showGameResult("ë”œëŸ¬ ë¸”ë™ì­!", "#FFD700");
          }

          // ê²Œì„ ì•¡ì…˜ ì¦‰ì‹œ ë¹„í™œì„±í™”
          disableGameActions();

          // ê²Œì„ ì¦‰ì‹œ ì¢…ë£Œ
          setTimeout(() => {
            handleGameEnd(data.session, data.results);
          }, 1500);
        });

        // í”Œë ˆì´ì–´ ë¸”ë™ì­ ìŠ¹ë¦¬
        socket.on("player_blackjack_win", (data) => {
          console.log("í”Œë ˆì´ì–´ ë¸”ë™ì­ ìŠ¹ë¦¬:", data);

          // í”Œë ˆì´ì–´ ë¸”ë™ì­ ìŠ¹ë¦¬ ì•Œë¦¼
          showNotification("í”Œë ˆì´ì–´ ë¸”ë™ì­! ğŸƒ ìŠ¹ë¦¬!", "success");

          // Phaserì—ì„œ í”Œë ˆì´ì–´ ë¸”ë™ì­ íš¨ê³¼ í‘œì‹œ
          if (blackjackScene) {
            blackjackScene.showGameResult("í”Œë ˆì´ì–´ ë¸”ë™ì­!", "#FFD700");
          }

          // ê²Œì„ ì•¡ì…˜ ì¦‰ì‹œ ë¹„í™œì„±í™”
          disableGameActions();

          // ê²Œì„ ì„¸ì…˜ ì—…ë°ì´íŠ¸
          updateGameSession(data.session);

          // ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬
          setTimeout(() => {
            // ë¸”ë™ì­ ê²°ê³¼ë¡œ ê²Œì„ ì¢…ë£Œ
            const results = [
              {
                result: "blackjack",
                payout: data.payout,
              },
            ];
            handleGameEnd(data.session, results);
          }, 1500);
        });

        // íˆíŠ¸ ê²°ê³¼
        socket.on("hit_result", (data) => {
          console.log("íˆíŠ¸ ê²°ê³¼ ìˆ˜ì‹ :", data);

          if (data.success) {
            // ìƒˆ ì¹´ë“œê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¹´ë“œ ì¶”ê°€ (ì‹¤ì œ íˆíŠ¸ ì‹œì—ë§Œ)
            if (data.newCard && data.newCard.value && data.newCard.suit) {
              if (data.isSplit && blackjackScene && blackjackScene.isSplit) {
                // ìŠ¤í”Œë¦¿ ìƒíƒœì—ì„œëŠ” í˜„ì¬ í•¸ë“œì— ì¹´ë“œ ì¶”ê°€
                const currentHandIndex = data.currentHandIndex || 0;
                blackjackScene.addSplitCard(
                  currentHandIndex,
                  data.newCard,
                  currentHandIndex === 0
                    ? blackjackScene.cameras.main.width / 2 - 120
                    : blackjackScene.cameras.main.width / 2 + 120,
                  blackjackScene.cameras.main.height * 0.75,
                  blackjackScene.splitHandSprites[currentHandIndex].length
                );
              } else {
                addCardToHand("player", data.newCard);
              }
            }
            // newCardê°€ ì—†ëŠ” ê²½ìš°ëŠ” ì •ìƒ (ìë™ ìŠ¤íƒ ë“œ ë“±)

            // ê²Œì„ ì„¸ì…˜ ì—…ë°ì´íŠ¸
            updateGameSession(data.session);

            // ìŠ¤í”Œë¦¿ ìƒíƒœì¸ ê²½ìš° í•¸ë“œ ë°ì´í„° ë™ê¸°í™”
            if (data.isSplit && blackjackScene && blackjackScene.isSplit) {
              blackjackScene.syncSplitHandsWithSession(data.session);
            }

            updatePlayerScore(data.handValue);

            // ë”ë¸”ë‹¤ìš´ í›„ íˆíŠ¸ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
            if (data.wasDoubled) {
              showNotification(
                "ë”ë¸”ë‹¤ìš´ìœ¼ë¡œ ì¹´ë“œ 1ì¥ ë°›ì•˜ìŠµë‹ˆë‹¤! ë”œëŸ¬ í„´ ì‹œì‘!",
                "success"
              );

              // ëª¨ë“  ì•¡ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
              disableGameActions();

              // ê²Œì„ ìƒíƒœì— ë”°ë¼ ì²˜ë¦¬
              if (data.isBust) {
                if (data.isSplit && !data.allHandsComplete) {
                  showNotification(
                    "ë²„ìŠ¤íŠ¸! ë‹¤ìŒ í•¸ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.",
                    "warning"
                  );
                } else {
                  handleGameEnd(data.session);
                }
              } else {
                // ë”œëŸ¬ í„´ ê°•ì œ ì‹œì‘
                setTimeout(() => {
                  updateGameSession(data.session);

                  // ë”œëŸ¬ í„´ ìƒíƒœë¡œ ê°•ì œ ë³€ê²½ ë° ì‹œì‘
                  if (gameSession) {
                    gameSession.status = "dealer-turn";
                    isDealerTurn = true;
                    updateGameStatus("ë”œëŸ¬ í„´");
                    showDealerTurnIndicator();

                    // ë”œëŸ¬ í„´ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ìš”ì²­
                    socket.emit("start_dealer_turn");
                  }
                }, 800);
              }
            } else {
              // ì¼ë°˜ íˆíŠ¸
              if (data.isBust) {
                if (data.isSplit && !data.allHandsComplete) {
                  showNotification(
                    "ë²„ìŠ¤íŠ¸! ë‹¤ìŒ í•¸ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.",
                    "warning"
                  );
                } else {
                  handleGameEnd(data.session);
                }
              } else if (data.isSplit && data.nextHandIndex !== undefined) {
                showNotification(
                  `í•¸ë“œ ${data.nextHandIndex + 1}ë²ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`,
                  "info"
                );
              } else {
                showNotification("ì¹´ë“œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.", "info");
              }
            }
          }
        });

        // ìŠ¤íƒ ë“œ ê²°ê³¼
        socket.on("stand_result", (data) => {
          if (data.success) {
            // ê²Œì„ ì„¸ì…˜ ì—…ë°ì´íŠ¸
            updateGameSession(data.session);

            // ìŠ¤í”Œë¦¿ ìƒíƒœì¸ ê²½ìš° í•¸ë“œ ë°ì´í„° ë™ê¸°í™”
            if (data.isSplit && blackjackScene && blackjackScene.isSplit) {
              blackjackScene.syncSplitHandsWithSession(data.session);
            }

            // ìë™ ìŠ¤íƒ ë“œì¸ ê²½ìš° íŠ¹ë³„ ë©”ì‹œì§€
            if (data.autoStand) {
              showNotification(
                "21! ìë™ ìŠ¤íƒ ë“œí•˜ì—¬ ë”œëŸ¬ í„´ì„ ì§„í–‰í•©ë‹ˆë‹¤.",
                "success"
              );
              disableGameActions();
            } else if (data.isSplit && data.nextHandIndex !== undefined) {
              showNotification(
                `í•¸ë“œ ${data.nextHandIndex + 1}ë²ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`,
                "info"
              );
              // ë‹¤ìŒ í•¸ë“œë¡œ ì´ë™í•˜ëŠ” ê²½ìš° ì•¡ì…˜ ë²„íŠ¼ ìœ ì§€
            } else {
              disableGameActions();
            }
          }
        });

        // ë”œëŸ¬ í„´ ì‹œì‘
        socket.on("dealer_turn_started", (data) => {
          isDealerTurn = true;
          updateGameStatus("ë”œëŸ¬ í„´");
          showDealerTurnIndicator();
        });

        // ë”œëŸ¬ ìˆ¨ê²¨ì§„ ì¹´ë“œ ê³µê°œ
        socket.on("dealer_hidden_card_revealed", (data) => {
          revealDealerHiddenCard(data.hiddenCard);
          updateDealerScore(data.dealerValue);

          console.log(
            "ë”œëŸ¬ í™€ ì¹´ë“œ ê³µê°œ:",
            data.hiddenCard,
            "ë”œëŸ¬ ì ìˆ˜:",
            data.dealerValue
          );
        });

        // ë”œëŸ¬ ì¹´ë“œ ì¶”ê°€
        socket.on("dealer_card_dealt", (data) => {
          console.log("ë”œëŸ¬ ì¹´ë“œ ì¶”ê°€ ìˆ˜ì‹ :", data);

          // ì¹´ë“œ ë°ì´í„° ê²€ì¦
          if (data.newCard && data.newCard.value && data.newCard.suit) {
            addCardToHand("dealer", data.newCard);
          } else {
            console.error(
              "ë”œëŸ¬ ì¹´ë“œì—ì„œ ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ë°ì´í„°:",
              data.newCard
            );
            console.error("ì „ì²´ ë”œëŸ¬ ì¹´ë“œ ë°ì´í„°:", JSON.stringify(data));
          }

          updateDealerScore(data.dealerValue);
        });

        // ë”œëŸ¬ í„´ ì™„ë£Œ
        socket.on("dealer_turn_completed", (data) => {
          isDealerTurn = false;
          hideDealerTurnIndicator();
        });

        // ë”ë¸”ë‹¤ìš´ ê²°ê³¼
        socket.on("double_result", (data) => {
          if (data.success) {
            updateGameSession(data.session);

            // ë² íŒ… í‘œì‹œ ì—…ë°ì´íŠ¸ (2ë°°ëœ ë² íŒ…ì•¡ ê°•ì¡°)
            const currentBetElement = document.getElementById("currentBet");
            if (currentBetElement) {
              currentBetElement.innerHTML = `â‚©${data.session.currentBet.toLocaleString()} <span class="text-orange-400 text-sm">(ë”ë¸”ë‹¤ìš´)</span>`;
            }

            showNotification(
              "ë”ë¸”ë‹¤ìš´! ë² íŒ…ì•¡ 2ë°°. ì´ì œ ì¹´ë“œ 1ì¥ë§Œ ë” ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
              "info"
            );

            // ë”ë¸”ë‹¤ìš´ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”, íˆíŠ¸ì™€ ìŠ¤íƒ ë“œëŠ” ìœ ì§€
            document.getElementById("doubleBtn").disabled = true;
            document.getElementById("splitBtn").disabled = true;
            document.getElementById("insuranceBtn").disabled = true;

            // 0.5ì´ˆ í›„ ìë™ìœ¼ë¡œ íˆíŠ¸ ë²„íŠ¼ í´ë¦­
            setTimeout(() => {
              showNotification("ìë™ìœ¼ë¡œ ì¹´ë“œ 1ì¥ì„ ë°›ìŠµë‹ˆë‹¤...", "info");
              socket.emit("hit"); // ìë™ íˆíŠ¸
            }, 1000);
          } else {
            showNotification("ë”ë¸”ë‹¤ìš´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
          }
        });

        // ìŠ¤í”Œë¦¿ ê²°ê³¼
        socket.on("split_result", (data) => {
          if (data.success) {
            updateGameSession(data.session);

            // ë² íŒ… í‘œì‹œ ì—…ë°ì´íŠ¸ (2ë°°ëœ ë² íŒ…ì•¡ í‘œì‹œ)
            const currentBetElement = document.getElementById("currentBet");
            if (currentBetElement) {
              currentBetElement.innerHTML = `â‚©${data.session.currentBet.toLocaleString()} <span class="text-purple-400 text-sm">(ìŠ¤í”Œë¦¿)</span>`;
            }

            showNotification("ìŠ¤í”Œë¦¿! ì²« ë²ˆì§¸ í•¸ë“œë¶€í„° í”Œë ˆì´í•©ë‹ˆë‹¤.", "info");

            // Phaserì—ì„œ ìŠ¤í”Œë¦¿ ì‹œê°í™”
            if (blackjackScene) {
              blackjackScene.handleSplit(data.session);
            }

            // ìŠ¤í”Œë¦¿ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById("splitBtn").disabled = true;
            document.getElementById("doubleBtn").disabled = true;
            document.getElementById("insuranceBtn").disabled = true;
          } else {
            showNotification("ìŠ¤í”Œë¦¿ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
          }
        });

        // ìŠ¤í”Œë¦¿ ë‹¤ìŒ í•¸ë“œë¡œ ì´ë™
        socket.on("split_next_hand", (data) => {
          updateGameSession(data.session);

          showNotification(
            `í•¸ë“œ ${data.nextHandIndex + 1}ë²ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`,
            "info"
          );

          // Phaserì—ì„œ ìŠ¤í”Œë¦¿ í•¸ë“œ ë™ê¸°í™” ë° ë‹¤ìŒ í•¸ë“œ ê°•ì¡°
          if (blackjackScene && blackjackScene.isSplit) {
            blackjackScene.syncSplitHandsWithSession(data.session);
            blackjackScene.highlightCurrentHand(data.nextHandIndex);
          }

          // ê²Œì„ ì•¡ì…˜ ë²„íŠ¼ë“¤ ë‹¤ì‹œ í™œì„±í™”
          enableGameActions();
        });

        // ë³´í—˜ ê²°ê³¼
        socket.on("insurance_result", (data) => {
          if (data.success) {
            updateGameSession(data.session);
            showNotification(
              `ë³´í—˜ì— ê°€ì…í–ˆìŠµë‹ˆë‹¤. (${data.insuranceAmount.toLocaleString()}ì›)`,
              "info"
            );

            // ë³´í—˜ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById("insuranceBtn").disabled = true;

            // ì”ì•¡ ì—…ë°ì´íŠ¸
            fetchUserInfo(true);
          } else {
            showNotification("ë³´í—˜ ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
          }
        });

        // ì„œë Œë” ê²°ê³¼
        socket.on("surrender_result", (data) => {
          if (data.success) {
            updateGameSession(data.session);
            showNotification(
              `ì„œë Œë”í–ˆìŠµë‹ˆë‹¤. ${data.surrenderAmount.toLocaleString()}ì›ì´ ë°˜í™˜ë©ë‹ˆë‹¤.`,
              "warning"
            );

            // ëª¨ë“  ì•¡ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
            disableGameActions();

            // ì”ì•¡ ì—…ë°ì´íŠ¸
            fetchUserInfo(true);

            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            isGameActive = false;
            isDealerTurn = false;
            updateGameStatus("ì„œë Œë”");

            // ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬
            setTimeout(() => {
              handleGameEnd(data.session, [
                {
                  result: "surrender",
                  payout: data.surrenderAmount,
                  lossAmount: data.lossAmount,
                },
              ]);

              // ì„œë Œë” í›„ ê²Œì„ ì™„ì „ ì´ˆê¸°í™”
              setTimeout(() => {
                resetGameAfterSurrender();
              }, 2000);
            }, 1500);
          } else {
            showNotification("ì„œë Œë”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
          }
        });

        // ê²Œì„ ì™„ë£Œ
        socket.on("game_finished", (data) => {
          // ë³´í—˜ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
          if (data.insuranceResult) {
            const insuranceMsg = data.insuranceResult.won
              ? `ë³´í—˜ ìŠ¹ë¦¬! +${data.insuranceResult.payout.toLocaleString()}ì›`
              : `ë³´í—˜ íŒ¨ë°°! -${data.insuranceResult.amount.toLocaleString()}ì›`;

            showNotification(
              insuranceMsg,
              data.insuranceResult.won ? "success" : "error"
            );
          }

          handleGameEnd(data.session, data.results);

          // ê²Œì„ ì™„ë£Œ í›„ 3ì´ˆ ë’¤ì— ë² íŒ… ê°€ëŠ¥ ìƒíƒœë¡œ ë³€ê²½
          setTimeout(() => {
            if (gameSession && gameSession.status === "waiting") {
              updateBetDisplay(); // ë² íŒ… ë²„íŠ¼ ìƒíƒœ ì¬í™•ì¸
            }
          }, 3000);
        });

        // ìƒˆ ê²Œì„ ê²°ê³¼ (ë°”ì¹´ë¼ì™€ ë™ì¼í•œ ì‹¤ì‹œê°„ ì”ì•¡ ë°˜ì˜)
        socket.on("new_game_result", (data) => {
          if (data.success) {
            updateGameSession(data.session);

            // ìƒˆ ê²Œì„ ì‹œì‘ ì‹œ ì”ì•¡ ë™ê¸°í™” (ë°”ì¹´ë¼ì™€ ë™ì¼)
            fetchUserInfo(true);
          } else {
            showNotification(
              data.message || "ìƒˆ ê²Œì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
              "error"
            );
          }
        });

        // ì—ëŸ¬ ì²˜ë¦¬
        socket.on("error", (message) => {
          hideLoading();

          // ë¶ˆí•„ìš”í•œ ì•Œë¦¼ ë©”ì‹œì§€ë“¤ í•„í„°ë§
          const filteredMessages = [
            "í˜„ì¬ ë² íŒ…ì´ ì§„í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
            "í˜„ì¬ ë² íŒ…ì´ ì§„í–‰ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
            "ë”œëŸ¬ í„´ì´ ì‹œì‘ë©ë‹ˆë‹¤.",
            "ìƒˆ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë² íŒ…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.",
          ];

          if (!filteredMessages.includes(message)) {
            showNotification(message, "error");
          }
        });
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
      function initializeEventListeners() {
        // ë‚˜ê°€ê¸° - ê²Œì„ ì¢…ë£Œ
        document.getElementById("logout").addEventListener("click", () => {
          endGame();
        });

        // ì¹© ì„ íƒ - ëˆ„ì  ë°©ì‹ (ì”ì•¡ ì²´í¬ í¬í•¨)
        document.querySelectorAll(".chip[data-amount]").forEach((chip) => {
          chip.addEventListener("click", (e) => {
            // ì”ì•¡ ë¶€ì¡±ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ì¹©ì€ í´ë¦­ ë¬´ì‹œ
            if (chip.classList.contains("insufficient-balance")) {
              const currentBalance = getCurrentBalance();
              const chipAmount = parseInt(e.target.dataset.amount);
              showNotification(
                `ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${(
                  currentBetAmount + chipAmount
                ).toLocaleString()}ì›, ë³´ìœ : ${currentBalance.toLocaleString()}ì›)`,
                "warning"
              );
              return;
            }

            const chipAmount = parseInt(e.target.dataset.amount);
            const currentBalance = getCurrentBalance();

            // ì”ì•¡ ì²´í¬
            if (currentBetAmount + chipAmount > currentBalance) {
              showNotification(
                `ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${(
                  currentBetAmount + chipAmount
                ).toLocaleString()}ì›, ë³´ìœ : ${currentBalance.toLocaleString()}ì›)`,
                "warning"
              );
              return;
            }

            currentBetAmount += chipAmount;
            selectedChipAmount = chipAmount; // ë§ˆì§€ë§‰ ì„ íƒëœ ì¹© ê¸ˆì•¡ ì €ì¥
            updateChipSelection();
            updateBetDisplay();
          });
        });

        // ë² íŒ… ì´ˆê¸°í™” ë²„íŠ¼
        document.getElementById("clearBetBtn").addEventListener("click", () => {
          currentBetAmount = 0;
          updateBetDisplay();
          updateChipSelection(); // ì¹© ì„ íƒ ìƒíƒœë„ ì´ˆê¸°í™”
        });

        // ë² íŒ…
        document
          .getElementById("placeBetBtn")
          .addEventListener("click", placeBet);

        // ê²Œì„ ì‹œì‘
        document
          .getElementById("startGameBtn")
          .addEventListener("click", startGame);

        // ìƒˆ ê²Œì„
        document
          .getElementById("newGameBtn")
          .addEventListener("click", newGame);

        // ê²Œì„ ì¢…ë£Œ
        document
          .getElementById("endGameBtn")
          .addEventListener("click", endGame);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (2ë°°ë”œê³¼ ì¬ë”œ ë²„íŠ¼ ì œê±°ë¨)

        // ê²Œì„ ì•¡ì…˜ë“¤
        document.getElementById("hitBtn").addEventListener("click", () => {
          socket.emit("hit");
        });

        document.getElementById("standBtn").addEventListener("click", () => {
          socket.emit("stand");
        });

        document.getElementById("doubleBtn").addEventListener("click", () => {
          socket.emit("double", { token });
        });

        document.getElementById("splitBtn").addEventListener("click", () => {
          socket.emit("split", { token });
        });

        document
          .getElementById("insuranceBtn")
          .addEventListener("click", () => {
            socket.emit("insurance", { token });
          });

        document
          .getElementById("surrenderBtn")
          .addEventListener("click", () => {
            if (
              confirm(
                "ì •ë§ë¡œ ì„œë Œë”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë² íŒ…ì•¡ì˜ ì ˆë°˜ë§Œ ëŒë ¤ë°›ìŠµë‹ˆë‹¤."
              )
            ) {
              socket.emit("surrender");
            }
          });
      }

      // ì¹© ì„ íƒ ì—…ë°ì´íŠ¸
      function updateChipSelection() {
        document.querySelectorAll(".chip").forEach((chip) => {
          chip.classList.remove("active");
          if (parseInt(chip.dataset.amount) === selectedChipAmount) {
            chip.classList.add("active");
          }
        });
      }

      // ë² íŒ… í‘œì‹œ ì—…ë°ì´íŠ¸ (ì”ì•¡ ì²´í¬ í¬í•¨)
      function updateBetDisplay() {
        const serverBet = gameSession ? gameSession.currentBet : 0;
        const displayBet = serverBet > 0 ? serverBet : currentBetAmount;
        const currentBalance = getCurrentBalance();

        // ë² íŒ… í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById(
          "currentBet"
        ).textContent = `â‚©${displayBet.toLocaleString()}`;

        const betBtn = document.getElementById("placeBetBtn");
        const betBtnText = document.getElementById("betBtnText");
        const startBtn = document.getElementById("startGameBtn");

        // ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ë©´ ë² íŒ… ê´€ë ¨ ë²„íŠ¼ ë¹„í™œì„±í™”
        if (isGameActive) {
          betBtn.disabled = true;
          startBtn.disabled = true;
          return;
        }

        // ì”ì•¡ ë¶€ì¡± ì²´í¬
        const isInsufficientBalance = currentBetAmount > currentBalance;

        if (serverBet === 0 && currentBetAmount === 0) {
          betBtnText.textContent = "ë² íŒ…";
          betBtn.disabled = true; // ë² íŒ…ì•¡ì´ ì—†ìœ¼ë©´ ë¹„í™œì„±í™”
          startBtn.disabled = true;
        } else if (serverBet === 0 && currentBetAmount > 0) {
          if (isInsufficientBalance) {
            betBtnText.textContent = "ì”ì•¡ ë¶€ì¡±";
            betBtn.disabled = true; // ì”ì•¡ ë¶€ì¡±ì‹œ ë¹„í™œì„±í™”
            betBtn.style.background = "#666"; // íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
          } else {
            betBtnText.textContent = "ë² íŒ…";
            betBtn.disabled = false; // ëˆ„ì  ë² íŒ…ì•¡ì´ ìˆê³  ì”ì•¡ ì¶©ë¶„í•˜ë©´ í™œì„±í™”
            betBtn.style.background = ""; // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
          }
          startBtn.disabled = true;
        } else if (serverBet > 0) {
          betBtnText.textContent = "ì™„ë£Œ";
          betBtn.disabled = true;
          betBtn.style.background = ""; // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
          startBtn.disabled = false; // ì„œë²„ì— ë² íŒ…ì´ ìˆìœ¼ë©´ ë”œ ë²„íŠ¼ í™œì„±í™”
        }

        // ì¹© ë²„íŠ¼ë“¤ì˜ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        updateChipButtonStates(currentBalance);
      }

      // í˜„ì¬ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
      function getCurrentBalance() {
        const balanceElement = document.getElementById("balance");
        if (!balanceElement) return 0;
        const balanceText = balanceElement.textContent.replace(/[â‚©,]/g, "");
        return parseInt(balanceText) || 0;
      }

      // ì¹© ë²„íŠ¼ë“¤ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì”ì•¡ì— ë”°ë¼)
      function updateChipButtonStates(currentBalance) {
        document.querySelectorAll(".chip[data-amount]").forEach((chip) => {
          const chipAmount = parseInt(chip.dataset.amount);
          const wouldExceedBalance =
            currentBetAmount + chipAmount > currentBalance;

          if (wouldExceedBalance) {
            chip.style.opacity = "0.4";
            chip.style.cursor = "not-allowed";
            chip.classList.add("insufficient-balance");
          } else {
            chip.style.opacity = "1";
            chip.style.cursor = "pointer";
            chip.classList.remove("insufficient-balance");
          }
        });
      }

      // ì—°ì† ê²Œì„ ë²„íŠ¼ë“¤ í‘œì‹œ (ìƒˆê²Œì„ ë²„íŠ¼ë§Œ)
      function showContinuousGameButtons() {
        const newGameBtn = document.getElementById("newGameBtn");
        const endGameBtn = document.getElementById("endGameBtn");
        const placeBetBtn = document.getElementById("placeBetBtn");
        const startGameBtn = document.getElementById("startGameBtn");

        if (newGameBtn) newGameBtn.classList.remove("hidden");
        if (endGameBtn) endGameBtn.classList.remove("hidden");

        // ê¸°ë³¸ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
        if (placeBetBtn) placeBetBtn.classList.add("hidden");
        if (startGameBtn) startGameBtn.classList.add("hidden");
      }

      // ì—°ì† ê²Œì„ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸° (ìƒˆê²Œì„ ë²„íŠ¼ë§Œ)
      function hideContinuousGameButtons() {
        const newGameBtn = document.getElementById("newGameBtn");
        const endGameBtn = document.getElementById("endGameBtn");
        const placeBetBtn = document.getElementById("placeBetBtn");
        const startGameBtn = document.getElementById("startGameBtn");

        if (newGameBtn) newGameBtn.classList.add("hidden");
        if (endGameBtn) endGameBtn.classList.add("hidden");

        // ê¸°ë³¸ ë²„íŠ¼ë“¤ í‘œì‹œ
        if (placeBetBtn) placeBetBtn.classList.remove("hidden");
        if (startGameBtn) startGameBtn.classList.remove("hidden");
      }

      // ë² íŒ… ì‹¤í–‰
      function placeBet() {
        if (!gameSession || currentBetAmount <= 0) {
          showNotification("ë² íŒ… ê¸ˆì•¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
          return;
        }

        showLoading();
        socket.emit("place_bet", {
          amount: currentBetAmount,
          token: token,
        });
      }

      // ê²Œì„ ì‹œì‘
      function startGame() {
        if (!gameSession || gameSession.currentBet === 0) {
          showNotification("ë¨¼ì € ë² íŒ…ì„ í•´ì£¼ì„¸ìš”.", "warning");
          return;
        }

        clearGameTable();
        socket.emit("start_game");

        document.getElementById("startGameBtn").disabled = true;
        document.getElementById("placeBetBtn").disabled = true;

        // ë² íŒ… ì˜ì—­ì€ ìœ ì§€í•˜ê³  ê²Œì„ ì•¡ì…˜ ë²„íŠ¼ë“¤ë§Œ í‘œì‹œ
        const gameActionButtons = document.getElementById("gameActionButtons");
        if (gameActionButtons) {
          gameActionButtons.classList.remove("hidden");
        }

        // ì—°ì† ê²Œì„ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
        hideContinuousGameButtons();

        isGameActive = true;
        updateGameStatus("ë”œë§ ì¤‘");
      }

      // ê²Œì„ ì•¡ì…˜ í™œì„±í™”
      function enableGameActions() {
        if (!gameSession) return;

        document.getElementById("hitBtn").disabled = false;
        document.getElementById("standBtn").disabled = false;

        updateActionButtons(gameSession);
      }

      // ê²Œì„ ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
      function showGameResultModal(result, payout) {
        const modal = document.getElementById("gameResultModal");
        const resultText = document.getElementById("modalResultText");
        const payoutText = document.getElementById("modalPayoutText");

        let message = "";
        let modalClass = "";

        switch (result) {
          case "win":
            message = "ì´ê²¼ìŠµë‹ˆë‹¤!";
            modalClass = "from-green-600 to-green-800 border-green-400";
            break;
          case "lose":
            message = "ì¡ŒìŠµë‹ˆë‹¤";
            modalClass = "from-red-600 to-red-800 border-red-400";
            break;
          case "push":
            message = "ë¬´ìŠ¹ë¶€";
            modalClass = "from-blue-600 to-blue-800 border-blue-400";
            break;
          case "blackjack":
            message = "ë¸”ë™ì­!";
            modalClass = "from-yellow-600 to-yellow-800 border-yellow-400";
            break;
          case "bust":
            message = "ë²„ìŠ¤íŠ¸!";
            modalClass = "from-red-600 to-red-800 border-red-400";
            break;
          default:
            message = result;
            modalClass = "from-gray-600 to-gray-800 border-gray-400";
        }

        resultText.textContent = message;
        payoutText.textContent =
          payout > 0
            ? `+â‚©${payout.toLocaleString()}`
            : payout < 0
            ? `-â‚©${Math.abs(payout).toLocaleString()}`
            : "Â±â‚©0";

        // ëª¨ë‹¬ ë°°ê²½ ìƒ‰ìƒ ë³€ê²½
        const modalContent = modal.querySelector(".bg-gradient-to-br");
        modalContent.className = `bg-gradient-to-br ${modalClass} p-8 rounded-2xl border-4 text-center shadow-2xl transform scale-110`;

        modal.classList.remove("hidden");

        // 1.5ì´ˆ í›„ ëª¨ë‹¬ ìˆ¨ê¹€
        setTimeout(() => {
          modal.classList.add("hidden");
        }, 1500);
      }

      // ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬
      function handleGameEnd(session, results) {
        updateGameSession(session);
        disableGameActions();

        // resultsê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê²Œì„ ìƒí™©ì„ ë¶„ì„í•´ì„œ ê²°ê³¼ ì¶”ì •
        let gameResult = null;

        if (results && results.length > 0) {
          gameResult = results[0];
        } else {
          // resultsê°€ ì—†ì„ ë•Œ ê²Œì„ ìƒí™© ë¶„ì„
          console.log("ê²Œì„ ê²°ê³¼ ë¶„ì„ ì¤‘...", session);
          gameResult = analyzeGameResult(session);
          console.log("ë¶„ì„ëœ ê²°ê³¼:", gameResult);
        }

        if (gameResult) {
          // ëª¨ë‹¬ë¡œ ê²°ê³¼ í‘œì‹œ
          console.log("ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ:", gameResult.result, gameResult.payout);
          showGameResultModal(gameResult.result, gameResult.payout || 0);

          // Phaserì—ì„œëŠ” ê°„ë‹¨í•œ ê²°ê³¼ë§Œ í‘œì‹œ
          if (blackjackScene) {
            let message = "";
            let color = "#FFD700";

            switch (gameResult.result) {
              case "win":
                message = "ìŠ¹ë¦¬!";
                color = "#00ff00";
                break;
              case "lose":
                message = "íŒ¨ë°°";
                color = "#ff4444";
                break;
              case "push":
                message = "ë¬´ìŠ¹ë¶€";
                color = "#4444ff";
                break;
              case "blackjack":
                message = "ë¸”ë™ì­!";
                color = "#ffd700";
                break;
              case "bust":
                message = "ë²„ìŠ¤íŠ¸!";
                color = "#ff4444";
                break;
              default:
                message = gameResult.result;
            }

            blackjackScene.showGameResult(message, color);
          }
        } else {
          console.log("ê²Œì„ ê²°ê³¼ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          // ê²°ê³¼ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ì„ ë•Œ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
          showNotification("ê²Œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
        }

        isGameActive = false;
        isDealerTurn = false;
        updateGameStatus("ê²Œì„ ì™„ë£Œ");

        // ê²Œì„ ì•¡ì…˜ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê³  ì—°ì† ê²Œì„ ë²„íŠ¼ë“¤ í‘œì‹œ
        const gameActionButtons = document.getElementById("gameActionButtons");
        if (gameActionButtons) {
          gameActionButtons.classList.add("hidden");
        }
        showContinuousGameButtons();

        // ê²Œì„ ì™„ë£Œ í›„ ì¦‰ì‹œ ë° ì§€ì—° ì”ì•¡ ì—…ë°ì´íŠ¸ (ë°”ì¹´ë¼ì™€ ê°™ì€ ë°©ì‹)
        fetchUserInfo(true); // ì¦‰ì‹œ ìµœì‹  ì”ì•¡ ì¡°íšŒ
        setTimeout(() => {
          fetchUserInfo(true); // í•œ ë²ˆ ë” ìµœì‹  ì”ì•¡ ì¡°íšŒ (ì„œë²„ ë™ê¸°í™” ë³´ì¥)
        }, 1000);

        // 3ì´ˆ í›„ ë² íŒ… ìƒíƒœë¡œ ìë™ ì „í™˜
        setTimeout(() => {
          if (gameSession && gameSession.status === "waiting") {
            isGameActive = false; // í™•ì‹¤íˆ ë¹„í™œì„±í™”
            updateBetDisplay(); // ë² íŒ… ë²„íŠ¼ ìƒíƒœ ì¬ì„¤ì •
          }
        }, 3000);
      }

      // ìƒˆ ê²Œì„ - ë² íŒ…ë¶€í„° ì‹œì‘
      function newGame() {
        // ìƒíƒœ ì´ˆê¸°í™”
        isGameActive = false;
        isDealerTurn = false;
        currentBetAmount = 0; // ë² íŒ… ê¸ˆì•¡ ì´ˆê¸°í™”

        socket.emit("new_game");
        clearGameTable();
        resetGameUI();

        // ëª¨ë“  ê²Œì„ ë²„íŠ¼ë“¤ ì´ˆê¸° ìƒíƒœë¡œ
        const gameActionButtons = document.getElementById("gameActionButtons");
        if (gameActionButtons) {
          gameActionButtons.classList.add("hidden");
        }
        hideContinuousGameButtons();

        // ë² íŒ… ìƒíƒœë¡œ ì™„ì „ ì´ˆê¸°í™”
        setTimeout(() => {
          updateBetDisplay();
        }, 500);
      }

      // ê²Œì„ ì¢…ë£Œ
      function endGame() {
        if (confirm("ì •ë§ë¡œ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          // ê²Œì„ ì„¸ì…˜ ì •ë¦¬
          if (socket && socket.connected) {
            socket.emit("leave_game");
            socket.disconnect();
          }

          // Phaser ê²Œì„ ì •ë¦¬
          if (blackjackGame) {
            blackjackGame.destroy(true);
            blackjackGame = null;
          }

          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬ (ì„ íƒì‚¬í•­)
          // localStorage.removeItem("token");

          // ë¡œë¹„ë¡œ ì´ë™
          window.location.href = "index.html";
        }
      }

      // ê²Œì„ ê²°ê³¼ ë¶„ì„ (resultsê°€ ì—†ì„ ë•Œ ìƒí™© ë¶„ì„)
      function analyzeGameResult(session) {
        if (!session) return null;

        const playerValue = session.playerValue;
        const dealerValue = session.dealerValue;
        const playerHand = session.playerHand || [];
        const dealerHand = session.dealerHand || [];

        // í”Œë ˆì´ì–´ ë²„ìŠ¤íŠ¸ í™•ì¸
        if (playerValue > 21) {
          return {
            result: "bust",
            payout: -session.currentBet,
          };
        }

        // ë”œëŸ¬ ë¸”ë™ì­ ë¨¼ì € í™•ì¸ (ë”œëŸ¬ ë¸”ë™ì­ì´ ìš°ì„ )
        if (dealerValue === 21 && dealerHand.length === 2) {
          // í”Œë ˆì´ì–´ë„ ë¸”ë™ì­ì¸ì§€ í™•ì¸
          if (playerValue === 21 && playerHand.length === 2) {
            return {
              result: "push",
              payout: 0,
            };
          } else {
            return {
              result: "lose",
              payout: -session.currentBet,
            };
          }
        }

        // í”Œë ˆì´ì–´ ë¸”ë™ì­ í™•ì¸ (ë”œëŸ¬ê°€ ë¸”ë™ì­ì´ ì•„ë‹Œ ê²½ìš°)
        if (playerValue === 21 && playerHand.length === 2) {
          return {
            result: "blackjack",
            payout: Math.floor(session.currentBet * 1.5),
          };
        }

        // 21ë¡œ ìŠ¹ë¦¬ (ë¸”ë™ì­ì´ ì•„ë‹Œ ê²½ìš°)
        if (playerValue === 21) {
          // ë”œëŸ¬ê°€ ì•„ì§ í„´ì„ í•˜ì§€ ì•Šì•˜ê±°ë‚˜, ë”œëŸ¬ë³´ë‹¤ ì ìˆ˜ê°€ ë†’ì„ ê²½ìš°
          if (dealerValue < 21 || dealerHand.length < 2) {
            return {
              result: "win",
              payout: session.currentBet,
            };
          } else if (dealerValue === 21) {
            return {
              result: "push",
              payout: 0,
            };
          } else {
            return {
              result: "win",
              payout: session.currentBet,
            };
          }
        }

        // ë”œëŸ¬ ë²„ìŠ¤íŠ¸
        if (dealerValue > 21) {
          return {
            result: "win",
            payout: session.currentBet,
          };
        }

        // ì¼ë°˜ì ì¸ ìŠ¹ë¶€ ê²°ì •
        if (playerValue > dealerValue) {
          return {
            result: "win",
            payout: session.currentBet,
          };
        } else if (playerValue < dealerValue) {
          return {
            result: "lose",
            payout: -session.currentBet,
          };
        } else {
          return {
            result: "push",
            payout: 0,
          };
        }
      }

      // dealDoubleê³¼ dealRebet í•¨ìˆ˜ ì œê±°ë¨ (ë²„íŠ¼ ì œê±°ë¡œ ì¸í•´)

      // fetchUserInfo í•¨ìˆ˜ ì¶”ê°€ (ë°”ì¹´ë¼ì™€ ë™ì¼í•œ ë¡œì§)
      let fetchUserInfoTimer = null;
      let fetchUserInfoInProgress = false;

      async function fetchUserInfo(immediate = false) {
        // ì¦‰ì‹œ ì‹¤í–‰ì´ ì•„ë‹Œ ê²½ìš° ë””ë°”ìš´ì‹± ì ìš©
        if (!immediate) {
          if (fetchUserInfoTimer) {
            clearTimeout(fetchUserInfoTimer);
          }
          fetchUserInfoTimer = setTimeout(() => {
            fetchUserInfo(true);
          }, 200); // 200ms ë””ë°”ìš´ì‹±
          return;
        }

        // ì´ë¯¸ ìš”ì²­ ì¤‘ì´ë©´ ì¤‘ë³µ ìš”ì²­ ë°©ì§€
        if (fetchUserInfoInProgress) {
          return;
        }

        fetchUserInfoInProgress = true;

        try {
          const res = await fetch(
            "https://port-0-baccrat-backend-m5l6sc488b056240.sel4.cloudtype.app/api/auth/user-info",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (res.ok) {
            const user = await res.json();

            // ì”ì•¡ ì—…ë°ì´íŠ¸
            const balance =
              typeof user.balance === "number" && !isNaN(user.balance)
                ? user.balance
                : 0;
            updateBalance(balance);

            // ê²Œì„ ì„¸ì…˜ì´ ìˆìœ¼ë©´ ì„¸ì…˜ ì”ì•¡ë„ ì—…ë°ì´íŠ¸
            if (gameSession) {
              gameSession.balance = balance;
            }

            console.log("ë¸”ë™ì­ ì”ì•¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ:", balance);
          } else {
            console.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (err) {
          console.error("fetchUserInfo ì˜¤ë¥˜:", err);
        } finally {
          fetchUserInfoInProgress = false;
        }
      }

      // ê²Œì„ ì„¸ì…˜ ì—…ë°ì´íŠ¸
      function updateGameSession(session) {
        gameSession = session;
        updateBalance(session.balance);
        updateBetDisplay();
        updatePlayerScore(session.playerValue);
        updateDealerScore(session.dealerValue);
        updateGameStatus(getStatusText(session.status));

        // ê²Œì„ ì•¡ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (session.status === "playing") {
          updateActionButtons(session);
        }
      }

      // ì”ì•¡ ì—…ë°ì´íŠ¸ (ë°”ì¹´ë¼ì™€ ë™ì¼í•œ ê³ ê¸‰ ê¸°ëŠ¥)
      function updateBalance(balance) {
        const balanceElement = document.getElementById("balance");
        if (!balanceElement) return;

        const currentBalance =
          parseInt(balanceElement.textContent.replace(/[â‚©,]/g, "")) || 0;
        const newBalance = parseInt(balance) || 0;

        // ì”ì•¡ ë³€í™” ê°ì§€ ë° ì‹œê°ì  íš¨ê³¼
        if (currentBalance !== newBalance) {
          // ì”ì•¡ ì¦ê°€/ê°ì†Œì— ë”°ë¥¸ ìƒ‰ìƒ íš¨ê³¼
          if (newBalance > currentBalance) {
            balanceElement.style.color = "#10b981"; // ë…¹ìƒ‰ (ì¦ê°€)
            balanceElement.style.transform = "scale(1.1)";
          } else if (newBalance < currentBalance) {
            balanceElement.style.color = "#ef4444"; // ë¹¨ê°„ìƒ‰ (ê°ì†Œ)
            balanceElement.style.transform = "scale(1.1)";
          }

          // ì”ì•¡ ì—…ë°ì´íŠ¸
          balanceElement.textContent = `â‚©${newBalance.toLocaleString()}`;

          // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
          setTimeout(() => {
            balanceElement.style.color = "#fbbf24"; // ì›ë˜ ë…¸ë€ìƒ‰
            balanceElement.style.transform = "scale(1)";
          }, 800);
        } else {
          // ë³€í™”ê°€ ì—†ì–´ë„ ì—…ë°ì´íŠ¸ (ì´ˆê¸° ë¡œë“œ ë“±)
          balanceElement.textContent = `â‚©${newBalance.toLocaleString()}`;
        }

        // ì”ì•¡ì´ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ë² íŒ… ìƒíƒœ ì¬í™•ì¸
        updateBetDisplay();
      }

      // ê²Œì„ ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
      function getStatusText(status) {
        const statusMap = {
          waiting: "ëŒ€ê¸° ì¤‘",
          betting: "ë² íŒ… ì™„ë£Œ",
          dealing: "ë”œë§ ì¤‘",
          playing: "í”Œë ˆì´ ì¤‘",
          "dealer-turn": "ë”œëŸ¬ í„´",
          finished: "ê²Œì„ ì™„ë£Œ",
          doubled: "ë”ë¸”ë‹¤ìš´ ì™„ë£Œ",
        };
        return statusMap[status] || status;
      }

      // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateGameStatus(status) {
        document.getElementById("gameStatus").textContent = status;
      }

      // ì´ˆê¸° ì¹´ë“œ ë Œë”ë§
      function renderInitialCards() {
        if (!gameSession) return;

        // í”Œë ˆì´ì–´ ì¹´ë“œ
        gameSession.playerHand.forEach((card, index) => {
          setTimeout(() => {
            addCardToHand("player", card);
          }, index * 300);
        });

        // ë”œëŸ¬ ì¹´ë“œ
        gameSession.dealerHand.forEach((card, index) => {
          setTimeout(() => {
            if (card.value === "hidden") {
              addHiddenCard("dealer");
            } else {
              addCardToHand("dealer", card);
            }
          }, (gameSession.playerHand.length + index) * 300);
        });
      }

      // ì¹´ë“œ ì¶”ê°€
      function addCardToHand(handType, card) {
        // ì¹´ë“œ ìœ íš¨ì„± ê²€ì‚¬
        if (!card) {
          console.error("ì¹´ë“œê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:", handType, card);
          return;
        }

        const handElement = document.getElementById(`${handType}Hand`);
        if (!handElement) {
          console.error("í•¸ë“œ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", handType);
          return;
        }

        const cardElement = createCardElement(card);
        cardElement.classList.add("card-dealing");
        handElement.appendChild(cardElement);

        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (handType === "player") {
          updatePlayerScore();
        } else if (handType === "dealer" && !isDealerTurn) {
          updateDealerScore();
        }
      }

      // ìˆ¨ê²¨ì§„ ì¹´ë“œ ì¶”ê°€
      function addHiddenCard(handType) {
        const handElement = document.getElementById(`${handType}Hand`);
        const cardElement = document.createElement("div");
        cardElement.className = "card hidden card-dealing";
        cardElement.innerHTML =
          '<div class="text-white text-center leading-none">?</div>';
        handElement.appendChild(cardElement);
      }

      // ì¹´ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
      function createCardElement(card) {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card";

        // ì¹´ë“œ ê°ì²´ ìœ íš¨ì„± ê²€ì‚¬
        if (!card || !card.value || !card.suit) {
          console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ê°ì²´:", card);
          // ê¸°ë³¸ ì¹´ë“œ ì´ë¯¸ì§€ ë˜ëŠ” ì˜¤ë¥˜ í‘œì‹œ
          cardDiv.innerHTML =
            '<div class="text-red-500 text-center text-xs">ì˜¤ë¥˜</div>';
          return cardDiv;
        }

        // Deck of Cards API ì´ë¯¸ì§€ URL ìƒì„±
        const cardCode = `${card.value === "0" ? "10" : card.value}${
          card.suit
        }`;
        const imageUrl = `https://deckofcardsapi.com/static/img/${cardCode}.png`;

        cardDiv.innerHTML = `<img src="${imageUrl}" alt="${card.value}${card.suit}" class="card-image" onerror="this.parentElement.innerHTML='<div class=\\'text-red-500 text-center text-xs\\'>ì¹´ë“œ<br/>ì˜¤ë¥˜</div>'" />`;

        return cardDiv;
      }

      // ë”œëŸ¬ ìˆ¨ê²¨ì§„ ì¹´ë“œ ê³µê°œ
      function revealDealerHiddenCard(card) {
        // ì¹´ë“œ ìœ íš¨ì„± ê²€ì‚¬
        if (!card || !card.value || !card.suit) {
          console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ê°ì²´:", card);
          return;
        }

        const dealerHand = document.getElementById("dealerHand");
        if (!dealerHand) {
          console.error("ë”œëŸ¬ í•¸ë“œ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const hiddenCard = dealerHand.querySelector(".card.hidden");
        if (hiddenCard) {
          const cardCode = `${card.value === "0" ? "10" : card.value}${
            card.suit
          }`;
          const imageUrl = `https://deckofcardsapi.com/static/img/${cardCode}.png`;

          hiddenCard.className = "card";
          hiddenCard.innerHTML = `<img src="${imageUrl}" alt="${card.value}${card.suit}" class="card-image" onerror="this.parentElement.innerHTML='<div class=\\'text-red-500 text-center text-xs\\'>ì¹´ë“œ<br/>ì˜¤ë¥˜</div>'" />`;
        } else {
          console.error("ìˆ¨ê²¨ì§„ ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // í”Œë ˆì´ì–´ ì ìˆ˜ ì—…ë°ì´íŠ¸
      function updatePlayerScore(score) {
        const playerScore =
          score || (gameSession ? gameSession.playerValue : 0);
        document.getElementById("playerScoreValue").textContent = playerScore;

        // ë²„ìŠ¤íŠ¸ í‘œì‹œ
        if (playerScore > 21) {
          document.getElementById("playerScore").classList.add("text-red-400");
        } else {
          document
            .getElementById("playerScore")
            .classList.remove("text-red-400");
        }
      }

      // ë”œëŸ¬ ì ìˆ˜ ì—…ë°ì´íŠ¸
      function updateDealerScore(score) {
        const dealerScore =
          score || (gameSession ? gameSession.dealerValue : 0);
        document.getElementById("dealerScoreValue").textContent = dealerScore;

        // ë²„ìŠ¤íŠ¸ í‘œì‹œ
        if (dealerScore > 21) {
          document.getElementById("dealerScore").classList.add("text-red-400");
        } else {
          document
            .getElementById("dealerScore")
            .classList.remove("text-red-400");
        }
      }

      // ê²Œì„ ì•¡ì…˜ í™œì„±í™”
      function enableGameActions() {
        if (!gameSession) return;

        const hitBtn = document.getElementById("hitBtn");
        const standBtn = document.getElementById("standBtn");

        if (hitBtn) hitBtn.disabled = false;
        if (standBtn) standBtn.disabled = false;

        updateActionButtons(gameSession);
      }

      // ê²Œì„ ì•¡ì…˜ ë¹„í™œì„±í™”
      function disableGameActions() {
        const hitBtn = document.getElementById("hitBtn");
        const standBtn = document.getElementById("standBtn");
        const doubleBtn = document.getElementById("doubleBtn");
        const splitBtn = document.getElementById("splitBtn");
        const insuranceBtn = document.getElementById("insuranceBtn");
        const surrenderBtn = document.getElementById("surrenderBtn");

        if (hitBtn) hitBtn.disabled = true;
        if (standBtn) standBtn.disabled = true;
        if (doubleBtn) doubleBtn.disabled = true;
        if (splitBtn) splitBtn.disabled = true;
        if (insuranceBtn) insuranceBtn.disabled = true;
        if (surrenderBtn) surrenderBtn.disabled = true;
      }

      // ì•¡ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateActionButtons(session) {
        const doubleBtn = document.getElementById("doubleBtn");
        if (doubleBtn) {
          doubleBtn.disabled = !session.canDouble;
        }

        // ìŠ¤í”Œë¦¿ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        const splitBtn = document.getElementById("splitBtn");
        if (splitBtn) {
          if (session.canSplit) {
            splitBtn.classList.remove("hidden");
            splitBtn.disabled = false;
          } else {
            splitBtn.classList.add("hidden");
          }
        }

        // ë³´í—˜ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        const insuranceBtn = document.getElementById("insuranceBtn");
        if (insuranceBtn) {
          if (session.canInsurance) {
            insuranceBtn.classList.remove("hidden");
            insuranceBtn.disabled = false;
          } else {
            insuranceBtn.classList.add("hidden");
          }
        }

        // ì„œë Œë” ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ì²˜ìŒ 2ì¥ë§Œ ë°›ì€ ìƒíƒœì—ì„œë§Œ)
        const surrenderBtn = document.getElementById("surrenderBtn");
        if (surrenderBtn) {
          // ì²˜ìŒ 2ì¥ë§Œ ë°›ì€ ìƒíƒœì´ê³ , ìŠ¤í”Œë¦¿ ìƒíƒœê°€ ì•„ë‹ˆë©°, ë”œëŸ¬ê°€ ë¸”ë™ì­ì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
          const canSurrender =
            session.playerHand &&
            session.playerHand.length === 2 &&
            !session.isSplit &&
            session.status === "playing";

          if (canSurrender) {
            surrenderBtn.classList.remove("hidden");
            surrenderBtn.disabled = false;
          } else {
            surrenderBtn.classList.add("hidden");
          }
        }
      }

      // ë”œëŸ¬ í„´ í‘œì‹œê¸° í‘œì‹œ
      function showDealerTurnIndicator() {
        const dealerStatus = document.getElementById("dealerStatus");
        dealerStatus.textContent = "ë”œëŸ¬ê°€ ì¹´ë“œë¥¼ ë½‘ê³  ìˆìŠµë‹ˆë‹¤...";
        dealerStatus.classList.remove("hidden");
        dealerStatus.classList.add("dealer-turn-indicator");

        // Phaserì—ì„œë„ ë”œëŸ¬ í„´ í‘œì‹œ
        if (blackjackScene) {
          blackjackScene.showGameResult("ë”œëŸ¬ í„´", "#ffaa00");
        }
      }

      // ë”œëŸ¬ í„´ í‘œì‹œê¸° ìˆ¨ê¹€
      function hideDealerTurnIndicator() {
        const dealerStatus = document.getElementById("dealerStatus");
        dealerStatus.classList.add("hidden");
        dealerStatus.classList.remove("dealer-turn-indicator");

        // Phaserì—ì„œë„ ë©”ì‹œì§€ ìˆ¨ê¹€
        if (blackjackScene && blackjackScene.gameResultText) {
          blackjackScene.gameResultText.setVisible(false);
        }
      }

      // ê²Œì„ ê²°ê³¼ í‘œì‹œ
      function showGameResults(results) {
        const resultDiv = document.getElementById("gameResult");
        const contentDiv = document.getElementById("resultContent");

        contentDiv.innerHTML = "";

        results.forEach((result, index) => {
          const resultItem = document.createElement("div");
          resultItem.className =
            "flex justify-between items-center p-3 bg-gray-700 rounded";

          const resultText = getResultText(result.result);
          const resultClass = getResultClass(result.result);

          resultItem.innerHTML = `
            <span class="${resultClass} font-bold">${resultText}</span>
            <span class="text-yellow-400 font-bold">â‚©${result.payout.toLocaleString()}</span>
          `;

          contentDiv.appendChild(resultItem);
        });

        resultDiv.classList.remove("hidden");

        // 3ì´ˆ í›„ ê²°ê³¼ ìˆ¨ê¹€
        setTimeout(() => {
          resultDiv.classList.add("hidden");
        }, 5000);
      }

      // ê²°ê³¼ í…ìŠ¤íŠ¸ ë°˜í™˜
      function getResultText(result) {
        const resultMap = {
          win: "ìŠ¹ë¦¬",
          lose: "íŒ¨ë°°",
          push: "ë¬´ìŠ¹ë¶€",
          blackjack: "ë¸”ë™ì­!",
          bust: "ë²„ìŠ¤íŠ¸",
        };
        return resultMap[result] || result;
      }

      // ê²°ê³¼ í´ë˜ìŠ¤ ë°˜í™˜
      function getResultClass(result) {
        if (["win", "blackjack"].includes(result)) {
          return "text-green-400";
        } else if (["lose", "bust"].includes(result)) {
          return "text-red-400";
        } else {
          return "text-blue-400";
        }
      }

      // ê²Œì„ í…Œì´ë¸” ì´ˆê¸°í™”
      function clearGameTable() {
        document.getElementById("playerHand").innerHTML = "";
        document.getElementById("dealerHand").innerHTML = "";
        document.getElementById("splitHandsContainer").classList.add("hidden");
        updatePlayerScore(0);
        updateDealerScore(0);
      }

      // ê²Œì„ UI ì´ˆê¸°í™”
      function resetGameUI() {
        const startGameBtn = document.getElementById("startGameBtn");
        const placeBetBtn = document.getElementById("placeBetBtn");
        const gameResult = document.getElementById("gameResult");
        const betBtnText = document.getElementById("betBtnText");
        const splitBtn = document.getElementById("splitBtn");
        const insuranceBtn = document.getElementById("insuranceBtn");

        if (startGameBtn) startGameBtn.disabled = true;
        if (placeBetBtn) placeBetBtn.disabled = false;
        if (gameResult) gameResult.classList.add("hidden");

        // ë² íŒ… ê´€ë ¨ ì´ˆê¸°í™”
        currentBetAmount = 0; // ëˆ„ì  ë² íŒ…ì•¡ ì´ˆê¸°í™”
        if (placeBetBtn) placeBetBtn.disabled = false;
        if (betBtnText) betBtnText.textContent = "ë² íŒ…";

        // ì—°ì† ê²Œì„ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
        hideContinuousGameButtons();

        disableGameActions();
        hideDealerTurnIndicator();

        // ë³´í—˜, ìŠ¤í”Œë¦¿, ì„œë Œë” ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        if (splitBtn) splitBtn.classList.add("hidden");
        if (insuranceBtn) insuranceBtn.classList.add("hidden");

        const surrenderBtn = document.getElementById("surrenderBtn");
        if (surrenderBtn) surrenderBtn.classList.add("hidden");

        isGameActive = false;
        isDealerTurn = false;

        updateBetDisplay();
        updateGameStatus("ëŒ€ê¸° ì¤‘");

        // Phaser Scene ì´ˆê¸°í™”
        if (blackjackScene) {
          blackjackScene.clearAllCardsAndText();
        }
      }

      // ì„œë Œë” í›„ ê²Œì„ ì´ˆê¸°í™”
      function resetGameAfterSurrender() {
        console.log("ì„œë Œë” í›„ ê²Œì„ ì´ˆê¸°í™” ì‹œì‘");

        // ê²Œì„ ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”
        isGameActive = false;
        isDealerTurn = false;
        currentBetAmount = 0;
        gameSession = null;

        // UI ì™„ì „ ì´ˆê¸°í™”
        clearGameTable();
        resetGameUI();

        // ê²Œì„ ì•¡ì…˜ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
        const gameActionButtons = document.getElementById("gameActionButtons");
        if (gameActionButtons) {
          gameActionButtons.classList.add("hidden");
        }

        // ê¸°ë³¸ ë² íŒ… ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸° (ì„œë Œë” í›„ì—ëŠ” ë°”ë¡œ ë² íŒ… ë¶ˆê°€)
        const placeBetBtn = document.getElementById("placeBetBtn");
        const startGameBtn = document.getElementById("startGameBtn");

        if (placeBetBtn) {
          placeBetBtn.classList.add("hidden");
          placeBetBtn.disabled = true;
        }
        if (startGameBtn) {
          startGameBtn.classList.add("hidden");
          startGameBtn.disabled = true;
        }

        // ì—°ì† ê²Œì„ ë²„íŠ¼ë“¤ í‘œì‹œ (ìƒˆê²Œì„, ì¢…ë£Œë§Œ ê°€ëŠ¥)
        showContinuousGameButtons();

        // ë² íŒ… í‘œì‹œ ì´ˆê¸°í™”
        updateBetDisplay();
        updateGameStatus("ì„œë Œë” ì™„ë£Œ");

        // ì•Œë¦¼ í‘œì‹œ
        showNotification(
          "ì„œë Œë”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆê²Œì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.",
          "warning"
        );

        console.log("ì„œë Œë” í›„ ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ");
      }

      // ì•Œë¦¼ í‘œì‹œ
      function showNotification(message, type = "info") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // ë¡œë”© í‘œì‹œ
      function showLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
      }

      // ë¡œë”© ìˆ¨ê¹€
      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
      }

      // ===== PHASER ê²Œì„ ê´€ë ¨ ì½”ë“œ =====

      // Phaser ë¸”ë™ì­ Scene ì •ì˜
      class BlackjackScene extends Phaser.Scene {
        constructor() {
          super({ key: "BlackjackScene" });
          this.cardSprites = { player: [], dealer: [] }; // Phaser Image ê°ì²´ ì €ì¥
          this.handsData = { player: [], dealer: [] }; // ì¹´ë“œ ê°’(ë¬¸ìì—´) ì €ì¥
          this.socket = socket;

          // í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ë°˜ì‘í˜• ì„¤ì •
          this.setupResponsiveSettings();
        }

        setupResponsiveSettings() {
          const screenWidth = window.innerWidth;
          const isMobile = screenWidth < 1024; // lg ë¸Œë ˆì´í¬í¬ì¸íŠ¸

          if (isMobile) {
            // ëª¨ë°”ì¼ ì„¤ì • - ì¹´ë“œ í¬ê¸° ì¶•ì†Œ
            this.cardScale = 0.25;
            this.cardSpacing = 35;
            this.baseFontSize = 14;
            this.scoreFontSize = 16;
            this.resultFontSize = 18;
          } else {
            // PC ì„¤ì • - í™”ë©´ í¬ê¸°ì— ë”°ë¼ ì¡°ì • (ì¹´ë“œ í¬ê¸° ì¶•ì†Œ)
            if (screenWidth >= 1920) {
              // í° PC í™”ë©´ (1920px ì´ìƒ)
              this.cardScale = 0.4;
              this.cardSpacing = 55;
              this.baseFontSize = 18;
              this.scoreFontSize = 22;
              this.resultFontSize = 26;
            } else if (screenWidth >= 1440) {
              // ì¤‘ê°„ PC í™”ë©´ (1440px ì´ìƒ)
              this.cardScale = 0.35;
              this.cardSpacing = 50;
              this.baseFontSize = 16;
              this.scoreFontSize = 20;
              this.resultFontSize = 24;
            } else {
              // ì‘ì€ PC í™”ë©´ (1024px ì´ìƒ)
              this.cardScale = 0.3;
              this.cardSpacing = 45;
              this.baseFontSize = 15;
              this.scoreFontSize = 18;
              this.resultFontSize = 22;
            }
          }
        }

        preload() {
          // ì¹´ë“œ ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ (ëª¨ë“  ìˆ«ìì™€ ë¬´ëŠ¬ ì¡°í•©)
          const suits = ["H", "D", "C", "S"]; // Hearts, Diamonds, Clubs, Spades
          const values = [
            "A",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "0", // 0ì€ 10ì„ ì˜ë¯¸
            "J",
            "Q",
            "K",
          ];

          suits.forEach((suit) => {
            values.forEach((value) => {
              const cardCode = `${value}${suit}`;
              const imageUrl = `https://deckofcardsapi.com/static/img/${cardCode}.png`;
              this.load.image(cardCode, imageUrl);

              this.load.on(`loaderror`, (file) => {
                if (file.key === cardCode) {
                  console.error(
                    `[BlackjackGame] Failed to load: ${cardCode} from ${imageUrl}`
                  );
                }
              });
            });
          });

          // ì¹´ë“œ ë’·ë©´ ì´ë¯¸ì§€
          this.load.image(
            "card_back",
            "https://deckofcardsapi.com/static/img/back.png"
          );
        }

        create() {
          const width = this.cameras.main.width;
          const height = this.cameras.main.height;
          const centerX = width / 2;
          const centerY = height / 2;

          // ë¸”ë™ì­ í…Œì´ë¸” ë°°ê²½ ìƒì„±
          this.createBlackjackTable(width, height, centerX, centerY);

          // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì •ì˜ (ë°˜ì‘í˜•)
          const textStyle = {
            fontSize: `${this.baseFontSize}px`,
            fontFamily: '"Noto Serif KR", serif',
            color: "#ffffff",
            stroke: "#000000",
            strokeThickness: 2,
          };
          const scoreTextStyle = {
            ...textStyle,
            fontSize: `${this.scoreFontSize}px`,
            color: "#ffd700",
            fontWeight: "bold",
          };
          const resultTextStyle = {
            ...textStyle,
            fontSize: `${this.resultFontSize}px`,
            color: "#FFD700",
            backgroundColor: "rgba(0,0,0,0.8)",
            padding: { x: 12, y: 6 },
            borderRadius: 8,
            fontWeight: "bold",
          };

          // ë”œëŸ¬/í”Œë ˆì´ì–´ ë¼ë²¨
          this.add.text(centerX - 100, 30, "DEALER", textStyle).setOrigin(0.5);
          this.add
            .text(centerX - 100, height - 30, "PLAYER", textStyle)
            .setOrigin(0.5);

          // ì ìˆ˜ í…ìŠ¤íŠ¸ (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™)
          this.dealerScoreText = this.add
            .text(centerX + 100, 30, "0", scoreTextStyle)
            .setOrigin(0.5);
          this.playerScoreText = this.add
            .text(centerX + 100, height - 30, "0", scoreTextStyle)
            .setOrigin(0.5);

          // ê²Œì„ ê²°ê³¼ í…ìŠ¤íŠ¸
          this.gameResultText = this.add
            .text(centerX, centerY, "", resultTextStyle)
            .setOrigin(0.5)
            .setVisible(false)
            .setDepth(10);

          this.clearAllCardsAndText();
        }

        createBlackjackTable(width, height, centerX, centerY) {
          const g = this.add.graphics();

          // í…Œì´ë¸” ë°°ê²½: ì§„í•œ ë…¹ìƒ‰
          const feltColor = 0x1a4b3a;
          g.fillStyle(feltColor, 1);
          g.fillRoundedRect(0, 0, width, height, 12);

          // ë”œëŸ¬, í”Œë ˆì´ì–´ ì˜ì—­ì— ì€ì€í•œ í•˜ì´ë¼ì´íŠ¸
          g.fillStyle(0xffffff, 0.05);
          g.fillRoundedRect(10, 10, width - 20, height / 2 - 20, 8); // ë”œëŸ¬ ì˜ì—­
          g.fillRoundedRect(
            10,
            height / 2 + 10,
            width - 20,
            height / 2 - 20,
            8
          ); // í”Œë ˆì´ì–´ ì˜ì—­

          // ì¤‘ì•™ì„ 
          g.lineStyle(2, 0xb8860b, 0.5);
          g.lineBetween(20, centerY, width - 20, centerY);
        }

        // ì¹´ë“œ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        addCard(handType, card, isHidden = false) {
          if (!card || !card.value || !card.suit) {
            console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ:", card);
            return;
          }

          const width = this.cameras.main.width;
          const height = this.cameras.main.height;
          const centerX = width / 2;

          // ì¹´ë“œ ìœ„ì¹˜ ê³„ì‚°
          const cardIndex = this.cardSprites[handType].length;
          const startX = centerX - this.cardSpacing * 2; // ì¤‘ì•™ì—ì„œ ì‹œì‘
          const cardX = startX + cardIndex * this.cardSpacing;

          let cardY;
          if (handType === "dealer") {
            cardY = height * 0.25; // ë”œëŸ¬ ì˜ì—­
          } else {
            cardY = height * 0.75; // í”Œë ˆì´ì–´ ì˜ì—­
          }

          // ì¹´ë“œ ì´ë¯¸ì§€ í‚¤ ìƒì„±
          const cardKey = `${card.value}${card.suit}`;

          // ì¹´ë“œ ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„± (í•­ìƒ ì¹´ë“œ ë’·ë©´ìœ¼ë¡œ ì‹œì‘)
          const cardSprite = this.add
            .image(-100, cardY - 50, "card_back") // ì‹œì‘ ìœ„ì¹˜ë¥¼ ìœ„ìª½ìœ¼ë¡œ
            .setScale(this.cardScale * 0.8)
            .setAlpha(0)
            .setDepth(cardIndex);

          // 1ë‹¨ê³„: ì¹´ë“œ ë”œë§ ë° ë’·ë©´ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
          this.tweens.add({
            targets: cardSprite,
            x: cardX,
            y: cardY,
            alpha: 1,
            scaleX: this.cardScale,
            scaleY: this.cardScale,
            duration: 300,
            ease: "Power2",
            onComplete: () => {
              // 2ë‹¨ê³„: ì¹´ë“œ ë’¤ì§‘ê¸° (ìˆ¨ê²¨ì§„ ì¹´ë“œê°€ ì•„ë‹ ë•Œë§Œ)
              if (!isHidden) {
                this.flipCard(cardSprite, cardKey);
              }

              // ì ìˆ˜ ì—…ë°ì´íŠ¸
              this.updateScores();
            },
          });

          // ì¹´ë“œ ì •ë³´ ì €ì¥
          this.cardSprites[handType].push({
            sprite: cardSprite,
            card: card,
            isHidden: isHidden,
          });

          if (!isHidden) {
            this.handsData[handType].push(card.value);
          }
        }

        // ì¹´ë“œ ë’¤ì§‘ê¸° ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
        flipCard(cardSprite, cardKey) {
          // Xì¶• ìŠ¤ì¼€ì¼ì„ 0ìœ¼ë¡œ ì¤„ì´ë©´ì„œ ì¹´ë“œ ë’¤ì§‘ê¸° íš¨ê³¼
          this.tweens.add({
            targets: cardSprite,
            scaleX: 0,
            duration: 150,
            ease: "Power2",
            onComplete: () => {
              // ì¹´ë“œ í…ìŠ¤ì²˜ë¥¼ ì•ë©´ìœ¼ë¡œ ë³€ê²½
              cardSprite.setTexture(cardKey);
              // Xì¶• ìŠ¤ì¼€ì¼ ë³µì›
              this.tweens.add({
                targets: cardSprite,
                scaleX: this.cardScale,
                duration: 150,
                ease: "Power2",
              });
            },
          });
        }

        // ìˆ¨ê²¨ì§„ ì¹´ë“œ ê³µê°œ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        revealHiddenCard(handType, card) {
          const hiddenCardInfo = this.cardSprites[handType].find(
            (cardInfo) => cardInfo.isHidden
          );
          if (hiddenCardInfo && card) {
            const cardKey = `${card.value}${card.suit}`;

            // ì¹´ë“œ ë’¤ì§‘ê¸° ì• ë‹ˆë©”ì´ì…˜ ì ìš©
            this.flipCard(hiddenCardInfo.sprite, cardKey);

            hiddenCardInfo.card = card;
            hiddenCardInfo.isHidden = false;
            this.handsData[handType].unshift(card.value); // ì²« ë²ˆì§¸ ì¹´ë“œë¡œ ì¶”ê°€

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì ìˆ˜ ì—…ë°ì´íŠ¸
            this.time.delayedCall(300, () => {
              this.updateScores();
            });
          }
        }

        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        updateScores() {
          const dealerScore = this.calculateHandValue(this.handsData.dealer);
          const playerScore = this.calculateHandValue(this.handsData.player);

          this.dealerScoreText.setText(`${dealerScore}`);
          this.playerScoreText.setText(`${playerScore}`);

          // ë²„ìŠ¤íŠ¸ í‘œì‹œ
          if (dealerScore > 21) {
            this.dealerScoreText.setColor("#ff4444");
          } else {
            this.dealerScoreText.setColor("#ffd700");
          }

          if (playerScore > 21) {
            this.playerScoreText.setColor("#ff4444");
          } else {
            this.playerScoreText.setColor("#ffd700");
          }
        }

        // ì¹´ë“œ ê°’ ê³„ì‚° (ë¸”ë™ì­ ê·œì¹™)
        calculateHandValue(hand) {
          let value = 0;
          let aces = 0;

          for (let cardValue of hand) {
            if (cardValue === "A") {
              aces++;
              value += 11;
            } else if (["J", "Q", "K", "0"].includes(cardValue)) {
              value += 10;
            } else {
              value += parseInt(cardValue) || 0;
            }
          }

          // ì—ì´ìŠ¤ ì²˜ë¦¬ (21ì„ ë„˜ì§€ ì•Šë„ë¡)
          while (value > 21 && aces > 0) {
            value -= 10;
            aces--;
          }

          return value;
        }

        // ê²Œì„ ê²°ê³¼ í‘œì‹œ
        showGameResult(message, color = "#FFD700") {
          this.gameResultText.setText(message).setColor(color).setVisible(true);

          // 3ì´ˆ í›„ ê²°ê³¼ ìˆ¨ê¹€
          this.time.delayedCall(3000, () => {
            this.gameResultText.setVisible(false);
          });
        }

        // ëª¨ë“  ì¹´ë“œì™€ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        clearAllCardsAndText() {
          console.log("ëª¨ë“  ì¹´ë“œì™€ í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹œì‘");

          this.clearCards("player");
          this.clearCards("dealer");

          // ìŠ¤í”Œë¦¿ ê´€ë ¨ ì™„ì „ ì´ˆê¸°í™”
          if (this.isSplit) {
            console.log("ìŠ¤í”Œë¦¿ ìƒíƒœ ì´ˆê¸°í™”");

            if (this.splitHandSprites) {
              this.splitHandSprites.forEach((handSprites, handIndex) => {
                if (handSprites) {
                  handSprites.forEach((cardInfo) => {
                    if (cardInfo && cardInfo.sprite) {
                      cardInfo.sprite.destroy();
                    }
                  });
                }
              });
            }

            if (this.splitHandScoreTexts) {
              this.splitHandScoreTexts.forEach((scoreText) => {
                if (scoreText) {
                  scoreText.destroy();
                }
              });
            }
          }

          // ìŠ¤í”Œë¦¿ ê´€ë ¨ ë³€ìˆ˜ë“¤ ì™„ì „ ì´ˆê¸°í™”
          this.isSplit = false;
          this.splitHands = [];
          this.splitHandSprites = [];
          this.splitHandScoreTexts = [];
          this.currentHandIndex = 0;

          // ì ìˆ˜ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
          if (this.dealerScoreText) {
            this.dealerScoreText.setText("0").setColor("#ffd700");
          }
          if (this.playerScoreText) {
            this.playerScoreText.setText("0").setColor("#ffd700");
          }
          if (this.gameResultText) {
            this.gameResultText.setVisible(false);
          }

          console.log("ëª¨ë“  ì¹´ë“œì™€ í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ");
        }

        // íŠ¹ì • í•¸ë“œì˜ ì¹´ë“œ ì œê±°
        clearCards(handType) {
          this.cardSprites[handType].forEach((cardInfo) => {
            if (cardInfo.sprite) {
              cardInfo.sprite.destroy();
            }
          });
          this.cardSprites[handType] = [];
          this.handsData[handType] = [];
        }

        // ìŠ¤í”Œë¦¿ ì²˜ë¦¬
        handleSplit(session) {
          if (!session.isSplit || !session.splitHands) return;

          console.log("ìŠ¤í”Œë¦¿ ì²˜ë¦¬ ì‹œì‘:", session.splitHands);

          // í˜„ì¬ ì¹´ë“œë“¤ ì œê±°
          this.clearCards("player");

          // ìŠ¤í”Œë¦¿ í•¸ë“œë“¤ì„ ìœ„í•œ ìƒˆë¡œìš´ ë³€ìˆ˜ë“¤ ì´ˆê¸°í™”
          this.isSplit = true;
          this.splitHands = JSON.parse(JSON.stringify(session.splitHands)); // ê¹Šì€ ë³µì‚¬
          this.currentHandIndex = session.currentHandIndex || 0;
          this.splitHandSprites = [[], []]; // ê° í•¸ë“œì˜ ì¹´ë“œ ìŠ¤í”„ë¼ì´íŠ¸ë“¤
          this.splitHandScoreTexts = [];

          console.log("ìŠ¤í”Œë¦¿ í•¸ë“œ ë°ì´í„° ì„¤ì •:", this.splitHands);

          const width = this.cameras.main.width;
          const height = this.cameras.main.height;
          const centerX = width / 2;

          // ì™¼ìª½ í•¸ë“œ (ì¸ë±ìŠ¤ 0)
          const leftHandX = centerX - 120;
          const rightHandX = centerX + 120;
          const playerY = height * 0.75;

          // ê° í•¸ë“œì˜ ì ìˆ˜ í…ìŠ¤íŠ¸ ìƒì„±
          this.splitHandScoreTexts[0] = this.add
            .text(leftHandX, playerY + 80, "0", {
              fontSize: `${this.scoreFontSize}px`,
              color: "#ffd700",
              fontFamily: "Arial",
              fontStyle: "bold",
            })
            .setOrigin(0.5);

          this.splitHandScoreTexts[1] = this.add
            .text(rightHandX, playerY + 80, "0", {
              fontSize: `${this.scoreFontSize}px`,
              color: "#ffd700",
              fontFamily: "Arial",
              fontStyle: "bold",
            })
            .setOrigin(0.5);

          // í•¸ë“œ ë¼ë²¨ ìƒì„±
          this.add
            .text(leftHandX, playerY - 70, "í•¸ë“œ 1", {
              fontSize: `${this.baseFontSize}px`,
              color: "#ffffff",
              fontFamily: "Arial",
            })
            .setOrigin(0.5);

          this.add
            .text(rightHandX, playerY - 70, "í•¸ë“œ 2", {
              fontSize: `${this.baseFontSize}px`,
              color: "#ffffff",
              fontFamily: "Arial",
            })
            .setOrigin(0.5);

          // ê° í•¸ë“œì˜ ì¹´ë“œë“¤ ë Œë”ë§
          session.splitHands.forEach((hand, handIndex) => {
            const handX = handIndex === 0 ? leftHandX : rightHandX;

            hand.forEach((card, cardIndex) => {
              if (card && card.value && card.suit) {
                setTimeout(() => {
                  this.addSplitCard(handIndex, card, handX, playerY, cardIndex);
                }, cardIndex * 200 + handIndex * 100);
              }
            });
          });

          // í˜„ì¬ í™œì„± í•¸ë“œ ê°•ì¡°
          this.highlightCurrentHand(this.currentHandIndex);
        }

        // ìŠ¤í”Œë¦¿ ì¹´ë“œ ì¶”ê°€
        addSplitCard(handIndex, card, baseX, baseY, cardIndex) {
          const cardKey = `${card.value === "0" ? "10" : card.value}${
            card.suit
          }`;

          if (!this.textures.exists(cardKey)) {
            console.error(`ì¹´ë“œ í…ìŠ¤ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤: ${cardKey}`);
            return;
          }

          const cardX = baseX + (cardIndex - 1) * (this.cardSpacing * 0.8);
          const cardY = baseY;

          const cardSprite = this.add.image(cardX, cardY - 100, cardKey);
          cardSprite.setScale(this.cardScale * 0.9); // ìŠ¤í”Œë¦¿ ì¹´ë“œëŠ” ì•½ê°„ ì‘ê²Œ

          // ì¹´ë“œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
          this.tweens.add({
            targets: cardSprite,
            y: cardY,
            duration: 300,
            ease: "Power2",
          });

          // ìŠ¤í”„ë¼ì´íŠ¸ ì €ì¥
          if (!this.splitHandSprites[handIndex]) {
            this.splitHandSprites[handIndex] = [];
          }
          this.splitHandSprites[handIndex].push({
            sprite: cardSprite,
            card: card,
          });

          // ìŠ¤í”Œë¦¿ í•¸ë“œ ë°ì´í„°ëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
          // (syncSplitHandsWithSessionì—ì„œ ì„œë²„ ë°ì´í„°ë¡œ ë™ê¸°í™”ë¨)

          // ì ìˆ˜ ì—…ë°ì´íŠ¸
          this.updateSplitHandScore(handIndex);
        }

        // ìŠ¤í”Œë¦¿ í•¸ë“œ ë°ì´í„° ë™ê¸°í™” (ì„œë²„ ì„¸ì…˜ê³¼ ë™ê¸°í™”)
        syncSplitHandsWithSession(session) {
          if (!session.isSplit || !session.splitHands) return;

          console.log("ìŠ¤í”Œë¦¿ í•¸ë“œ ë™ê¸°í™”:", session.splitHands);

          // ì„œë²„ ë°ì´í„°ë¡œ ìŠ¤í”Œë¦¿ í•¸ë“œ ì—…ë°ì´íŠ¸
          this.splitHands = [...session.splitHands];
          this.currentHandIndex = session.currentHandIndex || 0;

          // ê° í•¸ë“œì˜ ì ìˆ˜ ì—…ë°ì´íŠ¸
          this.splitHands.forEach((hand, handIndex) => {
            if (hand && this.splitHandScoreTexts[handIndex]) {
              this.updateSplitHandScore(handIndex);
            }
          });

          // í˜„ì¬ í•¸ë“œ ê°•ì¡°
          this.highlightCurrentHand(this.currentHandIndex);
        }

        // ìŠ¤í”Œë¦¿ í•¸ë“œ ì ìˆ˜ ì—…ë°ì´íŠ¸
        updateSplitHandScore(handIndex) {
          if (
            !this.splitHands ||
            !this.splitHands[handIndex] ||
            !this.splitHandScoreTexts[handIndex]
          ) {
            console.log(
              `ìŠ¤í”Œë¦¿ í•¸ë“œ ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - handIndex: ${handIndex}, splitHands:`,
              this.splitHands,
              "scoreTexts:",
              this.splitHandScoreTexts
            );
            return;
          }

          const hand = this.splitHands[handIndex];
          console.log(`í•¸ë“œ ${handIndex} ì ìˆ˜ ê³„ì‚°:`, hand);

          // ì¹´ë“œ ê°’ë“¤ ì¶”ì¶œ (ìœ íš¨í•œ ì¹´ë“œë§Œ)
          const handValues = hand
            .filter((card) => card && card.value && card.value !== "hidden")
            .map((card) => card.value);

          console.log(`í•¸ë“œ ${handIndex} ì¹´ë“œ ê°’ë“¤:`, handValues);

          const score = this.calculateHandValue(handValues);
          console.log(`í•¸ë“œ ${handIndex} ìµœì¢… ì ìˆ˜:`, score);

          this.splitHandScoreTexts[handIndex].setText(`${score}`);

          // ë²„ìŠ¤íŠ¸ í‘œì‹œ
          if (score > 21) {
            this.splitHandScoreTexts[handIndex].setColor("#ff4444");
          } else if (score === 21) {
            this.splitHandScoreTexts[handIndex].setColor("#00ff00");
          } else {
            this.splitHandScoreTexts[handIndex].setColor("#ffd700");
          }
        }

        // í˜„ì¬ í•¸ë“œ ê°•ì¡°
        highlightCurrentHand(handIndex) {
          this.currentHandIndex = handIndex;

          // ëª¨ë“  í•¸ë“œ ë¶ˆíˆ¬ëª…í•˜ê²Œ
          if (this.splitHandSprites) {
            this.splitHandSprites.forEach((handSprites, index) => {
              handSprites.forEach((cardInfo) => {
                if (cardInfo.sprite) {
                  cardInfo.sprite.setAlpha(index === handIndex ? 1.0 : 0.6);
                }
              });
            });

            // ì ìˆ˜ í…ìŠ¤íŠ¸ë„ ê°•ì¡°
            this.splitHandScoreTexts.forEach((scoreText, index) => {
              if (scoreText) {
                scoreText.setAlpha(index === handIndex ? 1.0 : 0.6);
                if (index === handIndex) {
                  scoreText.setColor("#ffff00"); // í˜„ì¬ í•¸ë“œëŠ” ë” ë°ì€ ë…¸ë€ìƒ‰
                }
              }
            });
          }
        }

        // ì¹´ë“œ ì¬ë°°ì¹˜ (í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ)
        repositionCards() {
          const width = this.cameras.main.width;
          const height = this.cameras.main.height;
          const centerX = width / 2;

          if (this.isSplit && this.splitHandSprites) {
            // ìŠ¤í”Œë¦¿ ì¹´ë“œ ì¬ë°°ì¹˜
            const leftHandX = centerX - 120;
            const rightHandX = centerX + 120;
            const playerY = height * 0.75;

            this.splitHandSprites.forEach((handSprites, handIndex) => {
              const baseX = handIndex === 0 ? leftHandX : rightHandX;

              handSprites.forEach((cardInfo, cardIndex) => {
                if (cardInfo && cardInfo.sprite) {
                  const cardX =
                    baseX + (cardIndex - 1) * (this.cardSpacing * 0.8);
                  cardInfo.sprite.setScale(this.cardScale * 0.9);
                  cardInfo.sprite.setPosition(cardX, playerY);
                }
              });
            });

            // ì ìˆ˜ í…ìŠ¤íŠ¸ ì¬ë°°ì¹˜
            if (this.splitHandScoreTexts[0]) {
              this.splitHandScoreTexts[0].setPosition(leftHandX, playerY + 80);
            }
            if (this.splitHandScoreTexts[1]) {
              this.splitHandScoreTexts[1].setPosition(rightHandX, playerY + 80);
            }
          } else {
            // ì¼ë°˜ ì¹´ë“œ ì¬ë°°ì¹˜
            ["player", "dealer"].forEach((handType) => {
              this.cardSprites[handType].forEach((cardInfo, index) => {
                if (cardInfo && cardInfo.sprite) {
                  const startX = centerX - this.cardSpacing * 2;
                  const cardX = startX + index * this.cardSpacing;
                  const cardY =
                    handType === "dealer" ? height * 0.25 : height * 0.75;

                  cardInfo.sprite.setScale(this.cardScale);
                  cardInfo.sprite.setPosition(cardX, cardY);
                }
              });
            });
          }

          // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ë„ ì—…ë°ì´íŠ¸
          if (this.dealerScoreText) {
            this.dealerScoreText.setStyle({
              fontSize: `${this.scoreFontSize}px`,
            });
          }
          if (this.playerScoreText) {
            this.playerScoreText.setStyle({
              fontSize: `${this.scoreFontSize}px`,
            });
          }
          if (this.gameResultText) {
            this.gameResultText.setStyle({
              fontSize: `${this.resultFontSize}px`,
            });
          }
        }
      }

      // Phaser ê²Œì„ ì‹œì‘ í•¨ìˆ˜
      function startBlackjackGame() {
        const container = document.getElementById("blackjackGameContainer");
        if (!container) {
          console.error("blackjackGameContainer not found!");
          return;
        }

        const config = {
          type: Phaser.AUTO,
          parent: "blackjackGameContainer",
          width: container.clientWidth,
          height: container.clientHeight,
          transparent: true,
          scene: BlackjackScene,
          scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
          },
        };

        if (blackjackGame) {
          blackjackGame.destroy(true);
        }

        blackjackGame = new Phaser.Game(config);

        blackjackGame.events.on("ready", () => {
          if (blackjackGame && blackjackGame.scene) {
            blackjackScene = blackjackGame.scene.getScene("BlackjackScene");
            if (!blackjackScene) {
              console.error("BlackjackScene ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            } else {
            }
          }
        });
      }

      // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ê²Œì„ ë¦¬ì‚¬ì´ì¦ˆ
      window.addEventListener("resize", () => {
        if (blackjackGame && blackjackScene) {
          const container = document.getElementById("blackjackGameContainer");
          if (container && blackjackScene.sys.isActive()) {
            blackjackScene.setupResponsiveSettings();
            blackjackScene.repositionCards();
          }
        }
      });

      // ===== ê¸°ì¡´ ì¹´ë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤ì„ Phaserë¡œ ëŒ€ì²´ =====

      // ì´ˆê¸° ì¹´ë“œ ë Œë”ë§ (Phaser ë²„ì „)
      function renderInitialCards() {
        if (!gameSession || !blackjackScene || !blackjackScene.sys.isActive()) {
          return;
        }

        // ê¸°ì¡´ ì¹´ë“œ ì œê±°
        blackjackScene.clearAllCardsAndText();

        // í”Œë ˆì´ì–´ ì¹´ë“œ
        if (gameSession.playerHand && gameSession.playerHand.length > 0) {
          console.log("í”Œë ˆì´ì–´ ì¹´ë“œ ë Œë”ë§:", gameSession.playerHand);
          gameSession.playerHand.forEach((card, index) => {
            if (card && card.value && card.suit) {
              setTimeout(() => {
                console.log(`í”Œë ˆì´ì–´ ì¹´ë“œ ${index} ì¶”ê°€:`, card);
                blackjackScene.addCard("player", card);
              }, index * 300);
            } else {
              console.error(`ìœ íš¨í•˜ì§€ ì•Šì€ í”Œë ˆì´ì–´ ì¹´ë“œ ${index}:`, card);
              console.error(
                "ì „ì²´ í”Œë ˆì´ì–´ í•¸ë“œ:",
                JSON.stringify(gameSession.playerHand)
              );
            }
          });
        } else {
          console.log("í”Œë ˆì´ì–´ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤:", gameSession.playerHand);
        }

        // ë”œëŸ¬ ì¹´ë“œ (ì²« ë²ˆì§¸ëŠ” ìˆ¨ê¹€)
        if (gameSession.dealerHand && gameSession.dealerHand.length > 0) {
          gameSession.dealerHand.forEach((card, index) => {
            // hidden ì¹´ë“œ ì²˜ë¦¬
            if (
              card &&
              (card.value === "hidden" || (card.value && card.suit))
            ) {
              setTimeout(() => {
                if (index === 0 && card.value !== "hidden") {
                  // ì²« ë²ˆì§¸ ì¹´ë“œëŠ” ìˆ¨ê¹€ (hiddenì´ ì•„ë‹Œ ê²½ìš°)
                  blackjackScene.addCard("dealer", card, true);
                } else if (card.value !== "hidden") {
                  // ì¼ë°˜ ì¹´ë“œ
                  blackjackScene.addCard("dealer", card);
                } else {
                  // hidden ì¹´ë“œëŠ” ë’·ë©´ìœ¼ë¡œ í‘œì‹œ
                  blackjackScene.addCard(
                    "dealer",
                    { value: "A", suit: "S" },
                    true
                  ); // ì„ì‹œ ì¹´ë“œë¡œ ë’·ë©´ í‘œì‹œ
                }
              }, (gameSession.playerHand.length + index) * 300);
            } else {
              console.error(`ìœ íš¨í•˜ì§€ ì•Šì€ ë”œëŸ¬ ì¹´ë“œ ${index}:`, card);
            }
          });
        }
      }

      // ì¹´ë“œ ì¶”ê°€ (Phaser ë²„ì „)
      function addCardToHand(handType, card) {
        console.log("addCardToHand í˜¸ì¶œë¨:", handType, card);

        if (!card) {
          console.error("ì¹´ë“œê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:", handType, card);
          console.error("í˜„ì¬ gameSession:", gameSession);
          return;
        }

        if (!blackjackScene || !blackjackScene.sys.isActive()) {
          console.error("Phaser Sceneì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:", handType, card);
          return;
        }

        if (!card.value || !card.suit) {
          console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ë°ì´í„°:", handType, card);
          console.error("ì¹´ë“œ ê°ì²´ ì „ì²´:", JSON.stringify(card));
          return;
        }

        try {
          blackjackScene.addCard(handType, card);
          console.log("ì¹´ë“œ ì¶”ê°€ ì„±ê³µ:", handType, card.value, card.suit);
        } catch (error) {
          console.error("ì¹´ë“œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:", error);
        }
      }

      // ë”œëŸ¬ ìˆ¨ê²¨ì§„ ì¹´ë“œ ê³µê°œ (Phaser ë²„ì „)
      function revealDealerHiddenCard(card) {
        if (!card || !blackjackScene) {
          console.error(
            "ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ê°ì²´ì´ê±°ë‚˜ Phaser Sceneì´ ì—†ìŠµë‹ˆë‹¤:",
            card
          );
          return;
        }

        blackjackScene.revealHiddenCard("dealer", card);
      }

      // ê²Œì„ í…Œì´ë¸” ì´ˆê¸°í™” (Phaser ë²„ì „)
      function clearGameTable() {
        if (blackjackScene) {
          blackjackScene.clearAllCardsAndText();
        }
      }

      // ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (Phaserì—ì„œ ìë™ ì²˜ë¦¬ë˜ë¯€ë¡œ ë¹ˆ í•¨ìˆ˜ë¡œ ìœ ì§€)
      function updatePlayerScore(score) {
        // Phaser Sceneì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
      }

      function updateDealerScore(score) {
        // Phaser Sceneì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
      }
    </script>
  </body>
</html>
